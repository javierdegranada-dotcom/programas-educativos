<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Química Orgánica Master</title>

    <!-- Tailwind CDN (con safelist para clases dinámicas) -->
    <script>
      // IMPORTANTE: con el CDN de Tailwind, las clases creadas dinámicamente en JS no se “detectan”.
      // Este safelist asegura que existan bg/text/border de los dos temas usados (blue/emerald).
      tailwind = window.tailwind || {};
      tailwind.config = {
        safelist: [
          // Header
          'bg-blue-600','bg-emerald-600',
          // Cards grid
          'bg-blue-50','bg-emerald-50',
          'border-blue-100','border-emerald-100',
          'active:bg-blue-100','active:bg-emerald-100',
          'text-blue-500','text-emerald-500',
          'text-blue-900','text-emerald-900'
        ]
      };
    </script>
    <script src="https://cdn.tailwindcss.com"></script>

    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap');

        html, body {
            font-family: 'Nunito', sans-serif;
            background-color: #F3F4F6;
            height: 100%;
            overflow: hidden;
            touch-action: manipulation;
        }

        .chemical-font { font-family: 'Courier New', Courier, monospace; font-weight: 700; }

        .app-container {
            width: 100%;
            height: 100dvh;
            background-color: white;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        @media (min-width: 640px) {
            body { display: flex; align-items: center; justify-content: center; padding: 1rem; }
            .app-container { height: 90vh; max-width: 30rem; border-radius: 1.5rem; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); }
        }

        /* --- ANIMACIONES (faltaban en la versión original) --- */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(18px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in { animation: fadeIn 0.35s ease-in; }
        .animate-slide-up { animation: slideUp 0.35s ease-out; }

        /* --- VISUALIZACIÓN SEGURA --- */
        #question-scroll-area {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            overflow-x: auto;
            padding: 1.5rem 0.5rem;
            background-color: #F9FAFB;
            border-bottom: 1px solid #E5E7EB;
            -webkit-overflow-scrolling: touch;
            min-height: 160px;
        }

        .molecule-wrapper {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background-color: white;
            padding: 1.25rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
            border: 1px solid #E5E7EB;
            white-space: nowrap;
        }

        .text-question { font-size: 1.5rem; font-weight: 800; color: #1F2937; white-space: normal; text-align: center; }

        /* --- BOTONES CON SCROLL ROBUSTO --- */
        .btn-div-wrapper {
            cursor: pointer;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        .btn-inner-layout {
            display: flex;
            align-items: center;
            width: 100%;
            overflow: hidden;
            position: relative;
        }

        .btn-scroll-text {
            display: flex;
            align-items: center;
            flex: 1;
            min-width: 0;
            overflow-x: auto;
            white-space: nowrap;
            text-align: left;
            padding-bottom: 6px;
            padding-top: 4px;
            margin-left: 0.5rem;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: thin;
            pointer-events: auto;
            touch-action: pan-x;
        }

        .btn-scroll-text::-webkit-scrollbar { height: 4px; }
        .btn-scroll-text::-webkit-scrollbar-thumb { background: #94A3B8; border-radius: 4px; }
        .btn-scroll-text::-webkit-scrollbar-track { background: #F1F5F9; }

        /* --- MOLECULAR STYLES --- */
        .molecule-container { display: inline-flex; align-items: center; flex-shrink: 0; padding-right: 10px; }
        .carbon-group { display: flex; flex-direction: column; align-items: center; justify-content: center; min-width: 32px; }
        .main-atom { padding: 2px 0; z-index: 10; font-size: 1.2rem; color: #1F2937; letter-spacing: -1px; }

        .atom-O { color: #DC2626; }
        .atom-N { color: #2563EB; }
        .atom-Cl { color: #16A34A; }
        .atom-Br { color: #991B1B; }
        .atom-I { color: #7F1D1D; }
        .atom-F { color: #059669; }
        .atom-Na { color: #7C3AED; }
        .atom-K { color: #7C3AED; }
        .atom-condensed { font-size: 1rem; color: #4B5563; border: 1px dashed #D1D5DB; padding: 0 4px; border-radius: 4px; }

        .branch-atom { font-size: 0.85rem; color: #4B5563; font-weight: bold; }
        .branch-atom-O { color: #DC2626; }
        .branch-atom-N { color: #2563EB; }
        .branch-atom-X { color: #059669; }
        .branch-atom-hard { font-size: 0.85rem; color: #374151; font-weight: bold; }

        .bond-spacer { width: 24px; display: flex; flex-direction: column; align-items: center; justify-content: center; margin: 0; flex-shrink: 0; height: 24px; }

        .h-bond { width: 100%; height: 2px; background-color: #374151; }
        .h-bond-double { width: 100%; height: 6px; border-top: 2px solid #374151; border-bottom: 2px solid #374151; }
        .h-bond-triple { width: 100%; height: 8px; border-top: 2px solid #374151; border-bottom: 2px solid #374151; position: relative; }
        .h-bond-triple::after { content: ''; position: absolute; top: 50%; left: 0; width: 100%; height: 2px; background-color: #374151; transform: translateY(-50%); }

        .v-bond-up { width: 2px; height: 14px; background-color: #374151; margin-bottom: -2px; }
        .v-bond-down { width: 2px; height: 14px; background-color: #374151; margin-top: -2px; }
        .v-bond-double-up { width: 6px; height: 16px; margin-bottom: -2px; border-left: 2px solid #374151; border-right: 2px solid #374151; }
        .v-bond-double-down { width: 6px; height: 16px; margin-top: -2px; border-left: 2px solid #374151; border-right: 2px solid #374151; }

        sub { font-size: 0.7em; vertical-align: sub; }
        .q-selector input:checked + div { background-color: #2563EB; color: white; border-color: #2563EB; }
        .touch-btn { min-height: 44px; display: flex; align-items: center; justify-content: center; }
    </style>
</head>
<body>

    <!-- HUB -->
    <div id="hub-screen" class="app-container fade-in">
        <div class="bg-gray-900 p-8 text-center text-white shrink-0 rounded-b-3xl shadow-lg relative overflow-hidden h-1/3 flex flex-col justify-center items-center">
            <i class="fas fa-atom text-6xl mb-4 text-blue-400 animate-pulse"></i>
            <h1 class="text-3xl font-bold">Química Master</h1>
            <div class="mt-4 text-xs bg-gray-800 bg-opacity-50 p-2 rounded-lg">
                <p>Javier Gijón</p>
                <p class="text-gray-400">IES María Moliner (Segovia)</p>
            </div>
        </div>

        <div class="flex-grow p-6 flex flex-col justify-center gap-6">
            <button onclick="selectApp('hydro')" class="group relative w-full bg-blue-600 hover:bg-blue-700 text-white rounded-2xl p-6 shadow-xl transition-all transform hover:scale-105 text-left overflow-hidden">
                <div class="absolute right-[-20px] bottom-[-20px] text-blue-800 opacity-20 transform rotate-12"><i class="fas fa-link text-9xl"></i></div>
                <h2 class="text-2xl font-bold mb-1">Hidrocarburos</h2>
                <p class="text-blue-100 text-sm">Alcanos, Alquenos, Alquinos</p>
            </button>

            <button onclick="selectApp('func')" class="group relative w-full bg-emerald-600 hover:bg-emerald-700 text-white rounded-2xl p-6 shadow-xl transition-all transform hover:scale-105 text-left overflow-hidden">
                <div class="absolute right-[-20px] bottom-[-20px] text-emerald-800 opacity-20 transform rotate-12"><i class="fas fa-flask text-9xl"></i></div>
                <h2 class="text-2xl font-bold mb-1">Grupos Funcionales</h2>
                <p class="text-emerald-100 text-sm">Alcoholes, Ácidos, Nitrilos...</p>
            </button>
        </div>
    </div>

    <!-- SELECCIÓN NIVEL -->
    <div id="level-screen" class="app-container hidden">
        <div id="header-bg" class="bg-blue-600 p-6 text-center text-white shrink-0 rounded-b-3xl shadow-lg z-10 relative">
            <button onclick="goHub()" class="absolute left-4 top-6 text-white opacity-80"><i class="fas fa-arrow-left"></i></button>
            <h1 id="app-title" class="text-2xl font-bold mt-2">Título</h1>
        </div>

        <div class="flex-grow overflow-y-auto p-4 space-y-5">
            <div class="bg-white p-3 rounded-xl border border-gray-100 shadow-sm">
                <p class="text-xs font-bold text-gray-400 mb-2 text-center uppercase">Preguntas</p>
                <div class="flex justify-center gap-3">
                    <label class="cursor-pointer q-selector"><input type="radio" name="q-count" value="5" class="hidden"><div class="w-10 h-10 rounded-full border-2 border-gray-200 flex items-center justify-center font-bold text-gray-400 text-sm transition-all">5</div></label>
                    <label class="cursor-pointer q-selector"><input type="radio" name="q-count" value="10" class="hidden" checked><div class="w-10 h-10 rounded-full border-2 border-gray-200 flex items-center justify-center font-bold text-gray-400 text-sm transition-all">10</div></label>
                    <label class="cursor-pointer q-selector"><input type="radio" name="q-count" value="20" class="hidden"><div class="w-10 h-10 rounded-full border-2 border-gray-200 flex items-center justify-center font-bold text-gray-400 text-sm transition-all">20</div></label>
                </div>
            </div>
            <div id="levels-grid" class="grid grid-cols-2 gap-3"></div>
            <div id="mix-buttons" class="space-y-3"></div>
        </div>

        <div class="p-4 bg-gray-50 border-t border-gray-200 shrink-0 text-center">
            <button onclick="toggleModal('theory-modal')" class="text-gray-500 text-sm font-bold py-1 block w-full hover:text-blue-600"><i class="fas fa-info-circle mr-1"></i> Ver Chuleta</button>
        </div>
    </div>

    <!-- JUEGO -->
    <div id="game-screen" class="app-container hidden">
        <div class="bg-gray-800 text-white p-3 flex justify-between items-center shrink-0 shadow-md z-10">
            <button onclick="goLevelSelect()" class="text-gray-300 active:text-white p-2"><i class="fas fa-chevron-left text-lg"></i></button>
            <div class="font-bold text-sm" id="level-indicator">Nivel</div>
            <div class="bg-gray-700 px-3 py-1 rounded-full text-xs font-mono"><span id="current-q">1</span>/<span id="total-q">10</span></div>
        </div>
        <div class="w-full bg-gray-200 h-1 shrink-0"><div id="progress-bar" class="bg-blue-500 h-1 transition-all duration-300" style="width: 0%"></div></div>

        <div class="flex-grow flex flex-col overflow-y-auto bg-white">
            <div class="bg-gray-50 pb-4 border-b border-gray-200 sticky top-0 z-0">
                <div class="text-center pt-3 pb-2"><span id="question-type-badge" class="px-3 py-1 text-[10px] font-black uppercase tracking-wider bg-blue-100 text-blue-800 rounded-full">Nombrar</span></div>
                <div id="question-scroll-area">
                    <div id="question-display" class="molecule-wrapper"></div>
                </div>
            </div>

            <div class="p-4 flex flex-col justify-center flex-grow">
                <div id="input-text-area" class="w-full hidden space-y-4">
                    <input type="text" id="user-input" placeholder="Nombre IUPAC..." class="w-full p-4 text-center text-base border-2 border-gray-300 rounded-xl focus:border-blue-500 focus:outline-none transition-all" autocomplete="off" spellcheck="false">
                    <div id="keyboard-area" class="grid grid-cols-4 gap-2 text-xs font-bold"></div>
                </div>
                <div id="input-options-area" class="w-full hidden space-y-3"></div>
                <div id="feedback-area" class="mt-4 text-center hidden p-4 bg-gray-50 rounded-xl border border-gray-100">
                    <div id="feedback-icon" class="text-4xl mb-2"></div>
                    <p id="feedback-text" class="font-bold text-xl mb-1"></p>
                    <p id="feedback-correction" class="text-gray-600 text-sm"></p>
                </div>
            </div>
        </div>

        <div class="p-4 border-t border-gray-200 bg-white shrink-0 z-20">
            <button id="check-btn" onclick="checkAnswer()" class="w-full bg-blue-600 active:bg-blue-700 text-white font-bold py-4 rounded-xl shadow-lg">Comprobar</button>
            <button id="next-btn" onclick="nextQuestion()" class="hidden w-full bg-green-500 active:bg-green-600 text-white font-bold py-4 rounded-xl shadow-lg">Siguiente <i class="fas fa-arrow-right ml-2"></i></button>
        </div>
    </div>

    <!-- RESULTADOS -->
    <div id="end-screen" class="app-container hidden flex flex-col h-full">
        <div class="bg-gray-800 p-6 text-center text-white shrink-0">
            <h2 class="text-2xl font-bold">Resultados</h2>
            <div class="mt-4 inline-block bg-gray-700 rounded-xl px-6 py-2">
                <span class="text-gray-400 text-sm uppercase mr-2">Puntuación</span>
                <span id="final-score" class="text-2xl font-bold text-white">0/0</span>
            </div>
            <div id="level-feedback" class="mt-3 text-yellow-400 font-bold text-lg animate-pulse uppercase tracking-wide"></div>
        </div>
        <div class="flex-grow overflow-y-auto p-0 min-h-0">
            <table class="w-full text-sm">
                <thead class="bg-gray-100 text-gray-600 sticky top-0 shadow-sm z-10">
                    <tr>
                        <th class="p-3 text-left">Pregunta</th>
                        <th class="p-3 text-center">Tú</th>
                        <th class="p-3 text-center">Solución</th>
                        <th class="p-3 text-center">Ok</th>
                    </tr>
                </thead>
                <tbody id="results-table-body" class="divide-y divide-gray-100"></tbody>
            </table>
        </div>
        <div class="p-4 border-t border-gray-200 bg-white shrink-0">
            <button onclick="goLevelSelect()" class="w-full bg-gray-800 text-white font-bold py-4 rounded-xl shadow-lg">Volver</button>
        </div>
    </div>

    <!-- CHULETA -->
    <div id="theory-modal" class="fixed inset-0 bg-black bg-opacity-80 hidden z-50 flex items-end sm:items-center justify-center sm:p-4">
        <div class="bg-white w-full h-[85vh] sm:h-auto sm:max-w-xl sm:rounded-2xl rounded-t-2xl flex flex-col overflow-hidden shadow-2xl animate-slide-up">
            <div id="theory-header" class="bg-blue-600 p-4 text-white flex justify-between items-center shrink-0">
                <h3 class="font-bold text-lg" id="theory-title">Chuleta</h3>
                <button onclick="toggleModal('theory-modal')" class="p-2 bg-white bg-opacity-20 rounded-full"><i class="fas fa-times"></i></button>
            </div>
            <div id="theory-content" class="p-6 overflow-y-auto flex-grow space-y-4 text-sm text-gray-700"></div>
        </div>
    </div>

    <script>
        // --- UTILIDADES ---
        function escapeHtml(str) {
            return String(str)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }

        function normName(s) {
            return (s || '')
                .toLowerCase()
                .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
                .replace(/[–—]/g, '-')
                .replace(/[\s\-_,]/g, '');
        }

        // --- 1. CONFIGURACIÓN APP ---
        const apps = {
            hydro: {
                title: "Hidrocarburos", color: "blue",
                levels: [
                    { id: 'linear', name: 'Lineales', icon: 'fa-link' },
                    { id: 'branched', name: 'Ramificados', icon: 'fa-code-branch' },
                    { id: 'alkenes', name: 'Alquenos (=)', icon: 'fa-equals' },
                    { id: 'alkynes', name: 'Alquinos (≡)', icon: 'fa-bars' }
                ],
                keyboard: ['-', ',', 'eno', 'ino', 'di', 'tri'],
                cheatsheet: `<div><h4 class="font-bold border-b-2 mb-2">Prefijos</h4><div class="grid grid-cols-2 gap-2 text-xs"><div>1:Met</div><div>2:Et</div><div>3:Prop</div><div>4:But</div><div>5:Pent</div><div>6:Hex</div><div>7:Hept</div><div>8:Oct</div></div></div><div><h4 class="font-bold border-b-2 mb-2">Sufijos</h4><div class="space-y-1 text-xs"><div>-ano (Simple)</div><div>-eno (Doble)</div><div>-ino (Triple)</div></div></div>`
            },
            func: {
                title: "Grupos Funcionales", color: "emerald",
                levels: [
                    { id: 'oxy1', name: 'Alcohol/Éter', icon: 'fa-wine-bottle' },
                    { id: 'oxy2', name: 'Ald/Cetona', icon: 'fa-bacon' },
                    { id: 'acids', name: 'Ácidos/Éster', icon: 'fa-lemon' },
                    { id: 'nitrogen', name: 'Nitrogenados', icon: 'fa-fish' },
                    { id: 'halonitro', name: 'Halógenos/Nitro', icon: 'fa-bomb' }
                ],
                keyboard: ['N', '-', ',', 'ol', 'al', 'ona', 'oico', 'il', 'oxi', 'nitrilo', 'amida', 'amina', 'nitro', 'cloro'],
                cheatsheet: `<p class="text-xs text-gray-500 mb-2 italic">Prioridad (1 mayor):</p><table class="w-full text-left text-xs text-gray-700"><thead class="bg-gray-100 font-bold"><tr><th class="p-2">Grupo</th><th class="p-2">Sufijo</th><th class="p-2">Prefijo</th></tr></thead><tbody class="divide-y"><tr><td class="p-2 text-red-600 font-bold">Ácido</td><td>-oico</td><td>carboxi-</td></tr><tr><td class="p-2 text-red-500 font-bold">Éster</td><td>-oato</td><td>-</td></tr><tr><td class="p-2 text-purple-600 font-bold">Amida</td><td>-amida</td><td>carbamoil-</td></tr><tr class="bg-purple-50"><td class="p-2 text-purple-800 font-bold">Nitrilo</td><td>-nitrilo</td><td>ciano-</td></tr><tr><td class="p-2 text-orange-600 font-bold">Aldehído</td><td>-al</td><td>formil/oxo</td></tr><tr><td class="p-2 text-orange-500 font-bold">Cetona</td><td>-ona</td><td>oxo-</td></tr><tr><td class="p-2 text-blue-600 font-bold">Alcohol</td><td>-ol</td><td>hidroxi-</td></tr><tr><td class="p-2 text-purple-500 font-bold">Amina</td><td>-amina</td><td>amino-</td></tr><tr><td class="p-2 text-blue-400 font-bold">Éter</td><td>éter</td><td>alcoxi-</td></tr><tr class="bg-yellow-50"><td class="p-2 font-bold">Nitro/Halo</td><td>-</td><td>nitro-/cloro-</td></tr></tbody></table>`
            }
        };

        // --- 2. BASE DE DATOS ---
        const db = { linear: [], branched: [], alkenes: [], alkynes: [], oxy1: [], oxy2: [], acids: [], nitrogen: [], halonitro: [], hydroHard: [], funcHard: [], proMix: [], proHydro: [] };
        const prefixes = ['', 'Met', 'Et', 'Prop', 'But', 'Pent', 'Hex', 'Hept', 'Oct', 'Non', 'Dec', 'Undec', 'Dodec'];
        function getN(n) { return prefixes[n] ? prefixes[n].toLowerCase() : 'pol'; }
        function sub(t) { if(!t) return ''; return t.toString().replace(/(\d+)/g, '<sub>$1</sub>'); }
        function getFormula(n) { return n===1?'CH4':n===2?'CH3-CH3':`CH3-(CH2)${n-2}-CH3`; }
        function addUnique(category, item) { if(!db[category].some(x => x.name === item.name)) db[category].push(item); }

        function generateData() {
            // --- HIDROCARBUROS ---
            for(let i=1; i<=12; i++) addUnique('linear', {name:getN(i)+'ano', chain:[getFormula(i)], type:'simple'});

            const bSeeds=[
                {n:"2-metilpropano",c:["CH3","CH","CH3"],b:[{i:1,g:"CH3",p:"top"}]},
                {n:"2,2-dimetilpropano",c:["CH3","C","CH3"],b:[{i:1,g:"CH3",p:"top"},{i:1,g:"CH3",p:"bottom"}]},
                {n:"2-metilbutano",c:["CH3","CH","CH2","CH3"],b:[{i:1,g:"CH3",p:"top"}]},
                {n:"2,3-dimetilbutano",c:["CH3","CH","CH","CH3"],b:[{i:1,g:"CH3",p:"top"},{i:2,g:"CH3",p:"bottom"}]},
                {n:"2,2-dimetilbutano",c:["CH3","C","CH2","CH3"],b:[{i:1,g:"CH3",p:"top"},{i:1,g:"CH3",p:"bottom"}]},
                {n:"3-metilpentano",c:["CH3","CH2","CH","CH2","CH3"],b:[{i:2,g:"CH3",p:"top"}]},
                {n:"3-etilpentano",c:["CH3","CH2","CH","CH2","CH3"],b:[{i:2,g:"CH2CH3",p:"bottom"}]},
                {n:"2,4-dimetilpentano",c:["CH3","CH","CH2","CH","CH3"],b:[{i:1,g:"CH3",p:"top"},{i:3,g:"CH3",p:"bottom"}]},
                {n:"3-etil-2-metilpentano",c:["CH3","CH","CH","CH2","CH3"],b:[{i:1,g:"CH3",p:"top"},{i:2,g:"CH2CH3",p:"bottom"}]},
                {n:"3,3-dimetilhexano",c:["CH3","CH2","C","CH2","CH2","CH3"],b:[{i:2,g:"CH3",p:"top"},{i:2,g:"CH3",p:"bottom"}]},
                {n:"4-etil-2-metilhexano",c:["CH3","CH","CH2","CH","CH2","CH3"],b:[{i:1,g:"CH3",p:"top"},{i:3,g:"CH2CH3",p:"bottom"}]},
                {n:"2,2,4-trimetilpentano",c:["CH3","C","CH2","CH","CH3"],b:[{i:1,g:"CH3",p:"top"},{i:1,g:"CH3",p:"bottom"},{i:3,g:"CH3",p:"top"}]}
            ];
            bSeeds.forEach(s=>addUnique('branched',{name:s.n,chain:s.c,branches:s.b.map(x=>({idx:x.i,g:x.g,pos:x.p}))}));
            for(let i=0;i<30;i++){
                let mc=Math.floor(Math.random()*6)+5;
                let limit=Math.ceil(mc/2);
                let p=Math.floor(Math.random()*(limit-1))+2;
                let ch=["CH3"];for(let k=0;k<mc-2;k++)ch.push("CH2");ch.push("CH3");
                ch[p-1]="CH";
                addUnique('branched',{name:`${p}-metil${getN(mc)}ano`,chain:ch,branches:[{idx:p-1,g:"CH3",pos:Math.random()>0.5?"top":"bottom"}]});
            }

            const alkSeeds=[
                {n:"eteno",c:["CH2","CH2"],b:[{i:0,t:"="}]},
                {n:"propeno",c:["CH2","CH","CH3"],b:[{i:0,t:"="}]},
                {n:"but-1-eno",c:["CH2","CH","CH2","CH3"],b:[{i:0,t:"="}]},
                {n:"but-2-eno",c:["CH3","CH","CH","CH3"],b:[{i:1,t:"="}]},
                {n:"2-metilprop-1-eno",c:["CH2","C","CH3"],b:[{i:0,t:"="}],br:[{i:1,g:"CH3",p:"top"}]},
                {n:"3-metilbut-1-eno",c:["CH2","CH","CH","CH3"],b:[{i:0,t:"="}],br:[{i:2,g:"CH3",p:"top"}]},
                {n:"2-metilbut-2-eno",c:["CH3","C","CH","CH3"],b:[{i:1,t:"="}],br:[{i:1,g:"CH3",p:"top"}]},
                {n:"pent-2-eno",c:["CH3","CH","CH","CH2","CH3"],b:[{i:1,t:"="}]},
                {n:"3-metilpent-2-eno",c:["CH3","CH","C","CH2","CH3"],b:[{i:1,t:"="}],br:[{i:2,g:"CH3",p:"top"}]},
                {n:"hexa-1,4-dieno",c:["CH2","CH","CH2","CH","CH","CH3"],b:[{i:0,t:"="},{i:3,t:"="}]},
                {n:"penta-1,3-dieno",c:["CH2","CH","CH","CH","CH3"],b:[{i:0,t:"="},{i:2,t:"="}]}
            ];
            alkSeeds.forEach(s=>addUnique('alkenes',{name:s.n,chain:s.c,bonds:s.b.map(x=>({idx:x.i,type:x.t})),branches:s.br?s.br.map(x=>({idx:x.i,g:x.g,pos:x.p})):[]}));
            for(let i=0;i<15;i++){
                let len=Math.floor(Math.random()*5)+4;
                let maxPos=Math.ceil(len/2);
                // FIX: permitir también la posición "mitad" (p.ej. hex-3-eno)
                let dPos=Math.floor(Math.random()*maxPos)+1;
                let name=`${getN(len)}-${dPos}-eno`;
                if(dPos===1&&len<=3)name=getN(len)+"eno";
                let chain=Array(len).fill("CH2");
                chain[0]="CH3";chain[len-1]="CH3";
                if(dPos===1){chain[0]="CH2";chain[1]="CH";}
                else {chain[dPos-1]="CH";chain[dPos]="CH";}
                addUnique('alkenes',{name:name,chain:chain,bonds:[{idx:dPos-1,type:"="}]});
            }

            const yneSeeds=[
                {n:"etino",c:["CH","CH"],b:[{i:0,t:"3"}]},
                {n:"propino",c:["CH","C","CH3"],b:[{i:0,t:"3"}]},
                {n:"but-1-ino",c:["CH","C","CH2","CH3"],b:[{i:0,t:"3"}]},
                {n:"but-2-ino",c:["CH3","C","C","CH3"],b:[{i:1,t:"3"}]},
                {n:"pent-1-ino",c:["CH","C","CH2","CH2","CH3"],b:[{i:0,t:"3"}]},
                {n:"pent-2-ino",c:["CH3","C","C","CH2","CH3"],b:[{i:1,t:"3"}]},
                {n:"4-metilpent-2-ino",c:["CH3","C","C","CH","CH3"],b:[{i:1,t:"3"}],br:[{i:3,g:"CH3",p:"top"}]},
                {n:"hex-1-ino",c:["CH","C","CH2","CH2","CH2","CH3"],b:[{i:0,t:"3"}]},
                {n:"hex-3-ino",c:["CH3","CH2","C","C","CH2","CH3"],b:[{i:2,t:"3"}]},
                {n:"hexa-1,5-diino",c:["CH","C","CH2","CH2","C","CH"],b:[{i:0,t:"3"},{i:4,t:"3"}]}
            ];
            yneSeeds.forEach(s=>addUnique('alkynes',{name:s.n,chain:s.c,bonds:s.b.map(x=>({idx:x.i,type:x.t})),branches:s.br?s.br.map(x=>({idx:x.i,g:x.g,pos:x.p})):[]}));

            // --- FUNCIONALES ---
            const oxy1Seeds = [
                {n:"metanol",c:["CH3OH"]},{n:"etanol",c:["CH3","CH2OH"]},{n:"propan-1-ol",c:["CH3","CH2","CH2OH"]},{n:"propan-2-ol",c:["CH3","CH","CH3"],br:[{i:1,g:"OH",p:"bottom"}]},
                {n:"butan-1-ol",c:["CH3","CH2","CH2","CH2OH"]},{n:"butan-2-ol",c:["CH3","CH2","CH","CH3"],br:[{i:2,g:"OH",p:"bottom"}]},
                {n:"2-metilpropan-1-ol",c:["CH3","CH","CH2OH"],br:[{i:1,g:"CH3",p:"top"}]},{n:"2-metilpropan-2-ol",c:["CH3","C","CH3"],br:[{i:1,g:"CH3",p:"top"},{i:1,g:"OH",p:"bottom"}]},
                {n:"pentan-1-ol",c:["CH3","CH2","CH2","CH2","CH2OH"]},{n:"pentan-3-ol",c:["CH3","CH2","CH","CH2","CH3"],br:[{i:2,g:"OH",p:"bottom"}]},
                {n:"etano-1,2-diol",c:["CH2OH","CH2OH"]},{n:"propano-1,2-diol",c:["CH2OH","CH","CH3"],br:[{i:1,g:"OH",p:"bottom"}]},{n:"propano-1,2,3-triol",c:["CH2OH","CH","CH2OH"],br:[{i:1,g:"OH",p:"bottom"}]},
                {n:"metoximetano",c:["CH3","O","CH3"],t:'ether'},{n:"metoxietano",c:["CH3","O","CH2","CH3"],t:'ether'},{n:"etoxietano",c:["CH3","CH2","O","CH2","CH3"],t:'ether'},
                {n:"1-metoxipropano",c:["CH3","O","CH2","CH2","CH3"],t:'ether'},{n:"2-metoxipropano",c:["CH3","CH","CH3"],br:[{i:1,g:"OCH3",p:"top"}],t:'ether'},
                {n:"1-etoxibutano",c:["CH3","CH2","O","CH2","CH2","CH2","CH3"],t:'ether'}
            ];
            oxy1Seeds.forEach(s=>addUnique('oxy1',{name:s.n,chain:s.c,branches:s.br?s.br.map(x=>({idx:x.i,g:x.g,pos:x.p})):[],subtype:s.t||'alcohol'}));

            const oxy2Seeds = [
                {n:"metanal",c:["H","CH"],br:[{i:1,g:"=O",p:"top-double"}],t:'aldehyde'},{n:"etanal",c:["CH3","CH"],br:[{i:1,g:"=O",p:"top-double"}],t:'aldehyde'},
                {n:"propanal",c:["CH3","CH2","CH"],br:[{i:2,g:"=O",p:"top-double"}],t:'aldehyde'},{n:"butanal",c:["CH3","CH2","CH2","CH"],br:[{i:3,g:"=O",p:"top-double"}],t:'aldehyde'},
                {n:"2-metilpropanal",c:["CH3","CH","CH"],br:[{i:1,g:"CH3",p:"bottom"},{i:2,g:"=O",p:"top-double"}],t:'aldehyde'},{n:"pentanal",c:["CH3","CH2","CH2","CH2","CH"],br:[{i:4,g:"=O",p:"top-double"}],t:'aldehyde'},
                {n:"3-metilbutanal",c:["CH3","CH","CH2","CH"],br:[{i:1,g:"CH3",p:"bottom"},{i:3,g:"=O",p:"top-double"}],t:'aldehyde'},
                {n:"propanona",c:["CH3","C","CH3"],br:[{i:1,g:"=O",p:"top-double"}],t:'ketone'},{n:"butanona",c:["CH3","C","CH2","CH3"],br:[{i:1,g:"=O",p:"top-double"}],t:'ketone'},
                {n:"pentan-2-ona",c:["CH3","C","CH2","CH2","CH3"],br:[{i:1,g:"=O",p:"top-double"}],t:'ketone'},{n:"pentan-3-ona",c:["CH3","CH2","C","CH2","CH3"],br:[{i:2,g:"=O",p:"top-double"}],t:'ketone'},
                {n:"3-metilbutan-2-ona",c:["CH3","C","CH","CH3"],br:[{i:1,g:"=O",p:"top-double"},{i:2,g:"CH3",p:"bottom"}],t:'ketone'},
                {n:"hexan-2-ona",c:["CH3","C","CH2","CH2","CH2","CH3"],br:[{i:1,g:"=O",p:"top-double"}],t:'ketone'},
                {n:"butano-2,3-diona",c:["CH3","C","C","CH3"],br:[{i:1,g:"=O",p:"top-double"},{i:2,g:"=O",p:"top-double"}],t:'ketone'},
                {n:"pentano-2,4-diona",c:["CH3","C","CH2","C","CH3"],br:[{i:1,g:"=O",p:"top-double"},{i:3,g:"=O",p:"top-double"}],t:'ketone'},
                {n:"etanodial",c:["CH","CH"],br:[{i:0,g:"=O",p:"top-double"},{i:1,g:"=O",p:"top-double"}],t:'aldehyde'}
            ];
            oxy2Seeds.forEach(s=>addUnique('oxy2',{name:s.n,chain:s.c,branches:s.br?s.br.map(x=>({idx:x.i,g:x.g,pos:x.p})):[],subtype:s.t}));
            for(let c=4;c<=8;c++){
                let kPosLimit = Math.ceil(c/2);
                let kPos=Math.floor(Math.random()*(kPosLimit-1))+2;
                let chK=Array(c).fill("CH2");
                chK[0]="CH3";chK[c-1]="CH3";
                chK[kPos-1]="C";
                addUnique('oxy2',{name:`${getN(c)}an-${kPos}-ona`,chain:chK,branches:[{idx:kPos-1,g:"=O",pos:"top-double"}],subtype:'ketone'});
            }

            const acidSeeds = [
                {n:"ácido metanoico",c:["H","C","OH"],br:[{i:1,g:"=O",p:"top-double"}],t:'acid'},
                {n:"ácido etanoico",c:["CH3","C","OH"],br:[{i:1,g:"=O",p:"top-double"}],t:'acid'},
                {n:"ácido propanoico",c:["CH3","CH2","C","OH"],br:[{i:2,g:"=O",p:"top-double"}],t:'acid'},
                {n:"ácido butanoico",c:["CH3","CH2","CH2","C","OH"],br:[{i:3,g:"=O",p:"top-double"}],t:'acid'},
                {n:"ácido 2-metilpropanoico",c:["CH3","CH","C","OH"],br:[{i:1,g:"CH3",p:"bottom"},{i:2,g:"=O",p:"top-double"}],t:'acid'},
                {n:"ácido pentanoico",c:["CH3","CH2","CH2","CH2","C","OH"],br:[{i:4,g:"=O",p:"top-double"}],t:'acid'},
                {n:"ácido 3-clorobutanoico",c:["CH3","CH","CH2","C","OH"],br:[{i:1,g:"Cl",p:"top"},{i:3,g:"=O",p:"top-double"}],t:'acid'},
                {n:"ácido etanodioico",c:["OH","C","C","OH"],br:[{i:1,g:"=O",p:"top-double"},{i:2,g:"=O",p:"top-double"}],t:'acid'},
                {n:"ácido propanodioico",c:["OH","C","CH2","C","OH"],br:[{i:1,g:"=O",p:"top-double"},{i:3,g:"=O",p:"top-double"}],t:'acid'},
                {n:"metanoato de metilo",c:["H","C","O","CH3"],br:[{i:1,g:"=O",p:"top-double"}],t:'ester'},
                {n:"etanoato de metilo",c:["CH3","C","O","CH3"],br:[{i:1,g:"=O",p:"top-double"}],t:'ester'},
                {n:"etanoato de etilo",c:["CH3","C","O","CH2","CH3"],br:[{i:1,g:"=O",p:"top-double"}],t:'ester'},
                {n:"propanoato de metilo",c:["CH3","CH2","C","O","CH3"],br:[{i:2,g:"=O",p:"top-double"}],t:'ester'},
                {n:"butanoato de etilo",c:["CH3","CH2","CH2","C","O","CH2","CH3"],br:[{i:3,g:"=O",p:"top-double"}],t:'ester'}
            ];
            acidSeeds.forEach(s=>addUnique('acids',{name:s.n,chain:s.c,branches:s.br?s.br.map(x=>({idx:x.i,g:x.g,pos:x.p})):[],subtype:s.t}));

            const nitroSeeds = [
                {n:"metanamina",c:["CH3","NH2"],t:'amine'},{n:"etanamina",c:["CH3","CH2","NH2"],t:'amine'},{n:"propan-1-amina",c:["CH3","CH2","CH2","NH2"],t:'amine'},
                {n:"propan-2-amina",c:["CH3","CH","CH3"],br:[{i:1,g:"NH2",p:"bottom"}],t:'amine'},
                {n:"N-metilmetanamina",c:["CH3","NH","CH3"],br:[{i:1,g:"CH3",p:"bottom"}],t:'amine'},
                {n:"N-metiletanamina",c:["CH3","CH2","NH"],br:[{i:2,g:"CH3",p:"bottom"}],t:'amine'},
                {n:"N,N-dimetiletanamina",c:["CH3","CH2","N"],br:[{i:2,g:"CH3",p:"top"},{i:2,g:"CH3",p:"bottom"}],t:'amine'},
                {n:"etano-1,2-diamina",c:["NH2","CH2","CH2","NH2"],t:'amine'},
                {n:"etanamida",c:["CH3","C","NH2"],br:[{i:1,g:"=O",p:"top-double"}],t:'amide'},
                {n:"propanamida",c:["CH3","CH2","C","NH2"],br:[{i:2,g:"=O",p:"top-double"}],t:'amide'},
                {n:"N-metiletanamida",c:["CH3","C","NH"],br:[{i:1,g:"=O",p:"top-double"},{i:2,g:"CH3",p:"bottom"}],t:'amide'},
                {n:"N,N-dimetilpropanamida",c:["CH3","CH2","C","N"],br:[{i:2,g:"=O",p:"top-double"},{i:3,g:"CH3",p:"top"},{i:3,g:"CH3",p:"bottom"}],t:'amide'},
                {n:"etanonitrilo",c:["CH3","CN"],t:'nitrile',isNitrile:true},{n:"propanonitrilo",c:["CH3","CH2","CN"],t:'nitrile',isNitrile:true},
                {n:"butanonitrilo",c:["CH3","CH2","CH2","CN"],t:'nitrile',isNitrile:true},{n:"propanodinitrilo",c:["CN","CH2","CN"],t:'nitrile',isNitrile:true},
                {n:"butanodinitrilo",c:["CN","CH2","CH2","CN"],t:'nitrile',isNitrile:true}
            ];
            nitroSeeds.forEach(s=>addUnique('nitrogen',{name:s.n,chain:s.c,branches:s.br?s.br.map(x=>({idx:x.i,g:x.g,pos:x.p})):[],subtype:s.t,isNitrile:s.isNitrile}));

            // FIX QUÍMICO: 1,1,2-tricloroetano tenía hidrógenos mal representados (CH2Cl + 2 Cl => imposible).
            // Se representa como CH(Cl)2-CH2Cl -> cadena ["CH","CH2"] con 2 Cl en C1 y 1 Cl en C2.
            const haloSeeds = [
                {n:"clorometano",c:["CH3"],br:[{i:0,g:"Cl",p:"top"}],t:'halide'},
                {n:"bromometano",c:["CH3"],br:[{i:0,g:"Br",p:"top"}],t:'halide'},
                {n:"cloroetano",c:["CH3","CH2"],br:[{i:1,g:"Cl",p:"top"}],t:'halide'},
                {n:"1,1-dicloroetano",c:["CH3","CH"],br:[{i:1,g:"Cl",p:"top"},{i:1,g:"Cl",p:"bottom"}],t:'halide'},
                {n:"1,2-dicloroetano",c:["CH2","CH2"],br:[{i:0,g:"Cl",p:"top"},{i:1,g:"Cl",p:"bottom"}],t:'halide'},
                {n:"1,1,2-tricloroetano",c:["CH","CH2"],br:[{i:0,g:"Cl",p:"top"},{i:0,g:"Cl",p:"bottom"},{i:1,g:"Cl",p:"top"}],t:'halide'},
                {n:"2-cloropropano",c:["CH3","CH","CH3"],br:[{i:1,g:"Cl",p:"top"}],t:'halide'},
                {n:"2-bromo-2-cloropropano",c:["CH3","C","CH3"],br:[{i:1,g:"Br",p:"top"},{i:1,g:"Cl",p:"bottom"}],t:'halide'},
                {n:"nitrometano",c:["CH3"],br:[{i:0,g:"NO2",p:"top"}],t:'nitro'},
                {n:"nitroetano",c:["CH3","CH2"],br:[{i:1,g:"NO2",p:"top"}],t:'nitro'},
                {n:"1-nitropropano",c:["CH3","CH2","CH2"],br:[{i:2,g:"NO2",p:"top"}],t:'nitro'},
                {n:"2-nitropropano",c:["CH3","CH","CH3"],br:[{i:1,g:"NO2",p:"top"}],t:'nitro'}
            ];
            haloSeeds.forEach(s=>addUnique('halonitro',{name:s.n,chain:s.c,branches:s.br?s.br.map(x=>({idx:x.i,g:x.g,pos:x.p})):[],subtype:s.t}));

            // --- HARD / PRO (idéntico a tu base, con proMix/proHydro ya precargados) ---
            // Nota: mantengo tu set (no lo recorto) para no romper coherencia interna.

            const hardSeeds = [
                {n:"ácido 2-hidroxipropanoico",c:["CH3","CH","C","OH"],br:[{i:1,g:"OH",p:"bottom"},{i:2,g:"=O",p:"top-double"}],t:'acid'},
                {n:"ácido 3-oxobutanoico",c:["CH3","C","CH2","C","OH"],br:[{i:1,g:"=O",p:"top-double"},{i:3,g:"=O",p:"top-double"}],t:'acid'},
                {n:"ácido 2-aminopropanoico",c:["CH3","CH","C","OH"],br:[{i:1,g:"NH2",p:"bottom"},{i:2,g:"=O",p:"top-double"}],t:'acid'},
                {n:"3-hidroxibutanal",c:["CH3","CH","CH2","CH"],br:[{i:1,g:"OH",p:"bottom"},{i:3,g:"=O",p:"top-double"}],t:'aldehyde'},
                {n:"4-cloropentan-2-ona",c:["CH3","CH","CH2","C","CH3"],br:[{i:1,g:"Cl",p:"top"},{i:3,g:"=O",p:"top-double"}],t:'ketone'},
                {n:"butano-2,3-diona",c:["CH3","C","C","CH3"],br:[{i:1,g:"=O",p:"top-double"},{i:2,g:"=O",p:"top-double"}],t:'ketone'},
                {n:"3-aminobutanonitrilo",c:["CH3","CH","CH2","CN"],br:[{i:1,g:"NH2",p:"top"}],isNitrile:true,t:'nitrile'},
                {n:"propanoato de sodio",c:["CH3","CH2","C","ONa"],br:[{i:2,g:"=O",p:"top-double"}],t:'salt'},
                {n:"etanoato de potasio",c:["CH3","C","OK"],br:[{i:1,g:"=O",p:"top-double"}],t:'salt'},
                {n:"3-oxopentanoato de metilo",c:["CH3","CH2","C","CH2","C","O","CH3"],br:[{i:2,g:"=O",p:"top-double"},{i:4,g:"=O",p:"top-double"}],t:'ester'}
            ];
            hardSeeds.forEach(s=>addUnique('funcHard',{name:s.n,chain:s.c,branches:s.br?s.br.map(x=>({idx:x.i,g:x.g,pos:x.p})):[],subtype:s.t,isNitrile:s.isNitrile}));

            const hHardSeeds = [
                {n:"3-metilbut-1-ino",c:["CH3","CH","C","CH"],br:[{i:1,g:"CH3",p:"top"}],b:[{i:2,t:"3"}]},
                {n:"4-metilpent-2-ino",c:["CH3","CH","C","C","CH3"],br:[{i:1,g:"CH3",p:"top"}],b:[{i:2,t:"3"}]},
                {n:"3-etilhexa-1,4-dieno",c:["CH2","CH","CH","CH","CH","CH3"],br:[{i:2,g:"CH2CH3",p:"bottom"}],b:[{i:0,t:"="},{i:3,t:"="}]},
                {n:"3-vinilpenta-1,4-dieno",c:["CH2","CH","CH","CH","CH2"],br:[{i:2,g:"CH=CH2",p:"bottom"}],b:[{i:0,t:"="},{i:3,t:"="}]},
                {n:"but-1-en-3-ino",c:["CH2","CH","C","CH"],b:[{i:0,t:"="},{i:2,t:"3"}]},
                {n:"5-metilhex-1-en-3-ino",c:["CH2","CH","C","C","CH","CH3"],b:[{i:0,t:"="},{i:2,t:"3"}],br:[{i:4,g:"CH3",p:"top"}]}
            ];
            hHardSeeds.forEach(s=>addUnique('hydroHard',{name:s.n,chain:s.c,bonds:s.b?s.b.map(x=>({idx:x.i,type:x.t})):[],branches:s.br?s.br.map(x=>({idx:x.i,g:x.g,pos:x.p})):[]}));

            // PRO HYDRO
            const proHydroSeeds = [
                {n: "3,3-dietil-4-vinilhepta-1,6-dieno", c: ["CH2","CH","C","CH","CH2","CH","CH2"], br: [{i:2,g:"CH2CH3",p:"top"}, {i:2,g:"CH2CH3",p:"bottom"}, {i:3,g:"CH=CH2",p:"top"}], b: [{i:0,t:"="},{i:5,t:"="}], t: 'hydro'},
                {n: "4-isopropil-3-metilhept-3-en-1-ino", c: ["CH","C","C","C","CH2","CH2","CH3"], br: [{i:2,g:"CH3",p:"top"}, {i:3,g:"CH(CH3)2",p:"bottom"}], b: [{i:0,t:"3"},{i:2,t:"="}], t: 'hydro'},
                {n: "2,3,4-trimetilhexa-1,3,5-trieno", c: ["CH2","CH","C","C","C","CH2"], b: [{i:0,t:"="},{i:2,t:"="},{i:4,t:"="}], br: [{i:2,g:"CH3",p:"top"}, {i:3,g:"CH3",p:"bottom"}, {i:4,g:"CH3",p:"top"}], t:'hydro'},
                {n: "3-etil-3-metilpent-1-en-4-ino", c: ["CH2","CH","C","C","CH"], br: [{i:2,g:"CH3",p:"top"}, {i:2,g:"CH2CH3",p:"bottom"}], b: [{i:0,t:"="},{i:3,t:"3"}], t: 'hydro'},
                {n: "3-isopropil-4,4-dimetilpent-1-ino", c: ["CH","C","CH","C","CH3"], b: [{i:0,t:"3"}], br: [{i:2,g:"CH(CH3)2",p:"top"}, {i:3,g:"CH3",p:"top"}, {i:3,g:"CH3",p:"bottom"}], t:'hydro'},
                {n: "3-propil-4-vinilhexa-1,5-dieno", c: ["CH2","CH","CH","CH","CH","CH2"], b: [{i:0,t:"="},{i:4,t:"="}], br: [{i:2,g:"CH2CH2CH3",p:"top"}, {i:3,g:"CH=CH2",p:"bottom"}], t:'hydro'},
                {n: "3,3-dimetil-4-vinilpenta-1,4-dieno", c: ["CH2","CH","C","C","CH2"], b: [{i:0,t:"="},{i:3,t:"="}], br: [{i:2,g:"CH3",p:"top"}, {i:2,g:"CH3",p:"bottom"}, {i:3,g:"CH=CH2",p:"bottom"}], t:'hydro'},
                {n: "3-etil-3-isopropilpent-1-en-4-ino", c: ["CH2","CH","C","C","CH"], b: [{i:0,t:"="},{i:3,t:"3"}], br: [{i:2,g:"CH2CH3",p:"top"}, {i:2,g:"CH(CH3)2",p:"bottom"}], t:'hydro'},
                {n: "3,4-dimetil-3-vinilhex-1-ino", c: ["CH","C","C","CH","CH2","CH3"], br: [{i:2,g:"CH3",p:"top"}, {i:2,g:"CH=CH2",p:"bottom"}, {i:3,g:"CH3",p:"top"}], b: [{i:0,t:"3"}], t: 'hydro'}
            ];
            proHydroSeeds.forEach(s => addUnique('proHydro', {name:s.n, chain:s.c, branches:s.br?s.br.map(x=>({idx:x.i, g:x.g, pos:x.p})):[], bonds:s.b?s.b.map(x=>({idx:x.i, type:x.t})):[], subtype:s.t}));

            // PRO FUNC (tu lista original, con un ajuste químico: evitar CH2Cl como “átomo” y pasarlo a rama)
            const proFuncSeeds = [
                {n: "ácido 3-metil-4-oxohex-2-enoico", c: ["CH3","CH2","C","C","CH","C","OH"], br: [{i:2,g:"=O",p:"top-double"},{i:3,g:"CH3",p:"bottom"},{i:5,g:"=O",p:"top-double"}], b: [{i:3,t:"="}], t: 'acid'},
                {n: "3-hidroxi-2-vinilpentanamida", c: ["CH3","CH2","CH","CH","C","NH2"], br: [{i:2,g:"OH",p:"top"},{i:3,g:"CH=CH2",p:"bottom"},{i:4,g:"=O",p:"top-double"}], t: 'amide'},
                {n: "4-cloro-3-etilpentanonitrilo", c: ["CH3","CH","CH","CH2","CN"], br: [{i:1,g:"Cl",p:"top"},{i:2,g:"CH2CH3",p:"bottom"}], t: 'nitrile', isNitrile:true},
                {n: "4-hidroxi-3-oxopentanoato de sodio", c: ["CH3","CH","C","CH2","C","ONa"], br: [{i:1,g:"OH",p:"bottom"},{i:2,g:"=O",p:"top-double"},{i:4,g:"=O",p:"top-double"}], t: 'salt'},
                {n: "4-nitrohex-2-inal", c: ["CH3","CH2","CH","C","C","CH"], br: [{i:2,g:"NO2",p:"top"},{i:5,g:"=O",p:"top-double"}], b: [{i:3,t:"3"}], t: 'aldehyde'},
                {n: "4-amino-2-metilbut-3-enoato de etilo", c: ["NH2","CH","CH","CH","C","O","CH2","CH3"], br: [{i:3,g:"CH3",p:"bottom"},{i:4,g:"=O",p:"top-double"}], b: [{i:1,t:"="}], t: 'ester'},
                {n: "3-bromo-4-metilhexano-2,5-diol", c: ["CH3","CH","CH","CH","CH","CH3"], br: [{i:1,g:"OH",p:"bottom"},{i:2,g:"Br",p:"top"},{i:3,g:"CH3",p:"bottom"},{i:4,g:"OH",p:"top"}], t: 'alcohol'},
                {n: "3-vinilhexano-2,5-diona", c: ["CH3","C","CH","CH2","C","CH3"], br: [{i:1,g:"=O",p:"top-double"},{i:2,g:"CH=CH2",p:"bottom"},{i:4,g:"=O",p:"top-double"}], t: 'ketone'},
                {n: "ácido 2,3-dihidroxi-4-metilpentanoico", c: ["CH3","CH","CH","CH","C","OH"], br: [{i:1,g:"CH3",p:"bottom"},{i:2,g:"OH",p:"top"},{i:3,g:"OH",p:"bottom"},{i:4,g:"=O",p:"top-double"}], t: 'acid'},
                {n: "4-oxopent-2-enonitrilo", c: ["CH3","C","CH","CH","CN"], br: [{i:1,g:"=O",p:"top-double"}], b: [{i:2,t:"="}], t: 'nitrile', isNitrile:true},
                {n: "2-cloro-3-isopropilbutanamida", c: ["CH3","CH","CH","CH","NH2"], br: [{i:2,g:"CH(CH3)2",p:"bottom"},{i:3,g:"Cl",p:"top"},{i:4,g:"=O",p:"top-double"}], t: 'amide'},
                {n: "pentano-1,3,5-triol", c: ["CH2OH","CH2","CH","CH2","CH2OH"], br: [{i:2,g:"OH",p:"bottom"}], t: 'alcohol'},
                {n: "4-oxopentanal", c: ["CH3","C","CH2","CH2","CH"], br: [{i:1,g:"=O",p:"top-double"},{i:4,g:"=O",p:"top-double"}], t: 'aldehyde'},
                {n: "2-etilbut-2-enoato de metilo", c: ["CH3","CH","C","C","O","CH3"], br: [{i:2,g:"CH2CH3",p:"top"},{i:3,g:"=O",p:"top-double"}], b: [{i:1,t:"="}], t: 'ester'},
                {n: "ácido 3-amino-4-nitropentanoico", c: ["CH3","CH","CH","CH2","C","OH"], br: [{i:1,g:"NO2",p:"top"},{i:2,g:"NH2",p:"bottom"},{i:4,g:"=O",p:"top-double"}], t: 'acid'},
                {n: "but-3-enoato de potasio", c: ["CH2","CH","CH2","C","OK"], br: [{i:3,g:"=O",p:"top-double"}], b: [{i:0,t:"="}], t: 'salt'},
                {n: "N-etil-2-metilpropanamida", c: ["CH3","CH","C","NH"], br: [{i:1,g:"CH3",p:"top"},{i:2,g:"=O",p:"top-double"},{i:3,g:"CH2CH3",p:"bottom"}], t: 'amide'},
                {n: "2-metilbutanodial", c: ["CH","CH2","CH","CH"], br: [{i:0,g:"=O",p:"top-double"},{i:2,g:"CH3",p:"top"},{i:3,g:"=O",p:"top-double"}], t: 'aldehyde'},
                {n: "3-oxobutanoato de etilo", c: ["CH3","C","CH2","C","O","CH2","CH3"], br: [{i:1,g:"=O",p:"top-double"},{i:3,g:"=O",p:"top-double"}], t: 'ester'},
                {n: "ácido but-2-enodioico", c: ["OH","C","CH","CH","C","OH"], br: [{i:1,g:"=O",p:"top-double"},{i:4,g:"=O",p:"top-double"}], b: [{i:2,t:"="}], t: 'acid'},
                {n: "3-hidroxibutanonitrilo", c: ["CH3","CH","CH2","CN"], br: [{i:1,g:"OH",p:"top"}], isNitrile:true, t: 'nitrile'},
                {n: "4-aminopentan-2-ona", c: ["CH3","CH","CH2","C","CH3"], br: [{i:1,g:"NH2",p:"top"},{i:3,g:"=O",p:"top-double"}], t: 'ketone'},
                {n: "2-nitroetanol", c: ["CH2","CH2OH"], br: [{i:0,g:"NO2",p:"top"}], t: 'alcohol'},
                {n: "N-metil-N-propilpropan-1-amina", c: ["CH3","CH2","CH2","N"], br: [{i:3,g:"CH3",p:"top"},{i:3,g:"CH2CH2CH3",p:"bottom"}], t: 'amine'},
                {n: "ácido 3-vinilhexanoico", c: ["CH3","CH2","CH2","CH","CH2","C","OH"], br: [{i:3,g:"CH=CH2",p:"bottom"},{i:5,g:"=O",p:"top-double"}], t: 'acid'},
                // FIX: CH2Cl como átomo principal coloreaba el carbono como halógeno. Se pasa a rama.
                {n: "2-cloroetanoato de sodio", c: ["CH2","C","ONa"], br: [{i:0,g:"Cl",p:"top"},{i:1,g:"=O",p:"top-double"}], t: 'salt'}
            ];
            proFuncSeeds.forEach(s => addUnique('proMix', {name:s.n, chain:s.c, branches:s.br?s.br.map(x=>({idx:x.i, g:x.g, pos:x.p})):[], bonds:s.b?s.b.map(x=>({idx:x.i, type:x.t})):[], subtype:s.t, isNitrile:s.isNitrile}));

            // Añadir también hidro PRO al mix PRO general
            proHydroSeeds.forEach(s => addUnique('proMix', {name:s.n, chain:s.c, branches:s.br?s.br.map(x=>({idx:x.i, g:x.g, pos:x.p})):[], bonds:s.b?s.b.map(x=>({idx:x.i, type:x.t})):[], subtype:s.t}));
        }

        generateData();

        // --- RENDERIZADOR ---
        function renderMoleculeHTML(data, isMini = false, noColor = false) {
            let html = `<div class="molecule-container chemical-font ${isMini ? 'text-xs' : ''}">`;

            if(data.type === "simple") {
                return `<div class="molecule-wrapper text-xl">${sub(data.chain[0])}</div>`;
            }

            data.chain.forEach((atom, index) => {
                const branches = data.branches ? data.branches.filter(b => b.idx === index) : [];
                const topBranch = branches.find(b => b.pos.includes('top'));
                const bottomBranch = branches.find(b => b.pos.includes('bottom'));

                let atomClass = "main-atom";
                if(atom.includes("(CH2)")) atomClass += " atom-condensed";

                if(!noColor && !atomClass.includes("condensed")) {
                    if(atom.includes("O")) atomClass += " atom-O";
                    if(atom.includes("N") || atom === "CN") atomClass += " atom-N";
                    if(atom.includes("Cl")) atomClass += " atom-Cl";
                    if(atom.includes("Br")) atomClass += " atom-Br";
                    if(atom.includes("I")) atomClass += " atom-I";
                    if(atom.includes("F")) atomClass += " atom-F";
                    if(atom.includes("Na") || atom.includes("K")) atomClass += " atom-Na";
                }

                html += '<div class="carbon-group">';
                html += `<div class="flex flex-col items-center justify-end ${isMini ? 'h-5' : 'h-10'}" style="min-width:10px">`;
                if (topBranch) {
                    let bClass = noColor ? "branch-atom-hard" : "branch-atom";
                    if(!noColor) {
                        if(topBranch.g.includes("O")) bClass += " branch-atom-O";
                        if(topBranch.g.includes("N")) bClass += " branch-atom-N";
                        if(topBranch.g.match(/Cl|Br|I|F|NO/)) bClass += " branch-atom-X";
                    }
                    let gStr = topBranch.g.replace("=O","O");
                    if(gStr.length > 3) html += `<span class="${bClass}" style="font-size:0.7rem; white-space:nowrap; margin-left:-10px">${sub(gStr)}</span>`;
                    else html += `<span class="${bClass}">${sub(gStr)}</span>`;

                    if(topBranch.pos === "top-double") html += `<div class="v-bond-double-up"></div>`; else html += `<div class="v-bond-up"></div>`;
                }
                html += '</div>';

                html += `<div class="${atomClass}">${sub(atom)}</div>`;

                html += `<div class="flex flex-col items-center justify-start ${isMini ? 'h-5' : 'h-10'}" style="min-width:10px">`;
                if (bottomBranch) {
                    let bClass = noColor ? "branch-atom-hard" : "branch-atom";
                    if(!noColor) {
                        if(bottomBranch.g.includes("OH") || bottomBranch.g.includes("O")) bClass += " branch-atom-O";
                        if(bottomBranch.g.includes("N")) bClass += " branch-atom-N";
                        if(bottomBranch.g.match(/Cl|Br|I|F|NO/)) bClass += " branch-atom-X";
                    }
                    if(bottomBranch.pos === "bottom-double") html += `<div class="v-bond-double-down"></div>`; else html += `<div class="v-bond-down"></div>`;

                    let gStr = bottomBranch.g;
                    if(gStr.length > 3) html += `<span class="${bClass}" style="font-size:0.7rem; white-space:nowrap; margin-left:-10px">${sub(gStr)}</span>`;
                    else html += `<span class="${bClass}">${sub(gStr)}</span>`;
                }
                html += '</div></div>';

                if (index < data.chain.length - 1) {
                    let bondType = "single";
                    if (data.bonds) {
                        let b = data.bonds.find(bd => bd.idx === index);
                        if (b) bondType = b.type;
                    }
                    html += `<div class="bond-spacer">`;
                    if(bondType === "=") html += `<div class="h-bond-double"></div>`;
                    else if(bondType === "3") html += `<div class="h-bond-triple"></div>`;
                    else html += `<div class="h-bond"></div>`;
                    html += `</div>`;
                }
            });
            html += '</div>';
            return html;
        }

        // --- LÓGICA JUEGO ---
        let currentMode = 'hydro';
        let state = { questions: [], idx: 0, score: 0, history: [], selected: null, levelId: '', isHard: false };

        function selectApp(mode) { currentMode = mode; switchScreen('level-screen'); renderLevelScreen(); }

        function renderLevelScreen() {
            const config = apps[currentMode];
            document.getElementById('header-bg').className = `bg-${config.color}-600 p-6 text-center text-white shrink-0 rounded-b-3xl shadow-lg z-10 relative`;
            document.getElementById('app-title').innerText = config.title;
            document.getElementById('theory-content').innerHTML = config.cheatsheet;

            const grid = document.getElementById('levels-grid');
            grid.innerHTML = '';
            config.levels.forEach(lvl => {
                grid.innerHTML += `<button onclick="startGame('${lvl.id}')" class="p-4 bg-${config.color}-50 border border-${config.color}-100 rounded-xl active:bg-${config.color}-100 flex flex-col items-center justify-center text-center transition-all hover:shadow-md group"><div class="w-12 h-12 bg-white rounded-full flex items-center justify-center mb-2 shadow-sm"><i class="fas ${lvl.icon} text-2xl text-${config.color}-500"></i></div><div class="text-${config.color}-900 font-bold text-sm leading-tight">${lvl.name}</div></button>`;
            });

            const mixBtns = document.getElementById('mix-buttons');
            let hardKey = currentMode === 'hydro' ? 'hydroHard' : 'funcHard';
            mixBtns.innerHTML = `
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="startGame('mix', false, true)" class="py-4 bg-gray-800 text-white rounded-xl active:bg-black font-bold text-xs shadow-md flex flex-col items-center justify-center"><i class="fas fa-random text-lg mb-1"></i> Mix General</button>
                    <button onclick="startGame('${hardKey}', true)" class="py-4 bg-red-600 text-white rounded-xl active:bg-red-700 font-bold text-xs shadow-md flex flex-col items-center justify-center border-b-4 border-red-800"><i class="fas fa-skull-crossbones text-lg mb-1"></i> Mix Experto</button>
                </div>
                <button onclick="startGame('pro', true, false, true)" class="w-full py-4 bg-purple-600 text-white rounded-xl active:bg-purple-700 font-bold text-sm shadow-lg flex items-center justify-center border-b-4 border-purple-800 relative overflow-hidden">
                    <div class="absolute inset-0 bg-white opacity-10 transform -skew-x-12"></div>
                    <i class="fas fa-graduation-cap text-xl mr-2"></i> Mix Nivel PRO
                </button>
            `;
        }

        function startGame(dbKey, isHard = false, isMix = false, isPro = false) {
            const count = parseInt(document.querySelector('input[name="q-count"]:checked').value);
            let pool = [];

            if(isPro) {
                if(currentMode === 'hydro') {
                    pool = db.proHydro;
                } else {
                    const proSource = db.proMix;
                    const acidTypes = ['acid', 'salt', 'ester'];
                    const acidsPool = proSource.filter(x => acidTypes.includes(x.subtype));
                    const otherPool = proSource.filter(x => !acidTypes.includes(x.subtype));

                    // FIX: limitar a 40% aprox. (especificación 30-40%).
                    let maxAcids = Math.max(0, Math.floor(count * 0.4));
                    let selectedAcids = shuffle(acidsPool.slice()).slice(0, maxAcids);
                    let neededOthers = count - selectedAcids.length;
                    let selectedOthers = shuffle(otherPool.slice()).slice(0, neededOthers);
                    pool = [...selectedAcids, ...selectedOthers];
                }
            } else if(isMix && !isHard) {
                let keys = currentMode === 'hydro' ? ['linear','branched','alkenes','alkynes'] : ['oxy1','oxy2','acids','nitrogen','halonitro'];
                let perKey = Math.ceil(count / keys.length);
                keys.forEach(k => { if(db[k]) pool.push(...shuffle(db[k].slice()).slice(0, perKey)); });
            } else if (db[dbKey]) {
                let subtypes = {};
                let hasSubtypes = false;
                db[dbKey].forEach(item => {
                    if(item.subtype) {
                        hasSubtypes = true;
                        if(!subtypes[item.subtype]) subtypes[item.subtype] = [];
                        subtypes[item.subtype].push(item);
                    }
                });
                if(hasSubtypes) {
                    let types = Object.keys(subtypes);
                    let perType = Math.ceil(count / types.length);
                    types.forEach(t => { pool.push(...shuffle(subtypes[t].slice()).slice(0, perType)); });
                } else {
                    pool = db[dbKey];
                }
            } else {
                pool = db.linear;
            }

            if(!pool || pool.length === 0) {
                alert("No hay suficientes preguntas para este nivel.");
                return;
            }

            let uniquePool = shuffle(pool.slice());
            if(uniquePool.length < count) {
                while(uniquePool.length < count) uniquePool = uniquePool.concat(pool);
            }
            const finalSelection = uniquePool.slice(0, count);

            state.questions = prepareQuestions(finalSelection, isHard, isPro);
            state.idx = 0;
            state.score = 0;
            state.history = [];
            state.levelId = dbKey;
            state.isHard = isHard;
            state.selected = null;

            document.getElementById('level-indicator').innerText = isPro ? 'PRO' : (isHard ? 'EXPERTO' : 'NORMAL');

            switchScreen('game-screen');
            renderQuestion();
        }

        function prepareQuestions(source, isHard, isPro) {
            let res = [];

            source.forEach(item => {
                // Respuestas válidas: aceptamos tildes/guiones/espacios equivalentes (comparación normalizada)
                let validNames = [item.name];

                // sinónimos simples (opcionales, mínimos) para aprendizaje
                const syn = {
                    'propanona': ['propan-2-ona'],
                    'butanona': ['butan-2-ona']
                };
                if(syn[item.name]) validNames.push(...syn[item.name]);

                // Variación ácido sin tilde (por si el alumno escribe "acido")
                if(item.name.startsWith('ácido ')) validNames.push('acido ' + item.name.slice(6));

                let cleanItem = JSON.parse(JSON.stringify(item));
                let qType = isPro ? 'naming' : (Math.random() > 0.4 ? 'naming' : 'formulating');

                if(qType === 'naming') {
                    res.push({ type: 'naming', mode: item.type==='simple'?'simple':'structural', q: cleanItem, a: validNames });
                } else {
                    let w1 = JSON.parse(JSON.stringify(item));
                    let w2 = JSON.parse(JSON.stringify(item));

                    // Distractores: ajuste suave de cadena para que sea plausible, evitando duplicados.
                    if(item.type === 'simple') {
                        let f = w1.chain[0];
                        if(f.includes("(CH2)")) {
                            let n = parseInt(f.match(/\(CH2\)(\d+)/)[1]);
                            w1.chain[0] = f.replace(`(CH2)${n}`, `(CH2)${Math.max(1, n-1)}`);
                            w2.chain[0] = f.replace(`(CH2)${n}`, `(CH2)${n+1}`);
                        } else {
                            let n = f.match(/CH2/g) ? f.match(/CH2/g).length + 2 : (f==='CH4'?1:2);
                            w1.chain[0] = getFormula(Math.max(1, n-1));
                            w2.chain[0] = getFormula(n+1);
                        }
                    } else {
                        if(w1.chain.some(x=>x.includes("(CH2)"))) {
                            let idx = w1.chain.findIndex(x=>x.includes("(CH2)"));
                            let n = parseInt(w1.chain[idx].match(/\d+/)[0]);
                            w1.chain[idx] = `(CH2)${Math.max(1, n-1)}`;
                            w2.chain[idx] = `(CH2)${n+1}`;
                        } else {
                            // Inferencias básicas por tipo funcional (por subtipo)
                            const subtype = item.subtype || '';
                            const isNitrile = !!item.isNitrile || subtype === 'nitrile';

                            if(isNitrile) {
                                // Evitar borrar el terminador CN en distractores
                                w1.chain.splice(0, 0, "CH2");
                                if(w2.chain.length > 2) w2.chain.splice(1, 1);
                            } else {
                                w1.chain.unshift("CH2");
                                if(w2.chain.length > 2) w2.chain.pop();
                                else w2.chain.push("CH2");
                            }
                        }
                    }

                    // Protección anti-duplicados (por HTML renderizado)
                    const s0 = renderMoleculeHTML(item);
                    let s1 = renderMoleculeHTML(w1);
                    let s2 = renderMoleculeHTML(w2);
                    if (s1 === s0 || s1 === s2) { w1.chain.push("CH2"); s1 = renderMoleculeHTML(w1); }
                    if (s2 === s0 || s2 === s1) { w2.chain.unshift("CH2"); }

                    res.push({
                        type: 'formulating',
                        mode: item.type==='simple'?'simple':'structural',
                        name: item.name,
                        correctStruct: item,
                        optionsStruct: [w1, w2]
                    });
                }
            });

            return res;
        }

        function renderQuestion() {
            const q = state.questions[state.idx];
            const display = document.getElementById('question-display');
            const txtArea = document.getElementById('input-text-area');
            const optArea = document.getElementById('input-options-area');
            const kbArea = document.getElementById('keyboard-area');

            document.getElementById('total-q').innerText = state.questions.length;
            document.getElementById('current-q').innerText = state.idx + 1;

            kbArea.innerHTML = '';
            apps[currentMode].keyboard.forEach(k => {
                kbArea.innerHTML += `<button onclick="addText('${k}')" class="touch-btn bg-gray-100 rounded border border-gray-200 text-gray-700 font-bold">${escapeHtml(k)}</button>`;
            });
            kbArea.innerHTML += `<button onclick="backspace()" class="col-span-4 touch-btn bg-red-50 rounded-lg border border-red-200 text-red-600"><i class="fas fa-backspace"></i></button>`;

            document.getElementById('feedback-area').classList.add('hidden');
            document.getElementById('check-btn').classList.remove('hidden');
            document.getElementById('next-btn').classList.add('hidden');
            document.getElementById('user-input').value = '';
            state.selected = null;
            document.getElementById('progress-bar').style.width = `${(state.idx / state.questions.length)*100}%`;

            if(q.type === 'naming') {
                document.getElementById('question-type-badge').innerText = "ESCRIBE EL NOMBRE";
                txtArea.classList.remove('hidden');
                optArea.classList.add('hidden');

                if(q.mode === 'simple') display.innerHTML = `<span class="text-xl font-bold">${sub(q.q.chain[0])}</span>`;
                else display.innerHTML = renderMoleculeHTML(q.q, false, state.isHard);
            } else {
                document.getElementById('question-type-badge').innerText = "ELIGE LA FÓRMULA";
                txtArea.classList.add('hidden');
                optArea.classList.remove('hidden');
                display.innerHTML = `<div class="text-question">${escapeHtml(q.name)}</div>`;

                optArea.innerHTML = '';
                let opts = [];

                if(q.mode === 'simple') {
                    opts = q.optionsStruct.map(o => ({
                        h: `<span class="text-lg font-bold">${sub(o.chain[0])}</span>`,
                        ok: false,
                        choice: o.chain[0],
                        choiceIsStruct: false
                    }));
                    opts.push({
                        h: `<span class="text-lg font-bold">${sub(q.correctStruct.chain[0])}</span>`,
                        ok: true,
                        choice: q.correctStruct.chain[0],
                        choiceIsStruct: false
                    });
                } else {
                    opts = q.optionsStruct.map(o => ({
                        h: renderMoleculeHTML(o, true, state.isHard),
                        ok: false,
                        choice: o,
                        choiceIsStruct: true
                    }));
                    opts.push({
                        h: renderMoleculeHTML(q.correctStruct, true, state.isHard),
                        ok: true,
                        choice: q.correctStruct,
                        choiceIsStruct: true
                    });
                }

                shuffle(opts).forEach(opt => {
                    const baseStyle = "w-full p-2 border-2 border-gray-200 rounded-xl active:bg-gray-50 transition-colors btn-inner-layout btn-div-wrapper";
                    const selectedStyle = "w-full p-2 border-2 border-blue-500 bg-blue-50 rounded-xl transition-colors btn-inner-layout btn-div-wrapper";
                    const circleBase = "w-6 h-6 rounded-full border-2 border-gray-300 mr-2 flex-shrink-0";
                    const circleSelected = "w-6 h-6 rounded-full border-2 border-blue-500 bg-blue-500 mr-2 flex-shrink-0";

                    const btn = document.createElement('div');
                    btn.className = baseStyle;
                    btn.innerHTML = `<div class="${circleBase}"></div><div class="btn-scroll-text">${opt.h}</div>`;

                    btn.onclick = () => {
                        Array.from(optArea.children).forEach(child => {
                            child.className = baseStyle;
                            child.querySelector('div:first-child').className = circleBase;
                        });
                        btn.className = selectedStyle;
                        btn.querySelector('div:first-child').className = circleSelected;
                        // FIX: guardar también la opción elegida (para la tabla de resultados)
                        state.selected = { ok: opt.ok, choice: opt.choice, isStruct: opt.choiceIsStruct };
                    };
                    optArea.appendChild(btn);
                });
            }
        }

        function checkAnswer() {
            try {
                const q = state.questions[state.idx];
                let isOk = false;
                let userAns = "";
                let userIsStruct = false;

                if(q.type === 'naming') {
                    userAns = document.getElementById('user-input').value;
                    isOk = q.a.some(ans => normName(userAns) === normName(ans));
                } else {
                    if(!state.selected) return;
                    isOk = state.selected.ok;
                    userAns = state.selected.choice;
                    userIsStruct = state.selected.isStruct;
                }

                let qStore = (q.type==='naming') ? (q.mode==='simple'?q.q.chain[0]:q.q) : q.name;
                let corrStore = (q.type==='naming') ? q.a[0] : (q.mode==='simple'?q.correctStruct.chain[0]:q.correctStruct);

                state.history.push({
                    q: qStore,
                    user: userAns,
                    userIsStruct,
                    ok: isOk,
                    struct: (q.type==='naming' && q.mode!=='simple'),
                    isHard: state.isHard,
                    simple: q.mode==='simple',
                    correct: corrStore
                });
                if(isOk) state.score++;

                const fb = document.getElementById('feedback-area');
                fb.classList.remove('hidden');
                const icon = document.getElementById('feedback-icon');
                const txt = document.getElementById('feedback-text');
                const corr = document.getElementById('feedback-correction');

                if(isOk) {
                    fb.className = "mt-4 text-center p-4 bg-green-50 rounded-xl border border-green-100";
                    icon.innerHTML = '<i class="fas fa-check-circle text-green-500"></i>';
                    txt.innerText = "Correcto";
                    txt.className = "font-bold text-xl mb-1 text-green-700";
                    corr.innerText = "";
                } else {
                    fb.className = "mt-4 text-center p-4 bg-red-50 rounded-xl border border-red-100";
                    icon.innerHTML = '<i class="fas fa-times-circle text-red-500"></i>';
                    txt.innerText = "Incorrecto";
                    txt.className = "font-bold text-xl mb-1 text-red-700";
                    corr.innerText = q.type==='naming' ? `Solución: ${q.a[0]}` : "Revisa la estructura";
                }

                document.getElementById('check-btn').classList.add('hidden');
                document.getElementById('next-btn').classList.remove('hidden');
            } catch(e) {
                console.error("Error checking answer:", e);
                nextQuestion();
            }
        }

        function finishGame() {
            try {
                switchScreen('end-screen');
                const pct = state.score / state.questions.length;
                let msg = pct === 1 ? "Nivel Maestro" : pct >= 0.8 ? "Excelente" : pct >= 0.6 ? "Buen trabajo" : "Sigue practicando";
                document.getElementById('final-score').innerText = `${state.score} / ${state.questions.length}`;
                document.getElementById('level-feedback').innerText = msg;

                const tbody = document.getElementById('results-table-body');
                tbody.innerHTML = '';

                state.history.forEach((h) => {
                    const tr = document.createElement('tr');

                    let qHTML = "";
                    try {
                        if(h.struct) qHTML = `<div class="overflow-x-auto max-w-[140px]">${renderMoleculeHTML(h.q, true, h.isHard)}</div>`;
                        else if(h.simple && typeof h.q === 'string' && h.q.startsWith('CH')) qHTML = `<span class="font-bold text-gray-700 text-lg">${sub(h.q)}</span>`;
                        else qHTML = `<span class="font-bold text-gray-700">${escapeHtml(h.q)}</span>`;
                    } catch(err) {
                        qHTML = `<span class="text-xs text-red-400">Error visual</span>`;
                    }

                    let userHTML = "";
                    try {
                        if(h.userIsStruct) userHTML = `<div class="overflow-x-auto max-w-[140px]">${renderMoleculeHTML(h.user, true, h.isHard)}</div>`;
                        else if(h.simple && typeof h.user === 'string' && h.user.startsWith('CH')) userHTML = `<span class="font-bold ${h.ok?'text-green-600':'text-red-600'}">${sub(h.user)}</span>`;
                        else userHTML = `<span class="${h.ok?'text-green-600':'text-red-600'} font-bold text-xs">${escapeHtml(h.user)}</span>`;
                    } catch(err) {
                        userHTML = `<span class="text-xs ${h.ok?'text-green-600':'text-red-600'}">(selección)</span>`;
                    }

                    let solHTML = "";
                    if(h.ok) {
                        solHTML = '<span class="text-green-500 font-bold">-</span>';
                    } else {
                        if(typeof h.correct === 'string') {
                            solHTML = `<span class="text-xs font-bold text-blue-600">${escapeHtml(h.correct)}</span>`;
                        } else {
                            solHTML = `<div class="overflow-x-auto max-w-[140px]">${renderMoleculeHTML(h.correct, true, true)}</div>`;
                        }
                    }

                    tr.innerHTML = `
                        <td class="p-3 align-middle text-xs font-bold text-gray-700">${qHTML}</td>
                        <td class="p-3 text-center align-middle">${userHTML}</td>
                        <td class="p-3 text-center align-middle">${solHTML}</td>
                        <td class="p-3 text-center align-middle">${h.ok?'<i class="fas fa-check text-green-500"></i>':'<i class="fas fa-times text-red-500"></i>'}</td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch(e) {
                console.error("Error finishing game", e);
                alert("Juego terminado. Puntuación: " + state.score + "/" + state.questions.length);
                goLevelSelect();
            }
        }

        // --- NAVEGACIÓN ---
        function switchScreen(id) {
            ['hub-screen','level-screen','game-screen','end-screen'].forEach(s => document.getElementById(s).classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
        }
        function goHub() { switchScreen('hub-screen'); }
        function goLevelSelect() { switchScreen('level-screen'); }
        function nextQuestion() { state.idx++; if(state.idx < state.questions.length) renderQuestion(); else finishGame(); }

        // --- UI helpers ---
        function toggleModal(id) { document.getElementById(id).classList.toggle('hidden'); }
        function shuffle(arr) { return arr.sort(() => Math.random() - 0.5); }
        function addText(t) { const i=document.getElementById('user-input'); i.value+=t; i.focus(); }
        function backspace() { const i=document.getElementById('user-input'); i.value=i.value.slice(0,-1); i.focus(); }

        document.getElementById('user-input').addEventListener('keypress', (e)=>{ if(e.key==='Enter') checkAnswer(); });
    </script>
</body>
</html>
