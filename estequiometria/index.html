<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Entrenador de Reacciones Qu√≠micas</title>
    <!-- Fuente para qu√≠mica y matem√°ticas -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif:ital@0;1&family=Segoe+UI:wght@400;600;800;900&display=swap" rel="stylesheet">
    <style>
        /* --- RESET Y BASES PARA M√ìVIL --- */
        * {
            box-sizing: border-box; 
        }

        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --success: #16a34a;
            --warning: #f59e0b;
            --error: #dc2626;
            --bg-color: #ffffff;
            --card: #ffffff;
            --text: #334155;
            --border: #cbd5e1;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 15px; 
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            color: var(--text);
            overflow-x: hidden; 
        }

        /* --- PANTALLA INICIAL (LANDING) --- */
        #landing-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: linear-gradient(to bottom, #d8b4fe 0%, #e9d5ff 25%, #f8fafc 100%);
            z-index: 2000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 1.5rem;
            text-align: center;
            transition: opacity 0.5s ease-out;
        }

        /* --- PANTALLA NIVEL --- */
        #level-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: linear-gradient(to bottom, #d8b4fe 0%, #e9d5ff 25%, #f8fafc 100%);
            z-index: 2000;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 1.5rem;
            text-align: center;
            animation: fadeInLevel 0.5s ease-out;
        }

        @keyframes fadeInLevel {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        .level-card {
            background: rgba(255, 255, 255, 0.95);
            padding: 2rem;
            border-radius: 20px;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
            max-width: 90%;
            width: 100%;
            border: 1px solid white;
        }

        .medal-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            display: block;
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .level-title {
            font-size: 1.8rem;
            font-weight: 900;
            color: #1e1b4b;
            margin-bottom: 0.5rem;
        }

        .level-subtitle {
            font-size: 1.1rem;
            color: #475569;
            margin-bottom: 1.5rem;
        }

        .level-stats {
            background: #f8fafc;
            padding: 1rem;
            border-radius: 12px;
            margin-bottom: 1.5rem;
            text-align: left;
            border: 1px solid #e2e8f0;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            font-size: 1rem;
            color: #334155;
        }

        .landing-content {
            max-width: 600px;
            width: 100%;
        }

        .landing-title {
            font-size: 2rem;
            font-weight: 900;
            color: #1e1b4b;
            margin-bottom: 1rem;
            letter-spacing: -1px;
            text-shadow: 0 1px 0 rgba(255,255,255,0.5);
        }

        .landing-text {
            font-size: 1.1rem;
            color: #475569;
            margin-bottom: 2rem;
            line-height: 1.5;
        }

        /* Animaci√≥n de rotaci√≥n de m√≥vil */
        .rotate-hint-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 2rem;
            padding: 15px;
            background: rgba(255, 255, 255, 0.6);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.5);
            backdrop-filter: blur(4px);
        }

        .phone-icon {
            width: 30px;
            height: 50px;
            border: 2px solid #334155;
            border-radius: 4px;
            position: relative;
            margin-bottom: 10px;
            animation: rotate-phone 3s infinite ease-in-out;
        }
        
        .phone-icon::before {
            content: '';
            position: absolute;
            top: 4px;
            left: 50%;
            transform: translateX(-50%);
            width: 8px;
            height: 1px;
            background-color: #334155;
        }

        .phone-icon::after {
            content: '';
            position: absolute;
            bottom: 4px;
            left: 50%;
            transform: translateX(-50%);
            width: 3px;
            height: 3px;
            background-color: #334155;
            border-radius: 50%;
        }

        @keyframes rotate-phone {
            0%, 10% { transform: rotate(0deg); }
            40%, 60% { transform: rotate(90deg); }
            90%, 100% { transform: rotate(90deg); }
        }

        .rotate-text {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--primary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-start {
            background: linear-gradient(to right, #2563eb, #4f46e5);
            color: white;
            border: none;
            padding: 14px 36px;
            border-radius: 30px;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 10px 15px -3px rgba(37, 99, 235, 0.3);
            transition: transform 0.2s, box-shadow 0.2s;
            width: 100%;
            max-width: 300px;
        }

        .btn-start:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 20px -3px rgba(37, 99, 235, 0.4);
        }

        /* --- BOT√ìN DE ABANDONO --- */
        .btn-abandon {
            background: transparent;
            color: #ef4444;
            border: 2px solid #fecaca;
            padding: 10px 20px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 700;
            transition: all 0.3s ease;
            margin-top: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            letter-spacing: 0.5px;
            width: 100%; 
            max-width: 300px;
        }

        .btn-abandon:hover {
            background: #fef2f2;
            border-color: #ef4444;
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(239, 68, 68, 0.15);
        }
        
        .btn-abandon svg {
            width: 18px;
            height: 18px;
            stroke: currentColor;
            stroke-width: 2.5;
            fill: none;
        }

        /* --- APLICACI√ìN PRINCIPAL --- */
        #app-container {
            display: none;
            max-width: 950px;
            width: 100%;
            background-image: linear-gradient(to bottom, #d8b4fe 0%, #e9d5ff 25%, #f8fafc 100%);
            border-radius: 16px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            padding: 1.5rem;
            position: relative;
            padding-bottom: 4rem;
            border: 1px solid #e2e8f0;
            animation: fadeInApp 0.8s ease-out;
        }

        @keyframes fadeInApp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        h1 {
            color: #1e1b4b;
            text-align: center;
            margin-bottom: 1.5rem;
            font-weight: 800;
            font-size: 1.5rem;
            letter-spacing: -0.5px;
            text-shadow: 0 1px 0 rgba(255,255,255,0.5);
        }

        .header-stats {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding: 0.8rem 1.2rem;
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.5);
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.02);
            backdrop-filter: blur(4px);
        }

        .stat-box {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .stat-label {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #64748b;
            font-weight: 700;
        }

        .stat-value {
            font-size: 1.4rem;
            font-weight: 800;
            color: var(--primary);
        }

        .exercise-card {
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 1.5rem;
            background: white;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .tag-type {
            display: inline-block;
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
            color: var(--primary-dark);
            border: 1px solid #bfdbfe;
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 4px rgba(37, 99, 235, 0.1);
        }

        .step-instruction {
            text-align: center;
            margin-bottom: 20px;
            color: #475569;
            font-size: 1rem;
            font-weight: 500;
            line-height: 1.4;
        }

        .step-number {
            background: var(--primary);
            color: white;
            width: 24px;
            height: 24px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            font-size: 0.85rem;
            margin-right: 8px;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(37, 99, 235, 0.3);
        }

        /* --- LAYOUT EN FILA (ROW WRAPPER) --- */
        .row-wrapper {
            display: flex;
            flex-direction: row;
            align-items: center; /* Alineaci√≥n por defecto para botones */
            justify-content: center;
            flex-wrap: wrap; 
            gap: 15px;
            width: 100%;
            margin-bottom: 1rem;
        }

        /* --- CORRECCI√ìN DE ALINEACI√ìN FASE 1 (FORMULACI√ìN) --- */
        /* Usamos flex-end para que los operadores se alineen con la base de los inputs */
        .reaction-container {
            display: flex;
            flex-wrap: wrap;
            align-items: flex-end; /* ESTO ES LO IMPORTANTE PARA QUE EL + NO SUBA */
            justify-content: center;
            gap: 5px; 
            padding: 0;
        }

        .compound-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: auto;
        }

        .compound-name {
            font-size: 0.8rem;
            color: #475569;
            margin-bottom: 5px;
            text-align: center;
            min-height: 30px;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            font-weight: 600;
            line-height: 1.1;
            max-width: 120px;
        }

        /* --- ESTILOS DE INPUTS --- */
        input {
            text-align: center;
            border: 2px solid var(--border);
            border-radius: 8px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-weight: 600;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        input[type="text"] {
            padding: 8px;
            font-size: 1.2rem;
            width: 110px;
            font-family: 'Noto Serif', serif;
            letter-spacing: 0px;
        }

        input[type="number"] {
            font-family: 'Noto Serif', serif;
            padding: 4px;
            font-size: 1.5rem;
            width: 55px;
            font-weight: 700;
            -moz-appearance: textfield;
            border-width: 2px;
        }
        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        /* Colores Espec√≠ficos */
        input[data-type="reactant"] {
            background: linear-gradient(to bottom, #ffffff, #f0f9ff);
            border-color: #bae6fd;
            color: #0369a1;
        }
        input[data-type="reactant"]:focus {
            outline: none;
            border-color: #0284c7;
            box-shadow: 0 0 0 3px rgba(2, 132, 199, 0.15);
            transform: translateY(-1px);
        }

        input[data-type="product"] {
            background: linear-gradient(to bottom, #ffffff, #fff7ed);
            border-color: #fed7aa;
            color: #c2410c;
        }
        input[data-type="product"]:focus {
            outline: none;
            border-color: #ea580c;
            box-shadow: 0 0 0 3px rgba(234, 88, 12, 0.15);
            transform: translateY(-1px);
        }

        input.correct {
            background: linear-gradient(to bottom, #f0fdf4, #dcfce7) !important;
            border-color: #16a34a !important;
            color: #15803d !important;
            box-shadow: none !important;
        }

        input.incorrect {
            background: linear-gradient(to bottom, #fef2f2, #fee2e2) !important;
            border-color: #dc2626 !important;
            animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both;
        }

        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }

        /* --- OPERADORES (Fase 1: Padding inferior ajustado para centrar con input) --- */
        .operator-plus {
            font-size: 1.8rem;
            font-weight: 900;
            color: #0f172a;
            margin: 0 4px;
            line-height: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding-bottom: 8px; /* Ajustado para alinear con el centro visual de la caja */
        }

        .operator-arrow {
            margin: 0 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding-bottom: 8px; /* Ajustado para alinear con el centro visual de la caja */
        }
        
        .arrow-svg {
            width: 35px;
            height: 20px;
            stroke: #0f172a;
            stroke-width: 4px;
            stroke-linecap: round;
            stroke-linejoin: round;
            fill: none;
        }

        /* --- FASE 2: AJUSTE --- */
        .balance-section {
            display: none;
            flex-direction: column;
            align-items: center;
            border-top: 2px dashed #e2e8f0;
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            animation: slideDown 0.6s cubic-bezier(0.16, 1, 0.3, 1);
            width: 100%;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* En la fase 2 usamos align-items: center porque no hay nombres encima */
        .balance-row {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            justify-content: center;
            gap: 5px;
            background-color: transparent;
            border: none;
            padding: 0;
            box-shadow: none;
        }

        /* En Fase 2 los operadores no necesitan el padding extra inferior porque align-items es center */
        .balance-row .operator-plus, 
        .balance-row .operator-arrow {
            padding-bottom: 0;
        }

        .compound-display {
            font-family: 'Noto Serif', serif;
            font-size: 1.5rem;
            color: #334155;
            font-weight: 500;
            margin-left: 2px;
        }

        /* Botones */
        .actions {
            margin-top: 1rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
            width: 100%;
        }

        .btn {
            background: linear-gradient(to bottom, #2563eb, #1d4ed8);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 700;
            transition: all 0.2s;
            box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.3), 0 2px 4px -1px rgba(37, 99, 235, 0.2);
            display: inline-flex;
            align-items: center;
            gap: 6px;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
            flex-shrink: 0;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(37, 99, 235, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-next {
            background: linear-gradient(to bottom, #16a34a, #15803d);
            box-shadow: 0 4px 6px -1px rgba(22, 163, 74, 0.3);
        }

        .feedback-wrapper {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: 10px;
        }

        .feedback-msg {
            text-align: center;
            font-weight: 600;
            padding: 10px 15px;
            border-radius: 10px;
            width: 100%;
            max-width: 600px;
            font-size: 0.9rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .hint-box {
            background-color: #fffbeb;
            border: 1px solid #fcd34d;
            border-left: 5px solid #f59e0b;
            color: #92400e;
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            display: none;
            text-align: left;
            font-weight: 500;
            animation: fadeIn 0.3s;
            max-width: 600px;
            font-size: 0.9rem;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .feedback-success { color: #14532d; background: #dcfce7; border: 1px solid #86efac; }
        .feedback-error { color: #7f1d1d; background: #fee2e2; border: 1px solid #fca5a5; }
        .feedback-info { color: #1e3a8a; background: #dbeafe; border: 1px solid #93c5fd; }

        /* Footer */
        .footer-credits {
            position: absolute;
            bottom: 1rem;
            left: 0;
            right: 0;
            text-align: center;
            font-size: 0.75rem;
            color: #64748b;
            padding: 0 1rem;
            font-weight: 500;
        }
        .credits-name {
            font-weight: 700;
            color: inherit;
        }

        /* Modal para fin del juego y alertas */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(4px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px; 
        }
        
        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 20px;
            text-align: center;
            max-width: 450px;
            width: 100%;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            border: 1px solid #e2e8f0;
        }

        @media (max-width: 480px) {
            h1 { font-size: 1.3rem; margin-bottom: 1rem; }
            .header-stats { padding: 0.6rem 1rem; }
            .stat-value { font-size: 1.5rem; }
            .exercise-card { padding: 1.2rem; }
            input[type="text"] { width: 95px; font-size: 1.1rem; }
            input[type="number"] { width: 45px; font-size: 1.3rem; }
            .compound-display { font-size: 1.3rem; }
            .operator-plus { font-size: 1.5rem; margin: 0 2px; padding-bottom: 6px;} /* Ajuste m√≥vil */
            .operator-arrow { margin: 0 5px; padding-bottom: 6px; }
            .arrow-svg { width: 25px; height: 18px; stroke-width: 3px; }
            .btn { width: 100%; justify-content: center; } 
            .row-wrapper { gap: 10px; justify-content: center; }
        }

    </style>
</head>
<body>

<!-- PANTALLA INICIAL (LANDING) -->
<div id="landing-screen">
    <div class="landing-content">
        <div class="landing-title">Laboratorio de Estequiometr√≠a</div>
        <div class="landing-text">
            Bienvenido al entrenador virtual de qu√≠mica. En este m√≥dulo aprender√°s a formular compuestos y ajustar ecuaciones qu√≠micas de forma interactiva.
        </div>

        <div class="rotate-hint-container">
            <div class="phone-icon"></div>
            <div class="rotate-text">Gira tu m√≥vil a horizontal</div>
            <div style="font-size: 0.85rem; color: #64748b; margin-top:5px;">(Mejor experiencia en apaisado)</div>
        </div>

        <button class="btn-start" onclick="startApp()">Entrar al Laboratorio</button>
    </div>

    <!-- Cr√©ditos Footer en Landing -->
    <div class="footer-credits">
        Realizado por <span class="credits-name">Javier Gij√≥n</span>. Prof. del IES Mar√≠a Moliner (Segovia).
    </div>
</div>

<!-- PANTALLA DE NIVEL (RESULTADOS) -->
<div id="level-screen">
    <div class="level-card">
        <div id="medal-display" class="medal-icon">ü•á</div>
        <div id="level-title" class="level-title">Nivel: Maestro</div>
        <div id="level-subtitle" class="level-subtitle">¬°Impresionante desempe√±o!</div>
        
        <div class="level-stats">
            <div class="stat-row">
                <span>Reacciones completadas:</span>
                <strong id="final-stats-count">0</strong>
            </div>
            <div class="stat-row">
                <span>Puntuaci√≥n de precisi√≥n:</span>
                <strong id="final-stats-percent">0%</strong>
            </div>
        </div>

        <button class="btn-start" onclick="resetGame()">Volver al Inicio</button>
    </div>
    
    <!-- Cr√©ditos Footer en Nivel -->
    <div class="footer-credits">
        Realizado por <span class="credits-name">Javier Gij√≥n</span>. Prof. del IES Mar√≠a Moliner (Segovia).
    </div>
</div>

<!-- APLICACI√ìN PRINCIPAL -->
<div id="app-container" class="container">
    <h1>Laboratorio de Estequiometr√≠a</h1>
    
    <div class="header-stats">
        <div class="stat-box">
            <span class="stat-label">Progreso</span>
            <span class="stat-value"><span id="current-ex">1</span>/40</span>
        </div>
        <div class="stat-box">
            <span class="stat-label">Aciertos</span>
            <span class="stat-value" id="score">0</span>
        </div>
    </div>

    <div class="exercise-card">
        <div style="text-align: center;">
            <span id="reaction-type" class="tag-type">Cargando...</span>
        </div>

        <!-- PASO 1: FORMULACI√ìN -->
        <div>
            <p class="step-instruction">
                <span class="step-number">1</span> Escribe la f√≥rmula qu√≠mica (los n√∫meros se convierten en sub√≠ndices):
            </p>

            <!-- LAYOUT EN FILA (REACCI√ìN + BOT√ìN) -->
            <div class="row-wrapper">
                <div id="formula-area" class="reaction-container">
                    <!-- Se llena din√°micamente con JS -->
                </div>
                
                <!-- Bot√≥n Verificar -->
                <button id="btn-check-formula" class="btn" onclick="checkFormulas()">
                    Verificar
                </button>
            </div>

            <!-- Feedback debajo -->
            <div class="feedback-wrapper">
                <div id="hint-formula" class="hint-box"></div>
                <div id="feedback-formula" class="feedback-msg" style="display:none;"></div>
            </div>
        </div>

        <!-- PASO 2: AJUSTE (Oculto al inicio) -->
        <div id="balance-container" class="balance-section">
            <p class="step-instruction">
                <span class="step-number">2</span> Ajusta la reacci√≥n (usa 1 si no es necesario coeficiente):
            </p>
            
            <!-- LAYOUT EN FILA (AJUSTE + BOT√ìN) -->
            <div class="row-wrapper">
                <div id="balance-area" class="balance-row">
                    <!-- Se llena din√°micamente -->
                </div>
                
                <!-- Botones integrados -->
                <button id="btn-check-balance" class="btn" onclick="checkBalance()">Verificar</button>
                <button id="btn-next" class="btn btn-next" style="display:none;" onclick="nextExercise()">Siguiente</button>
            </div>

            <div class="feedback-wrapper">
                <div id="feedback-balance" class="feedback-msg" style="display:none;"></div>
            </div>
        </div>

        <!-- Bot√≥n de Abandono -->
        <button class="btn-abandon" onclick="showLevelScreen()">
            <svg viewBox="0 0 24 24"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4M16 17l5-5-5-5M21 12H9" stroke-linecap="round" stroke-linejoin="round"></path></svg>
            Abandonar y Ver Nivel
        </button>
    </div>

    <!-- Cr√©ditos Footer en App -->
    <div class="footer-credits">
        Realizado por <span class="credits-name">Javier Gij√≥n</span>. Prof. del IES Mar√≠a Moliner (Segovia).
    </div>
</div>

<!-- Modal de Advertencia (Abandono prematuro) -->
<div id="warning-modal" class="modal-overlay">
    <div class="modal-content">
        <h2 style="color: #f59e0b; font-size: 1.5rem; margin-bottom: 1rem;">‚ö†Ô∏è Atenci√≥n</h2>
        <p style="color: #334155; font-size: 1rem; margin-bottom: 1.5rem;">
            Necesitas completar al menos <strong>3 reacciones</strong> correctamente para calcular tu nivel con precisi√≥n.
        </p>
        <p style="color: #64748b; margin-bottom: 1.5rem; font-size: 0.95rem;">
            Llevas: <strong id="warning-score" style="color: #2563eb;">0</strong> / 3
        </p>
        <button class="btn" style="width:100%" onclick="closeWarningModal()">Seguir Practicando</button>
    </div>
</div>

<!-- Modal de Finalizaci√≥n -->
<div id="completion-modal" class="modal-overlay">
    <div class="modal-content">
        <h2 style="color: var(--primary); font-size: 1.8rem; margin-bottom: 1rem;">¬°Enhorabuena!</h2>
        <p style="color: #64748b; font-size: 1rem; margin-bottom: 1.5rem;">Has completado el ciclo de reacciones qu√≠micas.</p>
        <p style="margin-bottom: 1.5rem;">Tu puntuaci√≥n final es: <strong id="final-score" style="font-size:1.8rem; color: #0f172a;"></strong></p>
        <button class="btn" style="width:100%" onclick="showLevelScreen()">Ver Nivel</button>
    </div>
</div>

<script>
    // --- FUNCI√ìN PARA INICIAR LA APP ---
    function startApp() {
        const landing = document.getElementById('landing-screen');
        const app = document.getElementById('app-container');
        
        landing.style.opacity = '0';
        
        setTimeout(() => {
            landing.style.display = 'none';
            app.style.display = 'block';
        }, 500);
    }

    // --- MAPA DE SUB√çNDICES PARA FORMULACI√ìN DIRECTA ---
    const SUB_MAP = {
        '0': '‚ÇÄ', '1': '‚ÇÅ', '2': '‚ÇÇ', '3': '‚ÇÉ', '4': '‚ÇÑ',
        '5': '‚ÇÖ', '6': '‚ÇÜ', '7': '‚Çá', '8': '‚Çà', '9': '‚Çâ'
    };
    
    // Mapa inverso para validaci√≥n (convertir ‚ÇÇ -> 2)
    const NORM_MAP = Object.fromEntries(Object.entries(SUB_MAP).map(a => a.reverse()));

    // --- BASE DE DATOS DE REACCIONES (40) ---
    // hint: Pista espec√≠fica que se usar√° como base para el primer intento o fallback.
    const database = [
        // S√çNTESIS
        { type: "S√≠ntesis", r_names: ["Hidr√≥geno", "Ox√≠geno"], p_names: ["Agua"], r_forms: ["H2", "O2"], p_forms: ["H2O"], r_coef: [2, 1], p_coef: [2], hint: "El agua est√° formada por hidr√≥geno y ox√≠geno." },
        { type: "S√≠ntesis", r_names: ["Nitr√≥geno", "Hidr√≥geno"], p_names: ["Amon√≠aco"], r_forms: ["N2", "H2"], p_forms: ["NH3"], r_coef: [1, 3], p_coef: [2], hint: "El nitr√≥geno act√∫a con valencia 3 y el hidr√≥geno con 1." },
        { type: "S√≠ntesis", r_names: ["Sodio", "Cloro"], p_names: ["Cloruro de sodio"], r_forms: ["Na", "Cl2"], p_forms: ["NaCl"], r_coef: [2, 1], p_coef: [2], hint: "Es la sal com√∫n. Sodio (valencia 1) y Cloro (valencia 1)." },
        { type: "S√≠ntesis", r_names: ["Hierro", "Ox√≠geno"], p_names: ["√ìxido de hierro(III)"], r_forms: ["Fe", "O2"], p_forms: ["Fe2O3"], r_coef: [4, 3], p_coef: [2], hint: "El hierro act√∫a con valencia 3 y el ox√≠geno con 2." },
        { type: "S√≠ntesis", r_names: ["√ìxido de calcio", "Agua"], p_names: ["Hidr√≥xido de calcio"], r_forms: ["CaO", "H2O"], p_forms: ["Ca(OH)2"], r_coef: [1, 1], p_coef: [1], hint: "El calcio tiene valencia 2." },
        { type: "S√≠ntesis", r_names: ["Tri√≥xido de azufre", "Agua"], p_names: ["√Åcido sulf√∫rico"], r_forms: ["SO3", "H2O"], p_forms: ["H2SO4"], r_coef: [1, 1], p_coef: [1], hint: "Suma todos los √°tomos de los reactivos." },

        // DESCOMOSICI√ìN
        { type: "Descomposici√≥n", r_names: ["Carbonato de calcio"], p_names: ["√ìxido de calcio", "Di√≥xido de carbono"], r_forms: ["CaCO3"], p_forms: ["CaO", "CO2"], r_coef: [1], p_coef: [1, 1], hint: "El ion carbonato es CO‚ÇÉ." },
        { type: "Descomposici√≥n", r_names: ["Clorato de potasio"], p_names: ["Cloruro de potasio", "Ox√≠geno"], r_forms: ["KClO3"], p_forms: ["KCl", "O2"], r_coef: [2], p_coef: [2, 3], hint: "El potasio es K, el cloro Cl y el ox√≠geno O." },
        { type: "Descomposici√≥n", r_names: ["Per√≥xido de hidr√≥geno"], p_names: ["Agua", "Ox√≠geno"], r_forms: ["H2O2"], p_forms: ["H2O", "O2"], r_coef: [2], p_coef: [2, 1], hint: "El agua oxigenada tiene un ox√≠geno m√°s que el agua normal." },
        { type: "Descomposici√≥n T√©rmica", r_names: ["√ìxido de mercurio(II)"], p_names: ["Mercurio", "Ox√≠geno"], r_forms: ["HgO"], p_forms: ["Hg", "O2"], r_coef: [2], p_coef: [2, 1], hint: "Mercurio(II) significa valencia 2." },

        // COMBUSTI√ìN
        { type: "Combusti√≥n", r_names: ["Metano", "Ox√≠geno"], p_names: ["Di√≥xido de carbono", "Agua"], r_forms: ["CH4", "O2"], p_forms: ["CO2", "H2O"], r_coef: [1, 2], p_coef: [1, 2], hint: "Metano: 1 carbono y 4 hidr√≥genos." },
        { type: "Combusti√≥n", r_names: ["Propano", "Ox√≠geno"], p_names: ["Di√≥xido de carbono", "Agua"], r_forms: ["C3H8", "O2"], p_forms: ["CO2", "H2O"], r_coef: [1, 5], p_coef: [3, 4], hint: "Propano: prefijo prop- significa 3 carbonos." },
        { type: "Combusti√≥n", r_names: ["Butano", "Ox√≠geno"], p_names: ["Di√≥xido de carbono", "Agua"], r_forms: ["C4H10", "O2"], p_forms: ["CO2", "H2O"], r_coef: [2, 13], p_coef: [8, 10], hint: "Butano: prefijo but- significa 4 carbonos." },
        { type: "Combusti√≥n", r_names: ["Etanol", "Ox√≠geno"], p_names: ["Di√≥xido de carbono", "Agua"], r_forms: ["C2H5OH", "O2"], p_forms: ["CO2", "H2O"], r_coef: [1, 3], p_coef: [2, 3], hint: "El alcohol et√≠lico tiene 2 carbonos." },
        { type: "Combusti√≥n", r_names: ["Carbono", "Ox√≠geno"], p_names: ["Di√≥xido de carbono"], r_forms: ["C", "O2"], p_forms: ["CO2"], r_coef: [1, 1], p_coef: [1], hint: "Un √°tomo de carbono y dos de ox√≠geno." },
        { type: "Combusti√≥n (Azufre)", r_names: ["Sulfuro de zinc", "Ox√≠geno"], p_names: ["√ìxido de zinc", "Di√≥xido de azufre"], r_forms: ["ZnS", "O2"], p_forms: ["ZnO", "SO2"], r_coef: [2, 3], p_coef: [2, 2], hint: "El zinc siempre act√∫a con valencia 2." },

        // √ÅCIDO-BASE / NEUTRALIZACI√ìN
        { type: "Neutralizaci√≥n", r_names: ["√Åcido clorh√≠drico", "Hidr√≥xido de sodio"], p_names: ["Cloruro de sodio", "Agua"], r_forms: ["HCl", "NaOH"], p_forms: ["NaCl", "H2O"], r_coef: [1, 1], p_coef: [1, 1], hint: "√Åcido clorh√≠drico es HCl." },
        { type: "Neutralizaci√≥n", r_names: ["√Åcido sulf√∫rico", "Hidr√≥xido de potasio"], p_names: ["Sulfato de potasio", "Agua"], r_forms: ["H2SO4", "KOH"], p_forms: ["K2SO4", "H2O"], r_coef: [1, 2], p_coef: [1, 2], hint: "El potasio tiene valencia 1 y el sulfato carga -2." },
        { type: "Neutralizaci√≥n", r_names: ["√Åcido n√≠trico", "Hidr√≥xido de calcio"], p_names: ["Nitrato de calcio", "Agua"], r_forms: ["HNO3", "Ca(OH)2"], p_forms: ["Ca(NO3)2", "H2O"], r_coef: [2, 1], p_coef: [1, 2], hint: "El nitrato tiene carga -1 y el calcio valencia +2." },
        { type: "Neutralizaci√≥n", r_names: ["√Åcido fosf√≥rico", "Hidr√≥xido de sodio"], p_names: ["Fosfato de sodio", "Agua"], r_forms: ["H3PO4", "NaOH"], p_forms: ["Na3PO4", "H2O"], r_coef: [1, 3], p_coef: [1, 3], hint: "El f√≥sforo en √°cido fosf√≥rico act√∫a con valencia 5." },

        // DESPLAZAMIENTO SIMPLE
        { type: "Desplazamiento Simple", r_names: ["Zinc", "√Åcido clorh√≠drico"], p_names: ["Cloruro de zinc", "Hidr√≥geno"], r_forms: ["Zn", "HCl"], p_forms: ["ZnCl2", "H2"], r_coef: [1, 2], p_coef: [1, 1], hint: "El zinc desplaza al hidr√≥geno del √°cido." },
        { type: "Desplazamiento Simple", r_names: ["Hierro", "Sulfato de cobre(II)"], p_names: ["Sulfato de hierro(II)", "Cobre"], r_forms: ["Fe", "CuSO4"], p_forms: ["FeSO4", "Cu"], r_coef: [1, 1], p_coef: [1, 1], hint: "El hierro act√∫a con valencia 2 en este caso." },
        { type: "Desplazamiento Simple", r_names: ["Aluminio", "√Åcido clorh√≠drico"], p_names: ["Cloruro de aluminio", "Hidr√≥geno"], r_forms: ["Al", "HCl"], p_forms: ["AlCl3", "H2"], r_coef: [2, 6], p_coef: [2, 3], hint: "El aluminio tiene valencia 3." },
        { type: "Desplazamiento Simple", r_names: ["Cloro", "Bromuro de potasio"], p_names: ["Cloruro de potasio", "Bromo"], r_forms: ["Cl2", "KBr"], p_forms: ["KCl", "Br2"], r_coef: [1, 2], p_coef: [2, 1], hint: "El cloro es m√°s reactivo que el bromo." },

        // DOBLE DESPLAZAMIENTO / PRECIPITACI√ìN
        { type: "Precipitaci√≥n", r_names: ["Nitrato de plata", "Cloruro de sodio"], p_names: ["Cloruro de plata", "Nitrato de sodio"], r_forms: ["AgNO3", "NaCl"], p_forms: ["AgCl", "NaNO3"], r_coef: [1, 1], p_coef: [1, 1], hint: "La plata act√∫a con valencia 1." },
        { type: "Precipitaci√≥n", r_names: ["Cloruro de bario", "Sulfato de sodio"], p_names: ["Sulfato de bario", "Cloruro de sodio"], r_forms: ["BaCl2", "Na2SO4"], p_forms: ["BaSO4", "NaCl"], r_coef: [1, 1], p_coef: [1, 2], hint: "El bario tiene valencia 2." },
        { type: "Doble Desplazamiento", r_names: ["Sulfuro de hierro(II)", "√Åcido clorh√≠drico"], p_names: ["Cloruro de hierro(II)", "√Åcido sulfh√≠drico"], r_forms: ["FeS", "HCl"], p_forms: ["FeCl2", "H2S"], r_coef: [1, 2], p_coef: [1, 1], hint: "El azufre act√∫a con valencia -2." },
        { type: "Doble Desplazamiento", r_names: ["Carbonato de sodio", "√Åcido clorh√≠drico"], p_names: ["Cloruro de sodio", "Di√≥xido de carbono", "Agua"], r_forms: ["Na2CO3", "HCl"], p_forms: ["NaCl", "CO2", "H2O"], r_coef: [1, 2], p_coef: [2, 1, 1], hint: "El sodio tiene valencia 1." },
        
        // REDOX SIMPLE
        { type: "Redox Simple", r_names: ["Mon√≥xido de carbono", "√ìxido de hierro(III)"], p_names: ["Hierro", "Di√≥xido de carbono"], r_forms: ["CO", "Fe2O3"], p_forms: ["Fe", "CO2"], r_coef: [3, 1], p_coef: [2, 3], hint: "Mon√≥xido es CO, Di√≥xido es CO‚ÇÇ." },
        { type: "S√≠ntesis / Redox", r_names: ["Cobre", "Ox√≠geno"], p_names: ["√ìxido de cobre(II)"], r_forms: ["Cu", "O2"], p_forms: ["CuO"], r_coef: [2, 1], p_coef: [2], hint: "Cobre valencia 2, Ox√≠geno valencia 2. Se simplifican." },

        // --- NUEVAS REACCIONES (HCl, NaOH, Oxidaci√≥n) ---
        { type: "Desplazamiento Simple", r_names: ["Magnesio", "√Åcido clorh√≠drico"], p_names: ["Cloruro de magnesio", "Hidr√≥geno"], r_forms: ["Mg", "HCl"], p_forms: ["MgCl2", "H2"], r_coef: [1, 2], p_coef: [1, 1], hint: "El magnesio tiene valencia 2." },
        { type: "Desplazamiento Simple", r_names: ["Aluminio", "√Åcido clorh√≠drico"], p_names: ["Cloruro de aluminio", "Hidr√≥geno"], r_forms: ["Al", "HCl"], p_forms: ["AlCl3", "H2"], r_coef: [2, 6], p_coef: [2, 3], hint: "El aluminio tiene valencia 3." },
        { type: "Neutralizaci√≥n", r_names: ["√ìxido de zinc", "√Åcido clorh√≠drico"], p_names: ["Cloruro de zinc", "Agua"], r_forms: ["ZnO", "HCl"], p_forms: ["ZnCl2", "H2O"], r_coef: [1, 2], p_coef: [1, 1], hint: "El zinc tiene valencia 2." },
        { type: "Descomposici√≥n √Åcida", r_names: ["Carbonato de calcio", "√Åcido clorh√≠drico"], p_names: ["Cloruro de calcio", "Di√≥xido de carbono", "Agua"], r_forms: ["CaCO3", "HCl"], p_forms: ["CaCl2", "CO2", "H2O"], r_coef: [1, 2], p_coef: [1, 1, 1], hint: "Calcio tiene valencia 2." },
        { type: "Precipitaci√≥n", r_names: ["Cloruro de hierro(III)", "Hidr√≥xido de sodio"], p_names: ["Hidr√≥xido de hierro(III)", "Cloruro de sodio"], r_forms: ["FeCl3", "NaOH"], p_forms: ["Fe(OH)3", "NaCl"], r_coef: [1, 3], p_coef: [1, 3], hint: "El hierro(III) usa valencia 3." },
        { type: "Precipitaci√≥n", r_names: ["Sulfato de cobre(II)", "Hidr√≥xido de sodio"], p_names: ["Hidr√≥xido de cobre(II)", "Sulfato de sodio"], r_forms: ["CuSO4", "NaOH"], p_forms: ["Cu(OH)2", "Na2SO4"], r_coef: [1, 2], p_coef: [1, 1], hint: "El cobre(II) usa valencia 2." },
        { type: "Desplazamiento", r_names: ["Cloruro de amonio", "Hidr√≥xido de sodio"], p_names: ["Cloruro de sodio", "Amon√≠aco", "Agua"], r_forms: ["NH4Cl", "NaOH"], p_forms: ["NaCl", "NH3", "H2O"], r_coef: [1, 1], p_coef: [1, 1, 1], hint: "El amonio es NH‚ÇÑ‚Å∫." },
        { type: "Oxidaci√≥n", r_names: ["Aluminio", "Ox√≠geno"], p_names: ["√ìxido de aluminio"], r_forms: ["Al", "O2"], p_forms: ["Al2O3"], r_coef: [4, 3], p_coef: [2], hint: "Aluminio (valencia 3) y Ox√≠geno (valencia 2)." },
        { type: "Oxidaci√≥n", r_names: ["Magnesio", "Ox√≠geno"], p_names: ["√ìxido de magnesio"], r_forms: ["Mg", "O2"], p_forms: ["MgO"], r_coef: [2, 1], p_coef: [2], hint: "Magnesio (valencia 2) y Ox√≠geno (valencia 2)." },
        { type: "Oxidaci√≥n", r_names: ["Litio", "Ox√≠geno"], p_names: ["√ìxido de litio"], r_forms: ["Li", "O2"], p_forms: ["Li2O"], r_coef: [4, 1], p_coef: [2], hint: "El litio tiene valencia 1." }
    ];

    let currentIdx = 0;
    let currentData = {};
    let score = 0;
    let mistakes = 0; // New tracking for level
    let currentAttempts = 0; // Contador de intentos fallidos por ejercicio
    let exerciseOrder = [];

    // Inicializar
    document.addEventListener('DOMContentLoaded', () => {
        generateRandomOrder();
        loadExercise(0);
    });
    
    function generateRandomOrder() {
        exerciseOrder = Array.from({length: database.length}, (_, i) => i);
        for (let i = exerciseOrder.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [exerciseOrder[i], exerciseOrder[j]] = [exerciseOrder[j], exerciseOrder[i]];
        }
    }

    function loadExercise(index) {
        currentIdx = index;
        const dbIndex = exerciseOrder[index];
        currentData = database[dbIndex];
        
        // Resetear variables de estado
        currentAttempts = 0;
        
        // Resetear UI
        document.getElementById('current-ex').innerText = index + 1;
        document.getElementById('reaction-type').innerText = currentData.type;
        document.getElementById('formula-area').innerHTML = '';
        
        document.getElementById('balance-container').style.display = 'none';
        
        // Mostrar bot√≥n de verificar f√≥rmula y ocultar el de balance al inicio
        document.getElementById('btn-check-formula').style.display = 'inline-flex';
        document.getElementById('btn-check-formula').parentElement.style.display = 'inline-flex'; // Asegurar que wrapper es visible
        
        // Resetear mensajes
        hideFeedback('feedback-formula');
        hideFeedback('feedback-balance');
        document.getElementById('hint-formula').style.display = 'none';
        document.getElementById('hint-formula').innerText = '';

        // Construir Inputs de F√≥rmulas
        const container = document.getElementById('formula-area');
        
        currentData.r_names.forEach((name, i) => {
            if(i > 0) addOperator(container, '+');
            addFormulaInput(container, name, 'reactant', i);
        });

        addOperator(container, '‚Üí');

        currentData.p_names.forEach((name, i) => {
            if(i > 0) addOperator(container, '+');
            addFormulaInput(container, name, 'product', i);
        });
    }

    function addFormulaInput(container, name, type, index) {
        const group = document.createElement('div');
        group.className = 'compound-group';

        const label = document.createElement('div');
        label.className = 'compound-name';
        label.innerText = name;

        const input = document.createElement('input');
        input.type = 'text';
        input.dataset.type = type;
        input.dataset.index = index;
        input.placeholder = "F√≥rmula";
        input.autocomplete = "off";
        
        input.addEventListener('input', function() {
            const start = this.selectionStart;
            const end = this.selectionEnd;
            const oldVal = this.value;
            const newVal = oldVal.replace(/[0-9]/g, match => SUB_MAP[match] || match);
            
            if (oldVal !== newVal) {
                this.value = newVal;
                this.setSelectionRange(start, end); 
            }
            
            this.classList.remove('incorrect', 'correct');
        });

        input.addEventListener("keypress", function(event) {
            if (event.key === "Enter") {
                event.preventDefault();
                checkFormulas();
            }
        });
        
        group.appendChild(label);
        group.appendChild(input);
        container.appendChild(group);
    }

    function addOperator(container, symbol) {
        const op = document.createElement('div');
        if (symbol === '‚Üí') {
            op.className = 'operator-arrow';
            // SVG de la flecha con grosor ajustable
            op.innerHTML = `<svg class="arrow-svg" viewBox="0 0 50 30">
                <line x1="2" y1="15" x2="45" y2="15"></line>
                <polyline points="35 5 45 15 35 25"></polyline>
            </svg>`;
        } else {
            op.className = 'operator-plus';
            op.innerText = symbol;
        }
        container.appendChild(op);
    }

    // --- NUEVA L√ìGICA DE PISTAS ESPEC√çFICAS ---
    function getErrorHint(userVal, correctVal, attempt, dbHint) {
        const u = userVal;
        const c = correctVal;

        // 1. Error de gas diat√≥mico (usuario pone O, H, N... y debe ser O2, H2...)
        const diatomics = ["H2", "N2", "O2", "F2", "Cl2", "Br2", "I2"];
        // Eliminamos n√∫meros de la correcta para ver el s√≠mbolo base
        const strippedC = c.replace(/\d+/g, ''); 
        
        // Si la correcta es diat√≥mica y el usuario puso el s√≠mbolo sin el 2
        if (diatomics.includes(c) && u === strippedC) {
            if (attempt === 1) return `Recuerda: El ${strippedC} en la naturaleza se encuentra en estado gaseoso.`;
            return `¬°Ojo! Los gases elementales son diat√≥micos (su mol√©cula lleva un sub√≠ndice 2).`;
        }

        // 2. Falta de par√©ntesis en iones poliat√≥micos
        if (c.includes('(') && !u.includes('(')) {
            if (attempt === 1) return "Hay un grupo de √°tomos que funciona como un bloque (ion poliat√≥mico) y se repite.";
            return "Necesitas usar par√©ntesis para agrupar elementos. Ejemplo: Ca(OH)‚ÇÇ";
        }

        // 3. Error de may√∫sculas/min√∫sculas (ej: Co vs CO)
        // Comparamos min√∫sculas para ver si son las mismas letras pero mal escritas
        if (u.toLowerCase() === c.toLowerCase() && u !== c) {
            return "Revisa las may√∫sculas y min√∫sculas. Los s√≠mbolos qu√≠micos distinguen entre elementos (ej: Co es cobalto, CO es mon√≥xido).";
        }
        
        // 4. Error gen√©rico de valencias/sub√≠ndices
        // Si es el primer intento, damos la pista de la base de datos (contextual)
        if (attempt === 1) {
            return dbHint ? "Pista: " + dbHint : "Revisa las valencias de los elementos.";
        }
        
        // Si es el segundo intento, damos pista m√°s t√©cnica
        if (attempt === 2) {
            return "Revisa los sub√≠ndices. ¬øHas intercambiado las valencias correctamente? ¬øSe pueden simplificar?";
        }

        // Fallback
        return "La f√≥rmula no coincide. Revisa el nombre del compuesto.";
    }

    // --- VERIFICAR F√ìRMULAS ---
    function checkFormulas() {
        const inputs = document.querySelectorAll('#formula-area input');
        let allCorrect = true;
        let firstErrorInput = null;
        let firstErrorCorrectVal = null;

        inputs.forEach(input => {
            const type = input.dataset.type;
            const idx = parseInt(input.dataset.index);
            const rawValue = input.value.trim();
            // Normalizar (convertir ‚ÇÇ -> 2) para comparar
            const normalizedVal = rawValue.split('').map(char => NORM_MAP[char] || char).join('');
            
            const correctVal = type === 'reactant' 
                ? currentData.r_forms[idx] 
                : currentData.p_forms[idx];

            if (normalizedVal === correctVal) {
                input.classList.add('correct');
                input.classList.remove('incorrect');
                input.disabled = true; 
            } else {
                input.classList.add('incorrect');
                input.classList.remove('correct');
                allCorrect = false;
                // Guardamos el primer error para generar la pista sobre √©l
                if (!firstErrorInput) {
                    firstErrorInput = normalizedVal; // Usamos el valor normalizado para l√≥gica
                    firstErrorCorrectVal = correctVal;
                }
            }
        });

        const feedback = document.getElementById('feedback-formula');
        const hintBox = document.getElementById('hint-formula');
        
        if (allCorrect) {
            feedback.style.display = 'block';
            feedback.innerText = "¬°F√≥rmulas correctas! Ahora ajusta los coeficientes.";
            feedback.className = "feedback-msg feedback-success";
            hintBox.style.display = 'none';
            // Ocultar bot√≥n verificar f√≥rmula al acertar
            document.getElementById('btn-check-formula').style.display = 'none';
            initBalancePhase();
        } else {
            // Manejo de ERRORES e INTENTOS
            currentAttempts++;
            mistakes++; // Incrementa errores globales
            
            feedback.style.display = 'block';
            feedback.className = "feedback-msg feedback-error";
            
            if (currentAttempts < 3) {
                feedback.innerText = `Incorrecto (Intento ${currentAttempts}/3).`;
                
                // GENERAR PISTA INTELIGENTE
                hintBox.style.display = 'block';
                const specificHint = getErrorHint(firstErrorInput, firstErrorCorrectVal, currentAttempts, currentData.hint);
                hintBox.innerText = specificHint;

            } else {
                // TERCER FALLO: Resolver autom√°ticamente
                feedback.innerText = "Se han agotado los intentos. Soluci√≥n aplicada autom√°ticamente.";
                feedback.className = "feedback-msg feedback-info";
                hintBox.style.display = 'none';
                solveFormulasAndProceed();
            }
        }
    }

    function solveFormulasAndProceed() {
        const inputs = document.querySelectorAll('#formula-area input');
        inputs.forEach(input => {
            const type = input.dataset.type;
            const idx = parseInt(input.dataset.index);
            const correctVal = type === 'reactant' 
                ? currentData.r_forms[idx] 
                : currentData.p_forms[idx];
            
            // Mostrar valor correcto con sub√≠ndices
            input.value = correctVal.replace(/(\d)/g, d => SUB_MAP[d]);
            input.classList.remove('incorrect');
            input.classList.add('correct');
            input.disabled = true;
        });
        document.getElementById('btn-check-formula').style.display = 'none';
        
        // Peque√±a pausa antes de mostrar la fase 2
        setTimeout(() => {
            initBalancePhase();
        }, 1500);
    }

    // --- FASE DE AJUSTE ---
    function initBalancePhase() {
        const balContainer = document.getElementById('balance-area');
        balContainer.innerHTML = '';
        
        // REINICIAR CONTADOR DE INTENTOS PARA LA FASE DE AJUSTE
        currentAttempts = 0;
        
        const balanceSection = document.getElementById('balance-container');
        balanceSection.style.display = 'flex';
        
        setTimeout(() => {
            balanceSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }, 100);

        document.getElementById('btn-next').style.display = 'none';
        document.getElementById('btn-check-balance').style.display = 'inline-flex';
        
        hideFeedback('feedback-balance');

        currentData.r_forms.forEach((form, i) => {
            if(i > 0) addOperator(balContainer, '+');
            addBalanceGroup(balContainer, form, 'reactant', i);
        });

        addOperator(balContainer, '‚Üí');

        currentData.p_forms.forEach((form, i) => {
            if(i > 0) addOperator(balContainer, '+');
            addBalanceGroup(balContainer, form, 'product', i);
        });
    }

    function addBalanceGroup(container, formula, type, index) {
        const group = document.createElement('div');
        group.className = 'compound-group';
        group.style.flexDirection = 'row';
        group.style.alignItems = 'center';
        group.style.gap = '8px';

        const input = document.createElement('input');
        input.type = 'number';
        input.min = '1';
        input.dataset.type = type;
        input.dataset.index = index;
        input.placeholder = "1";
        
        input.addEventListener("keypress", function(event) {
            if (event.key === "Enter") {
                event.preventDefault();
                checkBalance();
            }
        });

        const display = document.createElement('div');
        display.className = 'compound-display';
        display.innerHTML = formula.replace(/(\d+)/g, '<sub>$1</sub>');

        group.appendChild(input);
        group.appendChild(display);
        container.appendChild(group);
    }

    function checkBalance() {
        const inputs = document.querySelectorAll('#balance-area input');
        
        // 1. Recopilar valores del usuario y valores base para verificar proporcionalidad
        let userValues = [];
        let baseValues = [];
        
        inputs.forEach(input => {
            const type = input.dataset.type;
            const idx = parseInt(input.dataset.index);
            let userVal = parseFloat(input.value); 
            
            // Si el campo est√° vac√≠o o es <= 0, asumimos 1 para el c√°lculo
            if (isNaN(userVal) || userVal <= 0) userVal = 1;

            const correctVal = type === 'reactant' 
                ? currentData.r_coef[idx] 
                : currentData.p_coef[idx];
            
            userValues.push(userVal);
            baseValues.push(correctVal);
        });

        // 2. Verificar si todos mantienen la misma proporci√≥n (userVal / baseVal = constante)
        let ratio = userValues[0] / baseValues[0];
        let allProportional = true;
        const epsilon = 0.0001; // Tolerancia para punto flotante

        for (let i = 1; i < userValues.length; i++) {
            let currentRatio = userValues[i] / baseValues[i];
            if (Math.abs(currentRatio - ratio) > epsilon) {
                allProportional = false;
                break;
            }
        }

        const feedback = document.getElementById('feedback-balance');
        feedback.style.display = 'block';

        if (allProportional) {
            // ACIERTO
            inputs.forEach(input => {
                input.classList.add('correct');
                input.classList.remove('incorrect');
                input.disabled = true;
            });

            feedback.innerText = "¬°Excelente! Reacci√≥n ajustada.";
            feedback.className = "feedback-msg feedback-success";
            document.getElementById('btn-check-balance').style.display = 'none';
            document.getElementById('btn-next').style.display = 'inline-flex';
            
            const dbIndex = exerciseOrder[currentIdx];
            if (!database[dbIndex].solved) {
                score++;
                document.getElementById('score').innerText = score;
                database[dbIndex].solved = true;
            }
        } else {
            // FALLO
            mistakes++; 
            currentAttempts++;

            if (currentAttempts >= 3) {
                // AUTO-RESOLVER TRAS 3 FALLOS
                inputs.forEach(input => {
                    const type = input.dataset.type;
                    const idx = parseInt(input.dataset.index);
                    const baseVal = type === 'reactant' ? currentData.r_coef[idx] : currentData.p_coef[idx];
                    
                    input.value = baseVal;
                    input.classList.remove('incorrect');
                    input.classList.add('correct');
                    input.disabled = true;
                });
                
                feedback.innerText = "Se han agotado los intentos. Soluci√≥n aplicada autom√°ticamente.";
                feedback.className = "feedback-msg feedback-info";
                document.getElementById('btn-check-balance').style.display = 'none';
                document.getElementById('btn-next').style.display = 'inline-flex';
                
                // Marcar como resuelto pero SIN sumar puntos (score no incrementa)
                const dbIndex = exerciseOrder[currentIdx];
                database[dbIndex].solved = true; 

            } else {
                // Feedback de error normal
                feedback.innerText = `Incorrecto (Intento ${currentAttempts}/3). Revisa la conservaci√≥n de masa.`;
                feedback.className = "feedback-msg feedback-error";
                
                // Resaltar individualmente los que coincidan con la base (pista visual)
                inputs.forEach(input => {
                    const type = input.dataset.type;
                    const idx = parseInt(input.dataset.index);
                    let userVal = parseFloat(input.value);
                    if (isNaN(userVal) || userVal <= 0) userVal = 1;
                    
                    const baseVal = type === 'reactant' ? currentData.r_coef[idx] : currentData.p_coef[idx];
                    
                    if (Math.abs(userVal - baseVal) < epsilon) {
                         input.classList.add('correct');
                         input.classList.remove('incorrect');
                    } else {
                         input.classList.add('incorrect');
                         input.classList.remove('correct');
                    }
                });
            }
        }
    }

    function showLevelScreen() {
        if (score < 3) {
            // Mostrar modal de advertencia en lugar de alert
            document.getElementById('warning-score').innerText = score;
            document.getElementById('warning-modal').style.display = 'flex';
            return;
        }

        const app = document.getElementById('app-container');
        const levelScreen = document.getElementById('level-screen');
        
        // Calcular porcentaje de acierto
        const totalActions = score + mistakes;
        const accuracy = totalActions === 0 ? 0 : Math.round((score / totalActions) * 100);
        
        let medal = "";
        let title = "";
        let subtitle = "";

        if (accuracy >= 90) {
            medal = "ü•á";
            title = "Nivel: Maestro";
            subtitle = "¬°Excelencia qu√≠mica! Apenas cometes errores.";
        } else if (accuracy >= 70) {
            medal = "ü•à";
            title = "Nivel: Experto";
            subtitle = "Muy buen trabajo, dominas la estequiometr√≠a.";
        } else if (accuracy >= 50) {
            medal = "ü•â";
            title = "Nivel: Aprendiz";
            subtitle = "Vas por buen camino, sigue practicando.";
        } else {
            medal = "üß™";
            title = "Nivel: Novato";
            subtitle = "Revisa las valencias y sigue intent√°ndolo.";
        }

        document.getElementById('medal-display').innerText = medal;
        document.getElementById('level-title').innerText = title;
        document.getElementById('level-subtitle').innerText = subtitle;
        document.getElementById('final-stats-count').innerText = score;
        document.getElementById('final-stats-percent').innerText = accuracy + "%";

        app.style.display = 'none';
        levelScreen.style.display = 'flex';
        document.getElementById('completion-modal').style.display = 'none'; 
    }

    function closeWarningModal() {
        document.getElementById('warning-modal').style.display = 'none';
    }

    function hideFeedback(id) {
        const el = document.getElementById(id);
        el.innerText = '';
        el.style.display = 'none';
    }

    function nextExercise() {
        let nextIdx = currentIdx + 1;
        if (nextIdx >= database.length) {
            showCompletionModal(); // Fin del juego total
        } else {
            loadExercise(nextIdx);
        }
    }

    function showCompletionModal() {
        // Al finalizar todo, usamos la misma l√≥gica de nivel
        showLevelScreen();
    }

    function resetGame() {
        document.getElementById('level-screen').style.display = 'none';
        document.getElementById('completion-modal').style.display = 'none';
        
        // Resetear todo
        score = 0;
        mistakes = 0;
        currentAttempts = 0;
        document.getElementById('score').innerText = '0';
        database.forEach(d => d.solved = false);
        generateRandomOrder();
        
        // Volver a la app
        document.getElementById('app-container').style.display = 'block';
        loadExercise(0);
    }

</script>

</body>
</html>
