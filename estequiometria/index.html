    <!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Entrenador de Formulaci√≥n - Javier Gij√≥n</title>
    
    <!-- React y ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel para traducir JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        /* Estilos personalizados para animaciones */
        @keyframes explode {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 1; }
            80% { opacity: 1; }
            100% { transform: translate(calc(-50% + var(--tx)), calc(-50% + var(--ty))) scale(1); opacity: 0; }
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }

        .animate-shake {
            animation: shake 0.5s ease-in-out;
        }
        
        /* Scrollbar personalizado */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* Ajustes m√≥viles */
        .touch-manipulation {
            touch-action: manipulation;
        }
    </style>
</head>
<body class="bg-slate-900 overflow-x-hidden fixed inset-0">
    <div id="root" class="h-full overflow-y-auto custom-scrollbar"></div>

    <script type="text/babel">
        const { useState, useMemo, useEffect } = React;

        // --- ICONOS (SVG Components) ---
        const Icon = ({ path, className }) => (
            <svg 
                xmlns="http://www.w3.org/2000/svg" 
                width="24" 
                height="24" 
                viewBox="0 0 24 24" 
                fill="none" 
                stroke="currentColor" 
                strokeWidth="2" 
                strokeLinecap="round" 
                strokeLinejoin="round" 
                className={className}
            >
                {path}
            </svg>
        );

        const BookOpen = (props) => <Icon {...props} path={<><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></>} />;
        const CheckCircle = (props) => <Icon {...props} path={<><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></>} />;
        const Play = (props) => <Icon {...props} path={<polygon points="5 3 19 12 5 21 5 3"/>} />;
        const RefreshCw = (props) => <Icon {...props} path={<><path d="M21 2v6h-6"/><path d="M3 12a9 9 0 0 1 15-6.7L21 8"/><path d="M3 22v-6h6"/><path d="M21 12a9 9 0 0 1-15 6.7L3 16"/></>} />;
        const Eye = (props) => <Icon {...props} path={<><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></>} />;
        const Award = (props) => <Icon {...props} path={<><circle cx="12" cy="8" r="7"/><polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"/></>} />;
        const Zap = (props) => <Icon {...props} path={<polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/>} />;
        const AlertTriangle = (props) => <Icon {...props} path={<><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></>} />;
        const Atom = (props) => <Icon {...props} path={<><circle cx="12" cy="12" r="1"/><path d="M20.2 20.2c2.04-2.03.02-7.36-4.5-11.9-4.54-4.52-9.87-6.54-11.9-4.5-2.04 2.03-.02 7.36 4.5 11.9 4.54 4.52 9.87 6.54 11.9 4.5z"/><path d="M15.7 15.7c4.52-4.54 6.54-9.87 4.5-11.9-2.03-2.04-7.36-.02-11.9 4.5-4.52 4.54-6.54 9.87-4.5 11.9 2.03 2.04 7.36.02 11.9-4.5z"/></>} />;

        // --- CONFIGURACI√ìN ---
        const FAILURE_PHRASES = [
            "Madre m√≠a... ü§¶‚Äç‚ôÇÔ∏è",
            "No mereces el agua que bebes üö∞",
            "La vida... üòÆ‚Äçüí®",
            "Porque t√∫ lo digas... üôÑ",
            "¬°Ay, mis ojos! üôà",
            "¬øEn serio? ü§®"
        ];

        // --- BASE DE DATOS ---
        const rawData = [
            // --- √ìxidos B√°sicos ---
            { formula: "Li2O", name: "√ìxido de litio", type: "√ìxidos" },
            { formula: "Na2O", name: "√ìxido de sodio", type: "√ìxidos" },
            { formula: "K2O", name: "√ìxido de potasio", type: "√ìxidos" },
            { formula: "MgO", name: "√ìxido de magnesio", type: "√ìxidos" },
            { formula: "CaO", name: "√ìxido de calcio", type: "√ìxidos" },
            { formula: "SrO", name: "√ìxido de estroncio", type: "√ìxidos" },
            { formula: "BaO", name: "√ìxido de bario", type: "√ìxidos" },
            { formula: "FeO", name: "√ìxido de hierro (II)", type: "√ìxidos" },
            { formula: "Fe2O3", name: "√ìxido de hierro (III)", type: "√ìxidos" },
            { formula: "Cu2O", name: "√ìxido de cobre (I)", type: "√ìxidos" },
            { formula: "CuO", name: "√ìxido de cobre (II)", type: "√ìxidos" },
            { formula: "Hg2O", name: "√ìxido de mercurio (I)", type: "√ìxidos" },
            { formula: "HgO", name: "√ìxido de mercurio (II)", type: "√ìxidos" },
            { formula: "Au2O", name: "√ìxido de oro (I)", type: "√ìxidos" },
            { formula: "Au2O3", name: "√ìxido de oro (III)", type: "√ìxidos" },
            { formula: "Al2O3", name: "√ìxido de aluminio", type: "√ìxidos" },
            { formula: "PbO", name: "√ìxido de plomo (II)", type: "√ìxidos" },
            { formula: "PbO2", name: "√ìxido de plomo (IV)", type: "√ìxidos" },
            { formula: "SnO", name: "√ìxido de esta√±o (II)", type: "√ìxidos" },
            { formula: "SnO2", name: "√ìxido de esta√±o (IV)", type: "√ìxidos" },
            { formula: "CrO", name: "√ìxido de cromo (II)", type: "√ìxidos" },
            { formula: "Cr2O3", name: "√ìxido de cromo (III)", type: "√ìxidos" },
            { formula: "CrO3", name: "√ìxido de cromo (VI)", type: "√ìxidos" },
            { formula: "MnO", name: "√ìxido de manganeso (II)", type: "√ìxidos" },
            { formula: "Mn2O3", name: "√ìxido de manganeso (III)", type: "√ìxidos" },
            { formula: "MnO2", name: "√ìxido de manganeso (IV)", type: "√ìxidos" },
            { formula: "Mn2O7", name: "√ìxido de manganeso (VII)", type: "√ìxidos" },
            
            // --- √ìxidos de No Metales ---
            { formula: "CO", name: "Mon√≥xido de carbono", type: "√ìxidos" },
            { formula: "CO2", name: "Di√≥xido de carbono", type: "√ìxidos" },
            { formula: "SO2", name: "Di√≥xido de azufre", type: "√ìxidos" },
            { formula: "SO3", name: "Tri√≥xido de azufre", type: "√ìxidos" },
            { formula: "N2O", name: "√ìxido de dinitr√≥geno", type: "√ìxidos" },
            { formula: "NO", name: "Mon√≥xido de nitr√≥geno", type: "√ìxidos" },
            { formula: "NO2", name: "Di√≥xido de nitr√≥geno", type: "√ìxidos" },
            { formula: "N2O5", name: "Pent√≥xido de dinitr√≥geno", type: "√ìxidos" },
            { formula: "P2O3", name: "Tri√≥xido de dif√≥sforo", type: "√ìxidos" },
            { formula: "P2O5", name: "Pent√≥xido de dif√≥sforo", type: "√ìxidos" },
            
            // --- HAL√ìGENOS (Nomenclatura Recomendada IUPAC 2005: Halogenuros de ox√≠geno) ---
            { formula: "OCl2", name: "Dicloruro de ox√≠geno", type: "Halogenuros de Ox√≠geno" },
            { formula: "O3Cl2", name: "Dicloruro de triox√≠geno", type: "Halogenuros de Ox√≠geno" },
            { formula: "O5Cl2", name: "Dicloruro de pentaox√≠geno", type: "Halogenuros de Ox√≠geno" },
            { formula: "O7Cl2", name: "Dicloruro de heptaox√≠geno", type: "Halogenuros de Ox√≠geno" },
            
            { formula: "OBr2", name: "Dibromuro de ox√≠geno", type: "Halogenuros de Ox√≠geno" },
            { formula: "O3Br2", name: "Dibromuro de triox√≠geno", type: "Halogenuros de Ox√≠geno" },
            { formula: "O5Br2", name: "Dibromuro de pentaox√≠geno", type: "Halogenuros de Ox√≠geno" },
            
            { formula: "OI2", name: "Diyoduro de ox√≠geno", type: "Halogenuros de Ox√≠geno" },
            { formula: "O5I2", name: "Diyoduro de pentaox√≠geno", type: "Halogenuros de Ox√≠geno" },
            { formula: "O7I2", name: "Diyoduro de heptaox√≠geno", type: "Halogenuros de Ox√≠geno" },

            // --- Per√≥xidos ---
            { formula: "H2O2", name: "Per√≥xido de hidr√≥geno", type: "Per√≥xidos" },
            { formula: "Li2O2", name: "Per√≥xido de litio", type: "Per√≥xidos" },
            { formula: "Na2O2", name: "Per√≥xido de sodio", type: "Per√≥xidos" },
            { formula: "K2O2", name: "Per√≥xido de potasio", type: "Per√≥xidos" },
            { formula: "MgO2", name: "Per√≥xido de magnesio", type: "Per√≥xidos" },
            { formula: "CaO2", name: "Per√≥xido de calcio", type: "Per√≥xidos" },
            { formula: "SrO2", name: "Per√≥xido de estroncio", type: "Per√≥xidos" },
            { formula: "BaO2", name: "Per√≥xido de bario", type: "Per√≥xidos" },
            { formula: "ZnO2", name: "Per√≥xido de cinc", type: "Per√≥xidos" },
            { formula: "CdO2", name: "Per√≥xido de cadmio", type: "Per√≥xidos" },

            // --- Hidr√≥xidos ---
            { formula: "LiOH", name: "Hidr√≥xido de litio", type: "Hidr√≥xidos" },
            { formula: "NaOH", name: "Hidr√≥xido de sodio", type: "Hidr√≥xidos" },
            { formula: "KOH", name: "Hidr√≥xido de potasio", type: "Hidr√≥xidos" },
            { formula: "Mg(OH)2", name: "Hidr√≥xido de magnesio", type: "Hidr√≥xidos" },
            { formula: "Ca(OH)2", name: "Hidr√≥xido de calcio", type: "Hidr√≥xidos" },
            { formula: "Sr(OH)2", name: "Hidr√≥xido de estroncio", type: "Hidr√≥xidos" },
            { formula: "Ba(OH)2", name: "Hidr√≥xido de bario", type: "Hidr√≥xidos" },
            { formula: "Fe(OH)2", name: "Hidr√≥xido de hierro (II)", type: "Hidr√≥xidos" },
            { formula: "Fe(OH)3", name: "Hidr√≥xido de hierro (III)", type: "Hidr√≥xidos" },
            { formula: "Co(OH)2", name: "Hidr√≥xido de cobalto (II)", type: "Hidr√≥xidos" },
            { formula: "Co(OH)3", name: "Hidr√≥xido de cobalto (III)", type: "Hidr√≥xidos" },
            { formula: "Ni(OH)2", name: "Hidr√≥xido de n√≠quel (II)", type: "Hidr√≥xidos" },
            { formula: "Ni(OH)3", name: "Hidr√≥xido de n√≠quel (III)", type: "Hidr√≥xidos" },
            { formula: "CuOH", name: "Hidr√≥xido de cobre (I)", type: "Hidr√≥xidos" },
            { formula: "Cu(OH)2", name: "Hidr√≥xido de cobre (II)", type: "Hidr√≥xidos" },
            { formula: "AgOH", name: "Hidr√≥xido de plata", type: "Hidr√≥xidos" },
            { formula: "Au(OH)3", name: "Hidr√≥xido de oro (III)", type: "Hidr√≥xidos" },
            { formula: "Zn(OH)2", name: "Hidr√≥xido de cinc", type: "Hidr√≥xidos" },
            { formula: "Cd(OH)2", name: "Hidr√≥xido de cadmio", type: "Hidr√≥xidos" },
            { formula: "Hg(OH)2", name: "Hidr√≥xido de mercurio (II)", type: "Hidr√≥xidos" },
            { formula: "Al(OH)3", name: "Hidr√≥xido de aluminio", type: "Hidr√≥xidos" },
            { formula: "Pb(OH)2", name: "Hidr√≥xido de plomo (II)", type: "Hidr√≥xidos" },
            { formula: "Pb(OH)4", name: "Hidr√≥xido de plomo (IV)", type: "Hidr√≥xidos" },
            { formula: "Sn(OH)2", name: "Hidr√≥xido de esta√±o (II)", type: "Hidr√≥xidos" },
            { formula: "Sn(OH)4", name: "Hidr√≥xido de esta√±o (IV)", type: "Hidr√≥xidos" },

            // --- Hidruros ---
            { formula: "LiH", name: "Hidruro de litio", type: "Hidruros" },
            { formula: "NaH", name: "Hidruro de sodio", type: "Hidruros" },
            { formula: "KH", name: "Hidruro de potasio", type: "Hidruros" },
            { formula: "CaH2", name: "Hidruro de calcio", type: "Hidruros" },
            { formula: "BaH2", name: "Hidruro de bario", type: "Hidruros" },
            { formula: "AlH3", name: "Hidruro de aluminio", type: "Hidruros" },
            { formula: "FeH2", name: "Hidruro de hierro (II)", type: "Hidruros" },
            { formula: "FeH3", name: "Hidruro de hierro (III)", type: "Hidruros" },
            { formula: "CH4", name: "Metano", type: "Hidruros" },
            { formula: "SiH4", name: "Silano", type: "Hidruros" },
            { formula: "NH3", name: "Amoniaco", type: "Hidruros" },
            { formula: "PH3", name: "Fosfano", type: "Hidruros" },
            { formula: "AsH3", name: "Arsano", type: "Hidruros" },
            { formula: "SbH3", name: "Estibano", type: "Hidruros" },
            { formula: "H2O", name: "Agua", type: "Hidruros" },
            { formula: "H2S", name: "Sulfuro de hidr√≥geno", type: "Hidruros" },
            { formula: "H2Se", name: "Seleniuro de hidr√≥geno", type: "Hidruros" },
            { formula: "H2Te", name: "Telururo de hidr√≥geno", type: "Hidruros" },
            { formula: "HF", name: "Fluoruro de hidr√≥geno", type: "Hidruros" },
            { formula: "HCl", name: "Cloruro de hidr√≥geno", type: "Hidruros" },
            { formula: "HBr", name: "Bromuro de hidr√≥geno", type: "Hidruros" },
            { formula: "HI", name: "Yoduro de hidr√≥geno", type: "Hidruros" },

            // --- Sales Binarias ---
            { formula: "LiF", name: "Fluoruro de litio", type: "Sales Binarias" },
            { formula: "NaCl", name: "Cloruro de sodio", type: "Sales Binarias" },
            { formula: "KBr", name: "Bromuro de potasio", type: "Sales Binarias" },
            { formula: "KI", name: "Yoduro de potasio", type: "Sales Binarias" },
            { formula: "CaF2", name: "Fluoruro de calcio", type: "Sales Binarias" },
            { formula: "MgCl2", name: "Cloruro de magnesio", type: "Sales Binarias" },
            { formula: "CaBr2", name: "Bromuro de calcio", type: "Sales Binarias" },
            { formula: "AlCl3", name: "Cloruro de aluminio", type: "Sales Binarias" },
            { formula: "FeCl2", name: "Cloruro de hierro (II)", type: "Sales Binarias" },
            { formula: "FeCl3", name: "Cloruro de hierro (III)", type: "Sales Binarias" },
            { formula: "CuBr", name: "Bromuro de cobre (I)", type: "Sales Binarias" },
            { formula: "CuBr2", name: "Bromuro de cobre (II)", type: "Sales Binarias" },
            { formula: "AgCl", name: "Cloruro de plata", type: "Sales Binarias" },
            { formula: "AgI", name: "Yoduro de plata", type: "Sales Binarias" },
            { formula: "ZnS", name: "Sulfuro de cinc", type: "Sales Binarias" },
            { formula: "PbS", name: "Sulfuro de plomo (II)", type: "Sales Binarias" },
            { formula: "MnS", name: "Sulfuro de manganeso (II)", type: "Sales Binarias" },
            { formula: "NiCl2", name: "Cloruro de n√≠quel (II)", type: "Sales Binarias" },
            { formula: "CCl4", name: "Tetracloruro de carbono", type: "Sales Binarias" },
            { formula: "CS2", name: "Disulfuro de carbono", type: "Sales Binarias" },
            { formula: "SF6", name: "Hexafluoruro de azufre", type: "Sales Binarias" },
            { formula: "PCl3", name: "Tricloruro de f√≥sforo", type: "Sales Binarias" },
            { formula: "PCl5", name: "Pentacloruro de f√≥sforo", type: "Sales Binarias" },

            // --- Oxo√°cidos ---
            { formula: "HClO", name: "√Åcido hipocloroso", type: "Oxo√°cidos" },
            { formula: "HClO2", name: "√Åcido cloroso", type: "Oxo√°cidos" },
            { formula: "HClO3", name: "√Åcido cl√≥rico", type: "Oxo√°cidos" },
            { formula: "HClO4", name: "√Åcido percl√≥rico", type: "Oxo√°cidos" },
            { formula: "HBrO", name: "√Åcido hipobromoso", type: "Oxo√°cidos" },
            { formula: "HBrO2", name: "√Åcido bromoso", type: "Oxo√°cidos" },
            { formula: "HBrO3", name: "√Åcido br√≥mico", type: "Oxo√°cidos" },
            { formula: "HBrO4", name: "√Åcido perbr√≥mico", type: "Oxo√°cidos" },
            { formula: "HIO", name: "√Åcido hipoyodoso", type: "Oxo√°cidos" },
            { formula: "HIO3", name: "√Åcido y√≥dico", type: "Oxo√°cidos" },
            { formula: "HIO4", name: "√Åcido pery√≥dico", type: "Oxo√°cidos" },
            { formula: "H2SO3", name: "√Åcido sulfuroso", type: "Oxo√°cidos" },
            { formula: "H2SO4", name: "√Åcido sulf√∫rico", type: "Oxo√°cidos" },
            { formula: "H2SeO3", name: "√Åcido selenioso", type: "Oxo√°cidos" },
            { formula: "H2SeO4", name: "√Åcido sel√©nico", type: "Oxo√°cidos" },
            { formula: "H2TeO3", name: "√Åcido teluroso", type: "Oxo√°cidos" },
            { formula: "H2TeO4", name: "√Åcido tel√∫rico", type: "Oxo√°cidos" },
            { formula: "HNO2", name: "√Åcido nitroso", type: "Oxo√°cidos" },
            { formula: "HNO3", name: "√Åcido n√≠trico", type: "Oxo√°cidos" },
            { formula: "H3PO3", name: "√Åcido fosforoso", type: "Oxo√°cidos" },
            { formula: "H3PO4", name: "√Åcido fosf√≥rico", type: "Oxo√°cidos" },
            { formula: "H3AsO3", name: "√Åcido arsenioso", type: "Oxo√°cidos" },
            { formula: "H3AsO4", name: "√Åcido ars√©nico", type: "Oxo√°cidos" },
            { formula: "H2CO3", name: "√Åcido carb√≥nico", type: "Oxo√°cidos" },
            { formula: "H2SiO3", name: "√Åcido metasil√≠cico", type: "Oxo√°cidos" },
            { formula: "H3BO3", name: "√Åcido b√≥rico", type: "Oxo√°cidos" },
            { formula: "HMnO4", name: "√Åcido permang√°nico", type: "Oxo√°cidos" },
            { formula: "H2CrO4", name: "√Åcido cr√≥mico", type: "Oxo√°cidos" },
            { formula: "H2Cr2O7", name: "√Åcido dicr√≥mico", type: "Oxo√°cidos" },

            // --- Oxisales (Incluyendo Dicromatos Extra) ---
            { formula: "NaClO", name: "Hipoclorito de sodio", type: "Oxisales" },
            { formula: "NaClO2", name: "Clorito de sodio", type: "Oxisales" },
            { formula: "NaClO3", name: "Clorato de sodio", type: "Oxisales" },
            { formula: "NaClO4", name: "Perclorato de sodio", type: "Oxisales" },
            { formula: "KClO3", name: "Clorato de potasio", type: "Oxisales" },
            { formula: "Ca(ClO)2", name: "Hipoclorito de calcio", type: "Oxisales" },
            { formula: "NaNO2", name: "Nitrito de sodio", type: "Oxisales" },
            { formula: "NaNO3", name: "Nitrato de sodio", type: "Oxisales" },
            { formula: "KNO3", name: "Nitrato de potasio", type: "Oxisales" },
            { formula: "AgNO3", name: "Nitrato de plata", type: "Oxisales" },
            { formula: "Ca(NO3)2", name: "Nitrato de calcio", type: "Oxisales" },
            { formula: "Cu(NO3)2", name: "Nitrato de cobre (II)", type: "Oxisales" },
            { formula: "Pb(NO3)2", name: "Nitrato de plomo (II)", type: "Oxisales" },
            { formula: "Na2SO3", name: "Sulfito de sodio", type: "Oxisales" },
            { formula: "Na2SO4", name: "Sulfato de sodio", type: "Oxisales" },
            { formula: "CaSO4", name: "Sulfato de calcio", type: "Oxisales" },
            { formula: "MgSO4", name: "Sulfato de magnesio", type: "Oxisales" },
            { formula: "BaSO4", name: "Sulfato de bario", type: "Oxisales" },
            { formula: "CuSO4", name: "Sulfato de cobre (II)", type: "Oxisales" },
            { formula: "FeSO4", name: "Sulfato de hierro (II)", type: "Oxisales" },
            { formula: "Fe2(SO4)3", name: "Sulfato de hierro (III)", type: "Oxisales" },
            { formula: "Al2(SO4)3", name: "Sulfato de aluminio", type: "Oxisales" },
            { formula: "Na2CO3", name: "Carbonato de sodio", type: "Oxisales" },
            { formula: "K2CO3", name: "Carbonato de potasio", type: "Oxisales" },
            { formula: "CaCO3", name: "Carbonato de calcio", type: "Oxisales" },
            { formula: "MgCO3", name: "Carbonato de magnesio", type: "Oxisales" },
            { formula: "Na3PO4", name: "Fosfato de sodio", type: "Oxisales" },
            { formula: "Ca3(PO4)2", name: "Fosfato de calcio", type: "Oxisales" },
            { formula: "AlPO4", name: "Fosfato de aluminio", type: "Oxisales" },
            { formula: "K2CrO4", name: "Cromato de potasio", type: "Oxisales" },
            { formula: "K2Cr2O7", name: "Dicromato de potasio", type: "Oxisales" },
            { formula: "Na2Cr2O7", name: "Dicromato de sodio", type: "Oxisales" },
            { formula: "Li2Cr2O7", name: "Dicromato de litio", type: "Oxisales" },
            { formula: "CaCr2O7", name: "Dicromato de calcio", type: "Oxisales" },
            { formula: "MgCr2O7", name: "Dicromato de magnesio", type: "Oxisales" },
            { formula: "ZnCr2O7", name: "Dicromato de cinc", type: "Oxisales" },
            { formula: "Ag2Cr2O7", name: "Dicromato de plata", type: "Oxisales" },
            { formula: "(NH4)2Cr2O7", name: "Dicromato de amonio", type: "Oxisales" },
            { formula: "KMnO4", name: "Permanganato de potasio", type: "Oxisales" },

            // --- Sales √Åcidas ---
            { formula: "NaHCO3", name: "Hidrogenocarbonato de sodio", type: "Sales √Åcidas" },
            { formula: "KHCO3", name: "Hidrogenocarbonato de potasio", type: "Sales √Åcidas" },
            { formula: "Ca(HCO3)2", name: "Hidrogenocarbonato de calcio", type: "Sales √Åcidas" },
            { formula: "NaHSO4", name: "Hidrogenosulfato de sodio", type: "Sales √Åcidas" },
            { formula: "KHSO4", name: "Hidrogenosulfato de potasio", type: "Sales √Åcidas" },
            { formula: "Ca(HSO4)2", name: "Hidrogenosulfato de calcio", type: "Sales √Åcidas" },
            { formula: "NaHSO3", name: "Hidrogenosulfito de sodio", type: "Sales √Åcidas" },
            { formula: "KH2PO4", name: "Dihidrogenofosfato de potasio", type: "Sales √Åcidas" },
            { formula: "K2HPO4", name: "Hidrogenofosfato de potasio", type: "Sales √Åcidas" },
            { formula: "NaH2PO4", name: "Dihidrogenofosfato de sodio", type: "Sales √Åcidas" },
            { formula: "Na2HPO4", name: "Hidrogenofosfato de sodio", type: "Sales √Åcidas" },
            { formula: "Ca(H2PO4)2", name: "Dihidrogenofosfato de calcio", type: "Sales √Åcidas" },
            { formula: "CaHPO4", name: "Hidrogenofosfato de calcio", type: "Sales √Åcidas" },
        ];

        const generateSmartDistractors = (correct, allItems, mode) => {
            const distractors = new Set();
            const targetType = mode === 'formula' ? 'formula' : 'name';
            
            // --- DETECCI√ìN DEL ELEMENTO PRINCIPAL Y TIPO ---
            let mainHalogen = null;
            if (correct.includes("Cl") || correct.toLowerCase().includes("cloro")) mainHalogen = { sym: "Cl", name: "cloro" };
            else if (correct.includes("Br") || correct.toLowerCase().includes("bromo")) mainHalogen = { sym: "Br", name: "bromo" };
            else if (correct.includes("I") && !correct.includes("Li") || correct.toLowerCase().includes("yodo")) mainHalogen = { sym: "I", name: "yodo" };

            const isHalogenOxide = mainHalogen && (correct.startsWith("O") || correct.toLowerCase().includes("ox√≠geno"));
            const itemType = allItems.find(i => i[targetType] === correct)?.type;
            const isOxoCompound = itemType === "Oxo√°cidos" || itemType === "Oxisales" || itemType === "Sales √Åcidas";

            // Funci√≥n mejorada para mutar f√≥rmulas preservando los elementos
            const mutateFormula = (str) => {
                if (isHalogenOxide) {
                    if (/\d/.test(str)) {
                        return str.replace(/(\d)/g, (m) => {
                            const val = parseInt(m);
                            const options = [1, 2, 3, 5, 7].filter(n => n !== val);
                            return options[Math.floor(Math.random() * options.length)];
                        });
                    } else {
                        return str.replace(mainHalogen.sym, mainHalogen.sym + "2").replace("O", "O" + (Math.random() > 0.5 ? "3" : "5"));
                    }
                }

                if (isOxoCompound) {
                    const parts = str.split(/([A-Z][a-z]?|\(|\)|\[|\])(\d*)/).filter(Boolean);
                    let mutated = "";
                    let changed = false;
                    
                    for (let i = 0; i < parts.length; i++) {
                        const part = parts[i];
                        if (/^\d+$/.test(part)) {
                            const val = parseInt(part);
                            const options = [val-1, val+1, val+2, 2, 3, 4].filter(n => n > 0 && n !== val);
                            mutated += options[Math.floor(Math.random() * options.length)];
                            changed = true;
                        } 
                        else if (!/^\d+$/.test(part) && (i + 1 >= parts.length || !/^\d+$/.test(parts[i+1]))) {
                            mutated += part;
                            if ((part === 'O' || part === 'H' || part === ')') && Math.random() > 0.6) {
                                mutated += (Math.random() > 0.5 ? "2" : "3");
                                changed = true;
                            }
                        }
                        else if (!/^\d+$/.test(part)) {
                            mutated += part;
                        }
                    }
                    if (!changed) return mutated + "2";
                    return mutated;
                }

                if (str.match(/[A-Z][a-z]?\d*/g)) {
                    let mutated = str.replace(/(\d+)/g, (match) => {
                        const val = parseInt(match);
                        const options = [2, 3, 4, 5, 7].filter(n => n !== val);
                        return options[Math.floor(Math.random() * options.length)];
                    });
                    if (mutated === str) {
                         mutated = str.replace(/([A-Z][a-z]?)(?![a-z])(?!.*\d)/, "$12"); 
                         if (mutated === str) mutated = str + "2"; 
                    }
                    return mutated;
                }
                return str + "2"; 
            };

            // Funci√≥n mejorada para mutar nombres preservando el elemento central
            const mutateName = (str) => {
                let options = [];
                
                // 1. Estrategia para √ìxidos y Halogenuros (Sistem√°tica)
                if (str.match(/\b(Mon|Di|Tri|Tetra|Penta|Hexa|Hepta)/)) {
                    const prefixes = ["Mon", "Di", "Tri", "Tetra", "Penta", "Hepta"];
                    prefixes.forEach(p => {
                        // Reemplazar prefijo en "√≥xido" o en el elemento
                        let newVal = str.replace(/\b(Mon|Di|Tri|Tetra|Penta|Hexa|Hepta)√≥xido/g, p + "√≥xido")
                                          .replace(/\b(mon|di|tri|tetra|penta|hexa|hepta)√≥xido/g, p.toLowerCase() + "√≥xido")
                                          .replace(/\b(Mon|Di|Tri|Tetra|Penta|Hexa|Hepta)(clor|brom|yod)/g, p + "$2") 
                                          .replace(/\b(mon|di|tri|tetra|penta|hexa|hepta)(clor|brom|yod)/g, p.toLowerCase() + "$2");
                        
                        // Si no hubo reemplazo por regex (ej: Dicloruro de...), intentar forzar
                        if (newVal === str && !str.includes("√≥xido")) {
                             const words = str.split(" ");
                             if (words[0].match(/^(Mon|Di|Tri|Tetra|Penta|Hexa|Hepta)/)) {
                                 // Reemplazar el prefijo de la primera palabra
                                 words[0] = words[0].replace(/^(Mon|Di|Tri|Tetra|Penta|Hexa|Hepta)/, p);
                                 newVal = words.join(" ");
                             } else {
                                 // A√±adir prefijo
                                 newVal = p + words[0].toLowerCase() + " " + words.slice(1).join(" ");
                             }
                        }

                        if (newVal !== str) options.push(newVal);
                    });
                }

                // 2. Estrategia para √Åcidos y Sales (Tradicional)
                let suffix = "";
                let prefix = "";
                
                if (str.includes("ico")) suffix = "ico";
                else if (str.includes("oso")) suffix = "oso";
                else if (str.includes("ato")) suffix = "ato";
                else if (str.includes("ito")) suffix = "ito";
                
                if (str.includes("Hipo")) prefix = "Hipo";
                else if (str.includes("Per")) prefix = "Per";
                else if (str.includes("Meta")) prefix = "Meta";
                else if (str.includes("Orto")) prefix = "Orto";

                if (suffix) {
                    const suffixes = ["ico", "oso"]; 
                    const saltSuffixes = ["ato", "ito"]; 
                    const targetSuffixes = (suffix === "ato" || suffix === "ito") ? saltSuffixes : suffixes;
                    const possiblePrefixes = ["", "Hipo", "Per", "Meta", "Orto"];

                    targetSuffixes.forEach(s => {
                        possiblePrefixes.forEach(p => {
                            let newName = str;
                            // Reemplazar sufijo
                            newName = newName.replace(suffix, s);
                            
                            // Manejar prefijo
                            if (prefix) {
                                if (p === "") newName = newName.replace(prefix, ""); 
                                else newName = newName.replace(prefix, p); 
                            } else {
                                if (p !== "") {
                                    if (newName.startsWith("√Åcido ")) {
                                        newName = newName.replace("√Åcido ", "√Åcido " + p.toLowerCase());
                                    } else {
                                        newName = p + newName.charAt(0).toLowerCase() + newName.slice(1);
                                    }
                                }
                            }
                            
                            newName = newName.replace("  ", " ").trim();
                            newName = newName.charAt(0).toUpperCase() + newName.slice(1);
                            
                            if (newName !== str) options.push(newName);
                        });
                    });
                }

                // 3. Estrategia N√∫meros Romanos
                if (str.includes("(")) {
                    const romans = ['(I)', '(II)', '(III)', '(IV)', '(V)', '(VI)', '(VII)'];
                    romans.forEach(r => {
                        const newVal = str.replace(/\((I|II|III|IV|V|VI|VII)\)/, r);
                        if (newVal !== str) options.push(newVal);
                    });
                } else if (!str.match(/\b(Mon|Di|Tri)/) && !str.includes("√Åcido")) {
                    // Si no es √°cido ni sistem√°tica, a√±adir valencia inventada
                    options.push(str + " (II)");
                    options.push(str + " (III)");
                    options.push(str + " (IV)");
                }

                // 4. Estrategia sales √°cidas
                if (str.includes("Hidrogeno") || str.includes("hidrogeno")) {
                     const variants = ["Hidrogeno", "Dihidrogeno"];
                     variants.forEach(v => {
                         let newVal = str;
                         if (str.includes("Dihidrogeno")) newVal = str.replace("Dihidrogeno", v);
                         else if (str.includes("Trihidrogeno")) newVal = str.replace("Trihidrogeno", v);
                         else newVal = str.replace("Hidrogeno", v);
                         
                         if (newVal !== str) options.push(newVal);
                     });
                }

                if (options.length > 0) {
                    return options[Math.floor(Math.random() * options.length)];
                }
                
                return "Di" + str.toLowerCase();
            };

            let attempts = 0;
            while (distractors.size < 5 && attempts < 50) {
                attempts++;
                let fake = targetType === 'formula' ? mutateFormula(correct) : mutateName(correct);
                
                if (fake && fake !== correct && fake !== "undefined") {
                    distractors.add(fake);
                }
            }
            
            // Fallback: Buscar en la BD elementos que compartan la RA√çZ del nombre
            if (distractors.size < 5) {
                const currentItemType = allItems.find(i => i[targetType] === correct)?.type;
                const sameType = allItems.filter(i => i.type === currentItemType && i[targetType] !== correct);
                
                // Extraer ra√≠ces simples (palabras de >3 letras) del nombre correcto
                const correctNameLower = correct.toLowerCase();
                // Ignorar palabras comunes
                const stopWords = ["√°cido", "de", "oxido", "peroxido", "hidroxido", "hidruro", "sal", "mono", "di", "tri"];
                const roots = correctNameLower.split(/[\s\(\)]+/)
                                              .filter(w => w.length > 3 && !stopWords.includes(w))
                                              .map(w => w.replace(/ato$|ito$|ico$|oso$|uro$/, "")); // Quitar sufijos para obtener ra√≠z pura

                while (distractors.size < 5 && sameType.length > 0) {
                     // Elegir uno random
                     const randIndex = Math.floor(Math.random() * sameType.length);
                     const randomItem = sameType[randIndex];
                     sameType.splice(randIndex, 1); // Quitar para no repetir
                     
                     let valid = false;
                     // Filtro estricto: Debe compartir alguna ra√≠z
                     if (roots.length > 0) {
                         const candidateName = randomItem[targetType].toLowerCase();
                         if (roots.some(r => candidateName.includes(r))) {
                             valid = true;
                         }
                     } else {
                         // Si no pudimos sacar ra√≠ces (ej. nombres muy cortos), aceptamos del mismo tipo
                         valid = true; 
                     }

                     // Filtro extra para halogenuros
                     if (isHalogenOxide) {
                        if (!randomItem[targetType].includes(mainHalogen.sym) && !randomItem[targetType].toLowerCase().includes(mainHalogen.name)) valid = false;
                     }

                     if (valid) distractors.add(randomItem[targetType]);
                }
            }

            return Array.from(distractors).slice(0, 5).sort(() => 0.5 - Math.random());
        };

        // --- COMPONENTE EXPLOSI√ìN ERROR ---
        const ErrorExplosion = () => {
            // Part√≠culas rojas/naranjas con movimiento ca√≥tico hacia afuera
            const particles = Array.from({ length: 20 }).map((_, i) => {
                const angle = (i / 20) * 360;
                const distance = 60 + Math.random() * 40;
                const delay = Math.random() * 0.1;
                
                // Color rojo intenso y naranja
                const color = ['#ef4444', '#dc2626', '#f87171', '#fb923c'][Math.floor(Math.random() * 4)];
                
                const tx = Math.cos(angle * Math.PI / 180) * distance;
                const ty = Math.sin(angle * Math.PI / 180) * distance;

                return (
                    <div
                        key={i}
                        className="absolute w-3 h-3 rounded-sm opacity-0" // Cuadrados peque√±os para diferenciar
                        style={{
                            backgroundColor: color,
                            top: '50%',
                            left: '50%',
                            animation: `explode 0.6s ease-out forwards ${delay}s`,
                            '--tx': `${tx}px`,
                            '--ty': `${ty}px`,
                        }}
                    />
                );
            });

            return (
                <div className="absolute top-1/2 left-1/2 w-0 h-0 overflow-visible pointer-events-none z-50 flex items-center justify-center">
                    {particles}
                </div>
            );
        };

        const SubscriptText = ({ text }) => {
            if (!text) return null;
            const parts = text.split(/(\d+)/g);
            return (
                <span className="font-mono tracking-wider break-words">
                    {parts.map((part, i) => 
                        /\d+/.test(part) ? <sub key={i} className="text-[0.7em] align-baseline relative top-[0.3em] font-bold opacity-90">{part}</sub> : part
                    )}
                </span>
            );
        };

        const FireworkExplosion = () => {
            const particles = Array.from({ length: 30 }).map((_, i) => {
                const angle = (i / 30) * 360;
                const distance = 150 + Math.random() * 100;
                const delay = Math.random() * 0.2;
                const color = ['#ef4444', '#3b82f6', '#22c55e', '#eab308', '#ec4899', '#8b5cf6'][Math.floor(Math.random() * 6)];
                
                const tx = Math.cos(angle * Math.PI / 180) * distance;
                const ty = Math.sin(angle * Math.PI / 180) * distance;

                return (
                    <div
                        key={i}
                        className="absolute w-2 h-2 rounded-full opacity-0"
                        style={{
                            backgroundColor: color,
                            top: '50%',
                            left: '50%',
                            animation: `explode 0.8s ease-out forwards ${delay}s`,
                            '--tx': `${tx}px`,
                            '--ty': `${ty}px`,
                        }}
                    />
                );
            });

            return (
                <div className="absolute top-1/2 left-1/2 w-0 h-0 overflow-visible pointer-events-none z-50 flex items-center justify-center">
                    {particles}
                </div>
            );
        };

        // --- APP PRINCIPAL ---
        function FormulacionApp() {
            const [gameState, setGameState] = useState('setup');
            const [selectedTypes, setSelectedTypes] = useState(['Todos']);
            const [questionCount, setQuestionCount] = useState(15);
            const [questions, setQuestions] = useState([]);
            const [currentIndex, setCurrentIndex] = useState(0);
            const [showOptions, setShowOptions] = useState(false);
            const [correctCount, setCorrectCount] = useState(0);
            const [incorrectCount, setIncorrectCount] = useState(0);
            const [feedback, setFeedback] = useState(null);
            const [history, setHistory] = useState([]);
            const [failurePhrase, setFailurePhrase] = useState(null);
            const [selectedOption, setSelectedOption] = useState(null); // Nuevo estado para saber qu√© bot√≥n se puls√≥

            const allTypes = useMemo(() => ['Todos', ...new Set(rawData.map(i => i.type))], []);

            const toggleType = (type) => {
                if (type === 'Todos') {
                    setSelectedTypes(['Todos']);
                    return;
                }
                let newTypes = selectedTypes.filter(t => t !== 'Todos');
                if (selectedTypes.includes(type)) {
                    newTypes = newTypes.filter(t => t !== type);
                } else {
                    newTypes = [...newTypes, type];
                }
                if (newTypes.length === 0) newTypes = ['Todos'];
                setSelectedTypes(newTypes);
            };

            const startGame = () => {
                // 1. Determinar tipos seleccionados
                let typesToUse = [];
                if (selectedTypes.includes('Todos')) {
                    // Obtener todos los tipos √∫nicos de rawData
                    typesToUse = [...new Set(rawData.map(i => i.type))];
                } else {
                    typesToUse = [...selectedTypes];
                }

                // 2. Seleccionar preguntas equitativamente entre los tipos
                let selectedItems = [];
                // Barajamos los tipos para que el reparto del "resto" sea aleatorio
                typesToUse.sort(() => 0.5 - Math.random());
                
                const baseCountPerType = Math.floor(questionCount / typesToUse.length);
                let remainder = questionCount % typesToUse.length;

                typesToUse.forEach(type => {
                    // Filtrar items de este tipo
                    const itemsOfType = rawData.filter(i => i.type === type);
                    // Determinar cu√°ntos coger: base + 1 si hay resto disponible
                    let countToTake = baseCountPerType;
                    if (remainder > 0) {
                        countToTake++;
                        remainder--;
                    }
                    
                    // Coger aleatoriamente
                    const itemsTaken = itemsOfType.sort(() => 0.5 - Math.random()).slice(0, countToTake);
                    selectedItems = [...selectedItems, ...itemsTaken];
                });

                // Barajar las preguntas seleccionadas para que no salgan por bloques de tipos
                selectedItems.sort(() => 0.5 - Math.random());

                // 3. Preparar distribuci√≥n 50/50 de F√≥rmula/Nombre
                // Crear array con mitad true, mitad false
                const halfCount = Math.floor(selectedItems.length / 2);
                let modes = Array(selectedItems.length).fill(false); // Llenar todo con false (Nombre -> F√≥rmula)
                for (let i = 0; i < halfCount; i++) modes[i] = true; // Poner la mitad a true (F√≥rmula -> Nombre)
                
                // Barajar los modos
                modes.sort(() => 0.5 - Math.random());
                
                const preparedQuestions = selectedItems.map((item, index) => {
                    const isFormulaToName = modes[index]; // Usar el modo pre-calculado
                    
                    const target = isFormulaToName ? item.name : item.formula;
                    const prompt = isFormulaToName ? item.formula : item.name;
                    const mode = isFormulaToName ? 'name' : 'formula'; 

                    const distractors = generateSmartDistractors(target, rawData, mode);
                    const options = [target, ...distractors].sort(() => 0.5 - Math.random());

                    return { item, mode, prompt, correct: target, options, isFormulaToName };
                });

                setQuestions(preparedQuestions);
                setCurrentIndex(0);
                setCorrectCount(0);
                setIncorrectCount(0);
                setHistory([]);
                setFeedback(null);
                setSelectedOption(null);
                setShowOptions(false);
                setGameState('playing');
            };

            const handleAnswer = (answer) => {
                const currentQ = questions[currentIndex];
                const isCorrect = answer === currentQ.correct;
                
                setSelectedOption(answer); // Guardamos la opci√≥n elegida

                if (isCorrect) {
                    setCorrectCount(c => c + 1);
                    setFeedback('correct');
                    setFailurePhrase(null);
                } else {
                    setIncorrectCount(c => c + 1);
                    setFeedback('incorrect');
                    setFailurePhrase(FAILURE_PHRASES[Math.floor(Math.random() * FAILURE_PHRASES.length)]);
                }
                
                setHistory([...history, { ...currentQ, userAnswer: answer, isCorrect }]);

                setTimeout(() => {
                    if (currentIndex < questions.length - 1) {
                        setCurrentIndex(c => c + 1);
                        setShowOptions(false);
                        setFeedback(null);
                        setFailurePhrase(null);
                        setSelectedOption(null);
                    } else {
                        setGameState('finished');
                    }
                }, 3000);
            };

            const bgStyle = "bg-slate-900 bg-[radial-gradient(ellipse_at_top,_var(--tw-gradient-stops))] from-slate-800 via-slate-900 to-black min-h-screen text-white font-sans selection:bg-indigo-500 selection:text-white";

            if (gameState === 'setup') {
                return (
                    <div className={bgStyle + " flex items-center justify-center p-4 min-h-screen"}>
                        <div className="bg-white/10 backdrop-blur-lg border border-white/20 rounded-3xl p-6 md:p-8 w-full max-w-2xl shadow-2xl relative overflow-hidden">
                            <div className="absolute -top-20 -right-20 w-60 h-60 bg-indigo-600/30 rounded-full blur-3xl pointer-events-none"></div>
                            <div className="absolute -bottom-20 -left-20 w-60 h-60 bg-pink-600/30 rounded-full blur-3xl pointer-events-none"></div>

                            <div className="relative z-10">
                                <div className="text-center mb-6">
                                    <div className="inline-flex items-center justify-center p-4 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-2xl shadow-lg mb-4 transform hover:rotate-6 transition-transform">
                                        <Atom className="w-10 h-10 text-white" />
                                    </div>
                                    <h1 className="text-3xl md:text-5xl font-black bg-clip-text text-transparent bg-gradient-to-r from-white to-slate-400 mb-2">Formulaci√≥n Pro</h1>
                                    <p className="text-slate-300 text-sm md:text-lg font-medium mb-4">Entrenador de Alto Rendimiento</p>
                                    <div className="inline-block px-4 py-1 rounded-full bg-white/10 border border-white/20 text-indigo-300 text-xs md:text-sm font-bold tracking-wide">
                                        Realizado por Javier Gij√≥n. Profesor del IES Maria Moliner de Segovia
                                    </div>
                                </div>

                                <div className="space-y-6">
                                    <div>
                                        <label className="flex items-center gap-2 text-xs font-bold text-indigo-300 mb-3 uppercase tracking-[0.2em]">
                                            <BookOpen className="w-4 h-4" /> Configuraci√≥n de Temas
                                        </label>
                                        <div className="flex flex-wrap gap-2 justify-center md:justify-start">
                                            {allTypes.map(type => (
                                                <button
                                                    key={type}
                                                    onClick={() => toggleType(type)}
                                                    className={`px-3 py-2 rounded-lg text-xs font-bold transition-all duration-300 border backdrop-blur-md flex-grow md:flex-grow-0 touch-manipulation ${
                                                        selectedTypes.includes(type)
                                                            ? 'bg-indigo-600/80 border-indigo-400 text-white shadow-[0_0_15px_rgba(99,102,241,0.5)] transform scale-105'
                                                            : 'bg-white/5 border-white/10 text-slate-400 hover:bg-white/10 hover:border-white/30'
                                                    }`}
                                                >
                                                    {type}
                                                </button>
                                            ))}
                                        </div>
                                    </div>

                                    <div>
                                        <label className="flex items-center gap-2 text-xs font-bold text-pink-300 mb-2 uppercase tracking-[0.2em]">
                                            <Zap className="w-4 h-4" /> Intensidad ({questionCount} Preguntas)
                                        </label>
                                        <input 
                                            type="range" 
                                            min="5" 
                                            max="50" 
                                            step="5"
                                            value={questionCount}
                                            onChange={(e) => setQuestionCount(parseInt(e.target.value))}
                                            className="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-pink-500 hover:accent-pink-400 touch-manipulation"
                                        />
                                    </div>

                                    <button
                                        onClick={startGame}
                                        className="group w-full py-4 bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-500 hover:to-purple-500 text-white rounded-2xl font-bold text-xl shadow-lg hover:shadow-indigo-500/30 transform hover:-translate-y-1 transition-all flex items-center justify-center gap-3 relative overflow-hidden active:scale-95 touch-manipulation"
                                    >
                                        <div className="absolute inset-0 bg-white/20 translate-y-full group-hover:translate-y-0 transition-transform duration-300 ease-out skew-y-12"></div>
                                        <Play className="w-6 h-6 fill-current relative z-10" />
                                        <span className="relative z-10">EMPEZAR PARTIDA</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            if (gameState === 'finished') {
                const percentage = Math.round((correctCount / questions.length) * 100);
                return (
                    <div className={bgStyle + " flex items-center justify-center p-2 md:p-4 min-h-screen"}>
                        <div className="bg-white/10 backdrop-blur-xl border border-white/20 rounded-3xl p-4 md:p-8 w-full max-w-4xl shadow-2xl h-[95vh] md:max-h-[90vh] flex flex-col">
                            <div className="text-center mb-4 md:mb-8 border-b border-white/10 pb-4 md:pb-6 flex-shrink-0">
                                <div className="inline-block p-3 md:p-4 rounded-full bg-gradient-to-br from-yellow-400 to-orange-500 mb-2 md:mb-4 shadow-lg shadow-orange-500/30">
                                    <Award className="w-8 h-8 md:w-12 md:h-12 text-white" />
                                </div>
                                <h2 className="text-2xl md:text-3xl font-bold text-white mb-4">Resultados</h2>
                                
                                <div className="grid grid-cols-3 gap-2 md:gap-4 max-w-lg mx-auto">
                                    <div className="bg-green-500/20 p-2 md:p-4 rounded-xl md:rounded-2xl border border-green-500/30 backdrop-blur-sm">
                                        <div className="text-2xl md:text-3xl font-black text-green-400">{correctCount}</div>
                                        <div className="text-[8px] md:text-[10px] uppercase font-bold text-green-200/60 tracking-widest mt-1">Aciertos</div>
                                    </div>
                                    <div className="bg-red-500/20 p-2 md:p-4 rounded-xl md:rounded-2xl border border-red-500/30 backdrop-blur-sm">
                                        <div className="text-2xl md:text-3xl font-black text-red-400">{incorrectCount}</div>
                                        <div className="text-[8px] md:text-[10px] uppercase font-bold text-red-200/60 tracking-widest mt-1">Fallos</div>
                                    </div>
                                    <div className="bg-blue-500/20 p-2 md:p-4 rounded-xl md:rounded-2xl border border-blue-500/30 backdrop-blur-sm">
                                        <div className="text-2xl md:text-3xl font-black text-blue-400">{percentage}%</div>
                                        <div className="text-[8px] md:text-[10px] uppercase font-bold text-blue-200/60 tracking-widest mt-1">Precisi√≥n</div>
                                    </div>
                                </div>
                            </div>

                            <div className="flex-grow overflow-y-auto pr-2 custom-scrollbar">
                                <table className="w-full text-left border-collapse">
                                    <thead className="sticky top-0 bg-slate-900/90 backdrop-blur-md z-10">
                                        <tr>
                                            <th className="py-2 px-2 md:py-3 md:px-4 text-slate-400 font-bold text-[10px] md:text-xs uppercase tracking-wider rounded-l-lg">Pregunta</th>
                                            <th className="py-2 px-2 md:py-3 md:px-4 text-slate-400 font-bold text-[10px] md:text-xs uppercase tracking-wider">Tu Respuesta</th>
                                            <th className="py-2 px-2 md:py-3 md:px-4 text-slate-400 font-bold text-[10px] md:text-xs uppercase tracking-wider text-right rounded-r-lg">Correcta</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-white/5">
                                        {history.map((h, i) => (
                                            <tr key={i} className="hover:bg-white/5 transition-colors group">
                                                <td className="py-2 px-2 md:py-4 md:px-4 font-medium text-white text-xs md:text-base">
                                                    <div className="flex flex-col">
                                                        <span>{h.isFormulaToName ? <SubscriptText text={h.prompt} /> : h.prompt}</span>
                                                        <span className="text-[8px] md:text-[10px] text-slate-500 font-bold uppercase">{h.item.type}</span>
                                                    </div>
                                                </td>
                                                <td className={`py-2 px-2 md:py-4 md:px-4 font-medium text-xs md:text-base ${h.isCorrect ? 'text-green-400' : 'text-red-400 line-through decoration-red-500/50'}`}>
                                                    {!h.isFormulaToName ? <SubscriptText text={h.userAnswer} /> : h.userAnswer}
                                                </td>
                                                <td className="py-2 px-2 md:py-4 md:px-4 text-right text-indigo-300 font-medium text-xs md:text-base">
                                                    {!h.isFormulaToName ? <SubscriptText text={h.correct} /> : h.correct}
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>

                            <div className="mt-4 md:mt-6 flex-shrink-0">
                                <button
                                    onClick={() => setGameState('setup')}
                                    className="w-full py-3 md:py-4 bg-slate-800 hover:bg-slate-700 text-white rounded-2xl font-bold text-base md:text-lg shadow-lg border border-white/10 transition-all flex items-center justify-center gap-2 active:scale-95 touch-manipulation"
                                >
                                    <RefreshCw className="w-5 h-5" />
                                    NUEVA SESI√ìN
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }

            const currentQ = questions[currentIndex];

            return (
                <div className={bgStyle + " flex flex-col items-center pt-4 md:pt-8 px-2 md:px-4 pb-4 min-h-screen"}>
                    
                    {/* HUD SUPERIOR */}
                    <div className="w-full max-w-4xl bg-white/5 backdrop-blur-md rounded-2xl border border-white/10 p-2 md:p-4 mb-4 md:mb-8 flex justify-between items-center shadow-lg">
                        <div className="flex gap-4 md:gap-8">
                            <div className="flex flex-col items-center px-2">
                                <span className="text-xl md:text-2xl font-black text-green-400 drop-shadow-[0_0_10px_rgba(74,222,128,0.5)]">{correctCount}</span>
                                <span className="text-[8px] md:text-[10px] font-bold text-slate-400 uppercase tracking-widest">Bien</span>
                            </div>
                            <div className="flex flex-col items-center px-2 border-l border-white/10 pl-4 md:pl-8">
                                <span className="text-xl md:text-2xl font-black text-red-400 drop-shadow-[0_0_10px_rgba(248,113,113,0.5)]">{incorrectCount}</span>
                                <span className="text-[8px] md:text-[10px] font-bold text-slate-400 uppercase tracking-widest">Mal</span>
                            </div>
                        </div>
                        <div className="text-right">
                            <div className="text-[8px] md:text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">Pregunta</div>
                            <div className="text-base md:text-xl font-bold text-white tracking-wider">
                                {currentIndex + 1} <span className="text-slate-500 text-xs md:text-base">/ {questions.length}</span>
                            </div>
                        </div>
                    </div>

                    {/* TARJETA DE JUEGO */}
                    <div className="w-full max-w-4xl bg-slate-800/50 backdrop-blur-xl rounded-3xl shadow-2xl overflow-hidden border border-white/10 min-h-[60vh] md:min-h-[550px] flex flex-col relative transition-all duration-500">
                        
                        {/* Barra de Progreso */}
                        <div className="h-1 bg-slate-700 w-full">
                            <div 
                                className="h-full bg-gradient-to-r from-indigo-500 to-pink-500 transition-all duration-700 ease-out shadow-[0_0_10px_rgba(236,72,153,0.5)]"
                                style={{ width: `${((currentIndex) / questions.length) * 100}%` }}
                            />
                        </div>

                        {/* Zona de Pregunta */}
                        <div className="p-6 md:p-12 flex flex-col items-center justify-center border-b border-white/5 flex-grow relative bg-white/[0.02]">
                            <span className="absolute top-4 left-4 md:top-6 md:left-6 text-[8px] md:text-[10px] font-bold tracking-[0.2em] text-indigo-400 uppercase bg-indigo-500/10 px-3 py-1 rounded-full border border-indigo-500/20">
                                {currentQ.item.type}
                            </span>
                            <span className="absolute top-4 right-4 md:top-6 md:right-6 text-[8px] md:text-[10px] font-bold tracking-[0.2em] text-slate-500 uppercase">
                                {currentQ.isFormulaToName ? "NOMBRA" : "FORMULA"}
                            </span>
                            
                            <div className="text-center w-full mt-4">
                                <div className="mb-4 md:mb-8 transform transition-all duration-500">
                                    {currentQ.isFormulaToName ? (
                                        <div className="text-5xl md:text-8xl text-white font-bold drop-shadow-2xl font-mono break-all">
                                            <SubscriptText text={currentQ.prompt} />
                                        </div>
                                    ) : (
                                        <h2 className="text-2xl md:text-5xl font-black text-transparent bg-clip-text bg-gradient-to-r from-white to-slate-300 leading-tight drop-shadow-lg break-words">
                                            {currentQ.prompt}
                                        </h2>
                                    )}
                                </div>
                            </div>
                        </div>

                        {/* Zona de Interacci√≥n */}
                        <div className="p-4 md:p-8 bg-slate-900/50 flex flex-col justify-center min-h-[250px] md:min-h-[300px] relative">
                            
                            {!showOptions ? (
                                <div className="text-center space-y-4 md:space-y-6 animate-in fade-in slide-in-from-bottom-4 duration-500">
                                    <div className="w-12 h-12 md:w-16 md:h-16 bg-white/5 rounded-full flex items-center justify-center mx-auto mb-2 md:mb-4 animate-pulse">
                                        <Eye className="w-6 h-6 md:w-8 md:h-8 text-indigo-400" />
                                    </div>
                                    <p className="text-slate-400 font-medium italic text-sm md:text-base px-4">
                                        Piensa la respuesta antes de ver las opciones...
                                    </p>
                                    <button
                                        onClick={() => setShowOptions(true)}
                                        className="mx-auto w-full md:w-auto px-10 py-4 bg-indigo-600 hover:bg-indigo-500 text-white rounded-2xl font-bold text-lg transition-all shadow-lg hover:shadow-indigo-500/40 hover:-translate-y-1 flex items-center justify-center gap-3 active:scale-95 touch-manipulation"
                                    >
                                        MOSTRAR OPCIONES
                                    </button>
                                </div>
                            ) : (
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-3 md:gap-4 animate-in zoom-in-95 duration-300">
                                    {currentQ.options.map((option, idx) => {
                                        let btnClass = "relative p-3 md:p-4 rounded-xl font-bold text-sm md:text-base border-2 transition-all flex items-center justify-center text-center min-h-[60px] md:min-h-[70px] group touch-manipulation ";
                                        
                                        if (feedback) {
                                            if (option === currentQ.correct) {
                                                btnClass += "bg-green-500/20 border-green-500 text-green-300 shadow-[0_0_20px_rgba(34,197,94,0.3)] z-10 ";
                                            } else if (option !== currentQ.correct && feedback === 'incorrect') {
                                                btnClass += "bg-slate-800 border-slate-700 text-slate-600 opacity-50 blur-[1px] ";
                                            } else {
                                                btnClass += "bg-slate-800 border-slate-700 text-slate-600 opacity-50 ";
                                            }
                                        } else {
                                            btnClass += "bg-white/5 border-white/10 text-slate-200 hover:border-indigo-500 hover:bg-indigo-500/10 hover:text-white hover:shadow-[0_0_15px_rgba(99,102,241,0.3)] cursor-pointer active:scale-95 active:bg-indigo-500/20 ";
                                        }

                                        // Determinamos si este bot√≥n espec√≠fico debe explotar (ser la opci√≥n incorrecta seleccionada)
                                        const isSelectedWrongOption = feedback === 'incorrect' && option === selectedOption;

                                        return (
                                            <button
                                                key={idx}
                                                disabled={feedback !== null}
                                                onClick={() => handleAnswer(option)}
                                                className={btnClass}
                                            >
                                                <span className="drop-shadow-md break-words w-full">
                                                    {!currentQ.isFormulaToName ? <SubscriptText text={option} /> : option}
                                                </span>
                                                
                                                {feedback === 'correct' && option === currentQ.correct && (
                                                    <>
                                                        <FireworkExplosion />
                                                        <div className="absolute top-2 right-2 bg-green-500 rounded-full p-1 animate-bounce z-20">
                                                            <CheckCircle className="w-4 h-4 text-white" />
                                                        </div>
                                                    </>
                                                )}
                                                
                                                {/* Animaci√≥n de explosi√≥n en el bot√≥n err√≥neo seleccionado */}
                                                {isSelectedWrongOption && (
                                                    <ErrorExplosion />
                                                )}

                                                {feedback === 'incorrect' && option === currentQ.correct && (
                                                    <div className="absolute -top-3 -right-3 bg-green-500 text-white text-[10px] font-bold px-3 py-1 rounded-full shadow-lg z-20 animate-bounce">
                                                        ¬°ERA ESTA!
                                                    </div>
                                                )}
                                            </button>
                                        );
                                    })}
                                </div>
                            )}
                            
                            {feedback === 'incorrect' && failurePhrase && (
                                <div className="absolute inset-x-0 bottom-6 mx-auto w-[90%] md:w-max px-4 md:px-8 py-3 md:py-4 bg-red-600 text-white rounded-2xl font-black text-lg md:text-2xl border-4 border-red-400 shadow-[0_0_40px_rgba(239,68,68,0.6)] animate-[shake_0.5s_ease-in-out] flex items-center justify-center gap-3 z-30 uppercase tracking-widest transform text-center break-words">
                                    <AlertTriangle className="w-6 h-6 md:w-8 md:h-8 animate-pulse flex-shrink-0" /> 
                                    <span>{failurePhrase}</span>
                                </div>
                            )}
                            {feedback === 'correct' && (
                                <div className="absolute inset-x-0 bottom-6 mx-auto w-max px-6 py-3 bg-green-500/90 text-white rounded-full font-bold border border-green-400 shadow-[0_0_30px_rgba(34,197,94,0.5)] animate-in fade-in slide-in-from-bottom-2 flex items-center gap-2 z-30">
                                    <CheckCircle className="w-5 h-5" /> ¬°Correcto!
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<FormulacionApp />);
    </script>
</body>
</html>
