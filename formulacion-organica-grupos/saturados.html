<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nomenclatura Hidrocarburos Saturados</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@700&family=Inter:wght@400;600;800&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .chem-text { font-family: 'Roboto Mono', monospace; font-weight: bold; }
        svg { width: 100%; height: auto; display: block; transition: all 0.3s ease-in-out; }
        .formula-card { background: radial-gradient(circle at center, #ffffff 0%, #f8fafc 100%); }
        .btn-fancy { transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); }
        .btn-fancy:active { transform: scale(0.95); }
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    </style>
</head>
<body class="bg-slate-100 min-h-screen flex items-center justify-center p-2 md:p-4">

    <div id="app" class="bg-white shadow-2xl rounded-3xl p-4 md:p-8 w-full max-w-5xl border border-slate-200 overflow-hidden">
        
        <!-- PANTALLA DE INICIO -->
        <div id="home-screen" class="py-10 text-center">
            <div class="inline-block p-4 bg-indigo-50 rounded-full mb-6">
                <span class="text-6xl">üß™</span>
            </div>
            <h1 class="text-3xl md:text-4xl font-black text-indigo-900 uppercase tracking-tighter mb-2">Hidrocarburos Saturados</h1>
            <p class="text-slate-500 font-medium mb-8 italic">Algoritmo de no repetici√≥n y revisi√≥n t√©cnica</p>
            
            <div class="max-w-xs mx-auto space-y-4">
                <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2 text-center text-balance">¬øCu√°ntos compuestos quieres practicar hoy?</p>
                <button onclick="setupQuiz(5)" class="btn-fancy w-full bg-white border-2 border-indigo-600 text-indigo-600 font-black py-4 rounded-2xl hover:bg-indigo-50 text-xl shadow-lg shadow-indigo-100">
                    5 Ejercicios
                </button>
                <button onclick="setupQuiz(10)" class="btn-fancy w-full bg-indigo-600 text-white font-black py-4 rounded-2xl hover:bg-indigo-700 text-xl shadow-lg shadow-indigo-200">
                    10 Ejercicios
                </button>
                <button onclick="resetGlobalHistory()" class="text-[9px] text-slate-400 uppercase font-bold hover:text-red-500 mt-6 block w-full underline decoration-dotted">
                    Reiniciar mazo (Borrar memoria de vistos)
                </button>
            </div>
            
            <p id="global-stats-text" class="mt-10 text-[11px] text-slate-500 font-bold uppercase tracking-widest bg-slate-50 inline-block px-4 py-2 rounded-full border border-slate-100"></p>
        </div>

        <!-- PANTALLA DE JUEGO -->
        <div id="quiz-screen" class="hidden">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-3">
                <div>
                    <h1 class="text-xl md:text-2xl font-black text-indigo-900 uppercase tracking-tighter leading-none">Desaf√≠o IUPAC</h1>
                    <p class="text-[10px] text-indigo-900 font-bold uppercase tracking-widest italic mt-1">Programa realizado por Javier Gij√≥n. Prof del IES Mar√≠a Moliner de Segovia</p>
                </div>
                <div class="flex items-center gap-3 w-full md:w-auto">
                    <div class="flex-1 md:flex-none text-right">
                        <span id="progress-text" class="block text-[9px] font-bold text-slate-400 mb-1 tracking-widest uppercase text-nowrap">Ejercicio 1 / 10</span>
                        <div class="w-full md:w-32 h-1.5 bg-slate-100 rounded-full overflow-hidden border">
                            <div id="progress-bar" class="h-full bg-indigo-500 transition-all duration-500" style="width: 5%"></div>
                        </div>
                    </div>
                    <span id="score-badge" class="bg-indigo-600 text-white px-3 py-1.5 rounded-xl text-xs font-black shadow-lg italic">0 Pts</span>
                </div>
            </div>

            <!-- Visualizador Adaptativo -->
            <div class="formula-card rounded-2xl p-4 md:p-6 mb-6 border border-slate-100 shadow-inner flex items-center justify-center overflow-hidden min-h-[280px]">
                <div id="visual-formula-container" class="w-full flex justify-center items-center"></div>
            </div>

            <div class="max-w-xl mx-auto space-y-4">
                <input type="text" id="answer-input" 
                    class="w-full px-4 py-4 bg-slate-50 border-2 border-slate-200 rounded-2xl text-lg md:text-2xl outline-none focus:border-indigo-500 focus:ring-4 focus:ring-indigo-100 transition-all text-center font-bold text-slate-700 placeholder-slate-300 shadow-sm"
                    placeholder="Escribe el nombre aqu√≠..."
                    autocomplete="off">
                
                <button onclick="handleCheck()" id="submit-btn"
                    class="btn-fancy w-full bg-indigo-600 hover:bg-indigo-700 text-white font-black py-4 rounded-2xl transition-all shadow-xl shadow-indigo-200 text-sm md:text-lg uppercase tracking-widest">
                    Verificar
                </button>

                <button onclick="nextQuestion()" id="next-btn"
                    class="hidden btn-fancy w-full bg-emerald-500 hover:bg-emerald-600 text-white font-black py-4 rounded-2xl transition-all shadow-xl shadow-emerald-200 text-sm md:text-lg uppercase tracking-widest flex items-center justify-center gap-2">
                    Siguiente compuesto <span class="text-xl">‚Üí</span>
                </button>
            </div>

            <div id="message-box" class="mt-6 p-4 rounded-2xl hidden text-center font-bold text-xs md:text-sm border-2"></div>
        </div>

        <!-- PANTALLA DE RESULTADOS (RESUMEN TABULAR) -->
        <div id="result-screen" class="hidden flex flex-col h-full max-h-[85vh]">
            <div class="text-center mb-6">
                <div class="inline-block p-4 bg-indigo-100 rounded-full mb-2 text-3xl">üìù</div>
                <h2 class="text-2xl md:text-3xl font-black text-slate-800 uppercase tracking-tighter">Resumen de Evaluaci√≥n</h2>
                <p id="final-stats" class="text-slate-500 font-bold text-sm uppercase"></p>
            </div>

            <div class="flex-1 overflow-y-auto custom-scroll pr-2 border-y border-slate-100 py-4">
                <table class="w-full text-left border-collapse">
                    <thead class="sticky top-0 bg-white z-10">
                        <tr class="text-[10px] font-black text-slate-400 uppercase tracking-widest border-b border-slate-200">
                            <th class="pb-3 pl-2">Estructura</th>
                            <th class="pb-3">Tu Respuesta</th>
                            <th class="pb-3">Correcci√≥n</th>
                        </tr>
                    </thead>
                    <tbody id="results-table-body" class="divide-y divide-slate-50">
                        <!-- Filas generadas por JS -->
                    </tbody>
                </table>
            </div>

            <div class="pt-6 text-center">
                <button onclick="goToHome()" 
                    class="btn-fancy bg-slate-900 hover:bg-black text-white font-black py-4 px-10 rounded-2xl transition-all shadow-2xl uppercase tracking-widest text-xs">
                    Volver al Inicio
                </button>
            </div>
        </div>
    </div>

    <script>
        /**
         * MOTOR DE DIBUJO SVG MEJORADO
         */
        function formatChemSVG(text, x, y, fontSize, color) {
            let svgText = `<text x="${x}" y="${y}" text-anchor="middle" dominant-baseline="middle" font-family="Roboto Mono" font-weight="bold" font-size="${fontSize}" fill="${color}">`;
            for (let char of text) {
                if (/\d/.test(char)) {
                    svgText += `<tspan dy="0.35em" font-size="0.65em">${char}</tspan><tspan dy="-0.22em"> </tspan>`;
                } else {
                    svgText += char;
                }
            }
            svgText += `</text>`;
            return svgText;
        }

        function drawAlkane(chainLength, substituents, mini = false) {
            const spacingX = mini ? 60 : 100;
            const spacingY = mini ? 35 : 60; 
            const fontSize = mini ? 12 : 18;

            let maxLevelsUp = 0;
            let maxLevelsDown = 0;

            substituents.forEach(s => {
                let levels = 1;
                if (s.type === 'CH2CH3') levels = 2;
                if (s.type === 'CH2CH2CH3') levels = 3;
                if (s.type === 'CH(CH3)2') levels = 2;
                if (s.dir === 'up') maxLevelsUp = Math.max(maxLevelsUp, levels);
                if (s.dir === 'down') maxLevelsDown = Math.max(maxLevelsDown, levels);
            });

            const margin = mini ? 20 : 50;
            const dynamicHeight = (maxLevelsUp + maxLevelsDown) * spacingY + (margin * 2);
            const midY = (maxLevelsUp * spacingY) + margin;
            const width = (chainLength + 1) * spacingX;

            let svg = `<svg viewBox="0 0 ${width} ${dynamicHeight}" preserveAspectRatio="xMidYMid meet" xmlns="http://www.w3.org/2000/svg" style="${mini ? 'max-height: 80px;' : ''}">`;

            for (let i = 0; i < chainLength; i++) {
                const x = (i + 1) * spacingX;
                if (i < chainLength - 1) {
                    svg += `<line x1="${x + (mini ? 15 : 22)}" y1="${midY}" x2="${x + spacingX - (mini ? 15 : 22)}" y2="${midY}" stroke="#e2e8f0" stroke-width="${mini ? 2 : 3}" stroke-linecap="round" />`;
                }

                const subsC = substituents.filter(s => s.pos === i + 1);
                let hCount = (i === 0 || i === chainLength - 1) ? 3 : 2;
                hCount -= subsC.length;
                let carbonText = hCount > 0 ? (hCount > 1 ? `CH${hCount}` : "CH") : "C";

                subsC.forEach(s => {
                    const multiplier = s.dir === 'up' ? -1 : 1;
                    let parts = [];
                    if (s.type === 'CH3') parts = ['CH3'];
                    if (s.type === 'CH2CH3') parts = ['CH2', 'CH3'];
                    if (s.type === 'CH2CH2CH3') parts = ['CH2', 'CH2', 'CH3'];
                    if (s.type === 'CH(CH3)2') parts = ['CH', 'FORK_ISO']; 

                    let currentY = midY;
                    parts.forEach((p) => {
                        const nextY = currentY + (multiplier * spacingY);
                        const lineOff = mini ? 10 : 18;
                        if (p === 'FORK_ISO') {
                            const fXL = x - (mini ? 20 : 35), fXR = x + (mini ? 20 : 35), fY = currentY + (multiplier * (mini ? 25 : 45));
                            svg += `<line x1="${x}" y1="${currentY + (multiplier * (mini ? 10 : 18))}" x2="${fXL}" y2="${fY - (multiplier * 8)}" stroke="#94a3b8" stroke-width="${mini ? 1.5 : 2.5}" />`;
                            svg += `<line x1="${x}" y1="${currentY + (multiplier * (mini ? 10 : 18))}" x2="${fXR}" y2="${fY - (multiplier * 8)}" stroke="#94a3b8" stroke-width="${mini ? 1.5 : 2.5}" />`;
                            svg += formatChemSVG("CH3", fXL, fY, fontSize, "#2563eb");
                            svg += formatChemSVG("CH3", fXR, fY, fontSize, "#2563eb");
                        } else {
                            svg += `<line x1="${x}" y1="${currentY + (multiplier * lineOff)}" x2="${x}" y2="${nextY - (multiplier * lineOff)}" stroke="#94a3b8" stroke-width="${mini ? 1.5 : 2.5}" />`;
                            svg += formatChemSVG(p, x, nextY, fontSize, "#2563eb");
                            currentY = nextY;
                        }
                    });
                });
                svg += formatChemSVG(carbonText, x, midY, fontSize, "#1e293b");
            }
            return svg + `</svg>`;
        }

        /**
         * BASE DE DATOS DE 50 COMPUESTOS (ID √öNICOS)
         */
        const DB = [
            { id: 1, chain: 3, subs: [{pos: 2, type: 'CH3', dir: 'up'}], nombres: ["2-metilpropano", "metilpropano"] },
            { id: 2, chain: 3, subs: [{pos: 2, type: 'CH3', dir: 'up'}, {pos: 2, type: 'CH3', dir: 'down'}], nombres: ["2,2-dimetilpropano", "dimetilpropano"] },
            { id: 3, chain: 4, subs: [{pos: 2, type: 'CH3', dir: 'up'}], nombres: ["2-metilbutano", "metilbutano"] },
            { id: 4, chain: 4, subs: [{pos: 2, type: 'CH3', dir: 'up'}, {pos: 3, type: 'CH3', dir: 'down'}], nombres: ["2,3-dimetilbutano"] },
            { id: 5, chain: 4, subs: [{pos: 2, type: 'CH3', dir: 'up'}, {pos: 2, type: 'CH3', dir: 'down'}], nombres: ["2,2-dimetilbutano"] },
            { id: 6, chain: 4, subs: [{pos: 2, type: 'CH2CH3', dir: 'up'}], nombres: ["3-metilpentano"] }, 
            { id: 7, chain: 5, subs: [{pos: 2, type: 'CH3', dir: 'up'}], nombres: ["2-metilpentano"] },
            { id: 8, chain: 5, subs: [{pos: 3, type: 'CH3', dir: 'up'}], nombres: ["3-metilpentano"] },
            { id: 9, chain: 5, subs: [{pos: 2, type: 'CH3', dir: 'up'}, {pos: 3, type: 'CH3', dir: 'down'}], nombres: ["2,3-dimetilpentano"] },
            { id: 10, chain: 5, subs: [{pos: 2, type: 'CH3', dir: 'up'}, {pos: 4, type: 'CH3', dir: 'up'}], nombres: ["2,4-dimetilpentano"] },
            { id: 11, chain: 5, subs: [{pos: 3, type: 'CH2CH3', dir: 'up'}], nombres: ["3-etilpentano"] },
            { id: 12, chain: 5, subs: [{pos: 2, type: 'CH3', dir: 'up'}, {pos: 2, type: 'CH3', dir: 'down'}], nombres: ["2,2-dimetilpentano"] },
            { id: 13, chain: 5, subs: [{pos: 3, type: 'CH3', dir: 'up'}, {pos: 3, type: 'CH3', dir: 'down'}], nombres: ["3,3-dimetilpentano"] },
            { id: 14, chain: 5, subs: [{pos: 2, type: 'CH3', dir: 'up'}, {pos: 2, type: 'CH3', dir: 'down'}, {pos: 3, type: 'CH3', dir: 'up'}], nombres: ["2,2,3-trimetilpentano"] },
            // CORREGIDO IUPAC: Prioridad a la cadena m√°s sustituida (Etil+Metil vs Isopropil)
            { id: 15, chain: 5, subs: [{pos: 3, type: 'CH(CH3)2', dir: 'up'}], nombres: ["3-etil-2-metilpentano", "3-isopropilpentano"] },
            { id: 16, chain: 6, subs: [{pos: 2, type: 'CH3', dir: 'up'}], nombres: ["2-metilhexano"] },
            { id: 17, chain: 6, subs: [{pos: 3, type: 'CH3', dir: 'down'}], nombres: ["3-metilhexano"] },
            { id: 18, chain: 6, subs: [{pos: 3, type: 'CH2CH3', dir: 'up'}], nombres: ["3-etilhexano"] },
            { id: 19, chain: 6, subs: [{pos: 2, type: 'CH3', dir: 'up'}, {pos: 3, type: 'CH3', dir: 'down'}], nombres: ["2,3-dimetilhexano"] },
            { id: 20, chain: 6, subs: [{pos: 2, type: 'CH3', dir: 'up'}, {pos: 4, type: 'CH3', dir: 'up'}], nombres: ["2,4-dimetilhexano"] },
            { id: 21, chain: 6, subs: [{pos: 2, type: 'CH3', dir: 'up'}, {pos: 5, type: 'CH3', dir: 'down'}], nombres: ["2,5-dimetilhexano"] },
            { id: 22, chain: 6, subs: [{pos: 3, type: 'CH2CH3', dir: 'up'}, {pos: 2, type: 'CH3', dir: 'down'}], nombres: ["3-etil-2-metilhexano"] },
            { id: 23, chain: 6, subs: [{pos: 3, type: 'CH2CH3', dir: 'up'}, {pos: 4, type: 'CH3', dir: 'down'}], nombres: ["3-etil-4-metilhexano"] },
            // CORREGIDO IUPAC: Prioridad a la cadena m√°s sustituida (Etil+Metil vs Isopropil)
            { id: 24, chain: 6, subs: [{pos: 3, type: 'CH(CH3)2', dir: 'up'}], nombres: ["3-etil-2-metilhexano", "3-isopropilhexano"] },
            { id: 25, chain: 6, subs: [{pos: 3, type: 'CH2CH3', dir: 'up'}, {pos: 3, type: 'CH2CH3', dir: 'down'}], nombres: ["3,3-dietilhexano"] },
            { id: 26, chain: 6, subs: [{pos: 2, type: 'CH3', dir: 'up'}, {pos: 2, type: 'CH3', dir: 'down'}, {pos: 4, type: 'CH3', dir: 'up'}], nombres: ["2,2,4-trimetilhexano"] },
            { id: 27, chain: 6, subs: [{pos: 2, type: 'CH3', dir: 'up'}, {pos: 4, type: 'CH3', dir: 'down'}, {pos: 4, type: 'CH3', dir: 'up'}], nombres: ["2,4,4-trimetilhexano"] },
            { id: 28, chain: 6, subs: [{pos: 2, type: 'CH3', dir: 'up'}, {pos: 3, type: 'CH3', dir: 'down'}, {pos: 4, type: 'CH3', dir: 'up'}], nombres: ["2,3,4-trimetilhexano"] },
            { id: 29, chain: 7, subs: [{pos: 2, type: 'CH3', dir: 'up'}], nombres: ["2-metilheptano"] },
            { id: 30, chain: 7, subs: [{pos: 3, type: 'CH3', dir: 'down'}], nombres: ["3-metilheptano"] },
            { id: 31, chain: 7, subs: [{pos: 4, type: 'CH3', dir: 'up'}], nombres: ["4-metilheptano"] },
            { id: 32, chain: 7, subs: [{pos: 3, type: 'CH2CH3', dir: 'up'}], nombres: ["3-etilheptano"] },
            { id: 33, chain: 7, subs: [{pos: 4, type: 'CH2CH3', dir: 'down'}], nombres: ["4-etilheptano"] },
            { id: 34, chain: 7, subs: [{pos: 4, type: 'CH2CH2CH3', dir: 'up'}], nombres: ["4-propilheptano"] },
            { id: 35, chain: 7, subs: [{pos: 4, type: 'CH(CH3)2', dir: 'down'}], nombres: ["4-isopropilheptano"] },
            { id: 36, chain: 7, subs: [{pos: 2, type: 'CH3', dir: 'up'}, {pos: 6, type: 'CH3', dir: 'down'}], nombres: ["2,6-dimetilheptano"] },
            { id: 37, chain: 7, subs: [{pos: 3, type: 'CH3', dir: 'up'}, {pos: 5, type: 'CH3', dir: 'down'}], nombres: ["3,5-dimetilheptano"] },
            { id: 38, chain: 7, subs: [{pos: 2, type: 'CH3', dir: 'up'}, {pos: 3, type: 'CH3', dir: 'down'}], nombres: ["2,3-dimetilheptano"] },
            { id: 39, chain: 7, subs: [{pos: 4, type: 'CH2CH3', dir: 'up'}, {pos: 3, type: 'CH3', dir: 'down'}], nombres: ["4-etil-3-metilheptano"] },
            { id: 40, chain: 7, subs: [{pos: 4, type: 'CH2CH3', dir: 'down'}, {pos: 2, type: 'CH3', dir: 'up'}], nombres: ["4-etil-2-metilheptano"] },
            { id: 41, chain: 7, subs: [{pos: 3, type: 'CH2CH3', dir: 'up'}, {pos: 5, type: 'CH2CH3', dir: 'down'}], nombres: ["3,5-dietilheptano"] },
            { id: 42, chain: 7, subs: [{pos: 3, type: 'CH3', dir: 'up'}, {pos: 3, type: 'CH3', dir: 'down'}], nombres: ["3,3-dimetilheptano"] },
            { id: 43, chain: 7, subs: [{pos: 4, type: 'CH(CH3)2', dir: 'up'}, {pos: 2, type: 'CH3', dir: 'down'}], nombres: ["4-isopropil-2-metilheptano"] },
            { id: 44, chain: 7, subs: [{pos: 2, type: 'CH3', dir: 'up'}, {pos: 4, type: 'CH2CH2CH3', dir: 'down'}], nombres: ["2-metil-4-propilheptano"] },
            { id: 45, chain: 4, subs: [{pos: 2, type: 'CH3', dir: 'up'}, {pos: 2, type: 'CH3', dir: 'down'}, {pos: 3, type: 'CH3', dir: 'up'}, {pos: 3, type: 'CH3', dir: 'down'}], nombres: ["2,2,3,3-tetrametilbutano"] },
            { id: 46, chain: 6, subs: [{pos: 2, type: 'CH3', dir: 'up'}, {pos: 2, type: 'CH3', dir: 'down'}, {pos: 5, type: 'CH3', dir: 'up'}, {pos: 5, type: 'CH3', dir: 'down'}], nombres: ["2,2,5,5-tetrametilhexano"] },
            { id: 47, chain: 5, subs: [{pos: 2, type: 'CH3', dir: 'up'}, {pos: 4, type: 'CH2CH3', dir: 'down'}], nombres: ["2,4-dimetilhexano"] },
            { id: 48, chain: 6, subs: [{pos: 3, type: 'CH2CH3', dir: 'up'}, {pos: 4, type: 'CH2CH3', dir: 'down'}], nombres: ["3,4-dietilhexano"] },
            { id: 49, chain: 6, subs: [{pos: 2, type: 'CH3', dir: 'up'}, {pos: 3, type: 'CH3', dir: 'down'}, {pos: 4, type: 'CH3', dir: 'up'}, {pos: 5, type: 'CH3', dir: 'down'}], nombres: ["2,3,4,5-tetrametilhexano"] },
            { id: 50, chain: 7, subs: [{pos: 2, type: 'CH3', dir: 'up'}, {pos: 3, type: 'CH3', dir: 'down'}, {pos: 4, type: 'CH3', dir: 'up'}], nombres: ["2,3,4-trimetilheptano"] }
        ];

        let quizPool = [];
        let index = 0;
        let score = 0;
        let sessionHistory = [];

        const ui = {
            home: document.getElementById('home-screen'),
            quiz: document.getElementById('quiz-screen'),
            result: document.getElementById('result-screen'),
            view: document.getElementById('visual-formula-container'),
            input: document.getElementById('answer-input'),
            msg: document.getElementById('message-box'),
            prog: document.getElementById('progress-text'),
            bar: document.getElementById('progress-bar'),
            scoreBadge: document.getElementById('score-badge'),
            stats: document.getElementById('final-stats'),
            tableBody: document.getElementById('results-table-body'),
            btn: document.getElementById('submit-btn'),
            nextBtn: document.getElementById('next-btn'),
            statsText: document.getElementById('global-stats-text')
        };

        function normalize(s) {
            return s.trim().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/\s+/g, "").replace(/-/g, "");
        }

        /**
         * L√ìGICA DE PERSISTENCIA (SIN REPETICI√ìN)
         */
        function getGlobalHistory() {
            try {
                const data = localStorage.getItem('quimica_visto_ids');
                return data ? JSON.parse(data).map(Number) : [];
            } catch(e) { return []; }
        }

        function saveToGlobalHistory(id) {
            let seen = getGlobalHistory();
            const numId = Number(id);
            if (!seen.includes(numId)) {
                seen.push(numId);
                localStorage.setItem('quimica_visto_ids', JSON.stringify(seen));
            }
        }

        function resetGlobalHistory() {
            localStorage.removeItem('quimica_visto_ids');
            updateHomeStats();
        }

        function updateHomeStats() {
            const seenCount = getGlobalHistory().length;
            ui.statsText.innerText = `Has visto ${seenCount} de 50 compuestos del mazo.`;
        }

        function goToHome() {
            ui.result.classList.add('hidden');
            ui.quiz.classList.add('hidden');
            ui.home.classList.remove('hidden');
            updateHomeStats();
        }

        /**
         * L√ìGICA DEL JUEGO
         */
        function setupQuiz(count) {
            const seen = getGlobalHistory();
            // Filtrar compuestos NO VISTOS
            let available = DB.filter(item => !seen.includes(Number(item.id)));
            
            // Si el alumno ya ha visto casi todos, reiniciamos autom√°ticamente
            if (available.length < count) {
                localStorage.removeItem('quimica_visto_ids');
                available = [...DB];
            }

            // Seleccionar aleatorios del grupo disponible
            quizPool = available.sort(() => 0.5 - Math.random()).slice(0, count);
            
            index = 0;
            score = 0;
            sessionHistory = [];
            
            ui.home.classList.add('hidden');
            ui.result.classList.add('hidden');
            ui.quiz.classList.remove('hidden');
            ui.scoreBadge.innerText = "0 Pts";
            
            loadQuestion();
        }

        function loadQuestion() {
            if (index < quizPool.length) {
                const q = quizPool[index];
                ui.view.innerHTML = drawAlkane(q.chain, q.subs);
                ui.prog.innerText = `Ejercicio ${index + 1} / ${quizPool.length}`;
                ui.bar.style.width = `${((index + 1) / quizPool.length) * 100}%`;
                
                ui.input.value = "";
                ui.input.disabled = false;
                ui.input.focus();
                ui.msg.classList.add('hidden');
                
                ui.btn.classList.remove('hidden');
                ui.btn.disabled = false;
                ui.nextBtn.classList.add('hidden');
                
                ui.input.className = ui.input.className.replace(/border-(green|red)-500|bg-(green|red)-50/, "border-slate-200 bg-slate-50");
            } else {
                showResults();
            }
        }

        function handleCheck() {
            const userVal = ui.input.value;
            const userNorm = normalize(userVal);
            if (!userNorm) return;

            const q = quizPool[index];
            const correct = q.nombres.some(n => normalize(n) === userNorm);

            // Guardar ID como visto al verificarlo
            saveToGlobalHistory(q.id);

            sessionHistory.push({
                formulaSVG: drawAlkane(q.chain, q.subs, true),
                user: userVal || "-",
                correctName: q.nombres[0],
                isCorrect: correct
            });

            ui.input.disabled = true;
            ui.btn.classList.add('hidden');
            ui.nextBtn.classList.remove('hidden');
            ui.nextBtn.focus();

            ui.msg.classList.remove('hidden', 'bg-green-50', 'text-green-700', 'border-green-200', 'bg-red-50', 'text-red-700', 'border-red-200');

            if (correct) {
                score += 10;
                ui.scoreBadge.innerText = `${score} Pts`;
                ui.msg.innerHTML = "‚ú® ¬°Correcto! Estructura dominada.";
                ui.msg.classList.add('bg-green-50', 'text-green-700', 'border-green-200');
                ui.input.classList.add('border-green-500', 'bg-green-50');
            } else {
                ui.msg.innerHTML = `‚ùå Incorrecto. Soluci√≥n:<br><span class="text-xs uppercase font-black">${q.nombres[0]}</span>`;
                ui.msg.classList.add('bg-red-50', 'text-red-700', 'border-red-200');
                ui.input.classList.add('border-red-500', 'bg-red-50');
            }
        }

        function nextQuestion() {
            index++;
            loadQuestion();
        }

        function showResults() {
            ui.quiz.classList.add('hidden');
            ui.result.classList.remove('hidden');
            ui.stats.innerText = `Puntuaci√≥n: ${score} Pts - (${score / 10} de ${quizPool.length} aciertos)`;
            
            ui.tableBody.innerHTML = '';
            sessionHistory.forEach(item => {
                const row = document.createElement('tr');
                row.className = "hover:bg-slate-50 transition-colors";
                row.innerHTML = `
                    <td class="py-4 pl-2">${item.formulaSVG}</td>
                    <td class="py-4 pr-2">
                        <span class="text-xs font-bold ${item.isCorrect ? 'text-green-600' : 'text-red-500 line-through'}">${item.user}</span>
                    </td>
                    <td class="py-4">
                        <span class="text-[10px] font-black uppercase text-indigo-700 bg-indigo-50 px-2 py-1 rounded border border-indigo-100">${item.correctName}</span>
                    </td>
                `;
                ui.tableBody.appendChild(row);
            });
        }

        ui.input.addEventListener("keypress", (e) => {
            if (e.key === "Enter") {
                if (!ui.btn.classList.contains('hidden') && !ui.btn.disabled) {
                    handleCheck();
                } else if (!ui.nextBtn.classList.contains('hidden')) {
                    nextQuestion();
                }
            }
        });

        // Al iniciar la p√°gina por primera vez
        updateHomeStats();
    </script>
</body>
</html>